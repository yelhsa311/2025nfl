<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFL Picks – Overall Standings</title>
  <style>
    :root { --gap: 14px; }
    html,body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:#0b1220; color:#e6edf3;}
    .wrap{max-width: 1100px; margin: 36px auto; padding: 0 16px;}
    h1{font-size: clamp(22px, 2.8vw, 32px); margin: 0 0 12px}
    .meta{opacity:.8; font-size: 13px; margin-bottom: 22px}
    .card{background:#0f172a; border:1px solid #1f2937; border-radius:16px; box-shadow: 0 10px 22px rgba(0,0,0,.25); padding:18px}
    .row{display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    .row .right{flex:0 0 auto}
    button{background:#1f6feb; color:white; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    button:disabled{opacity:.6; cursor:progress}
    table{width:100%; border-collapse: collapse; margin-top:10px}
    th,td{padding:10px 12px; border-bottom:1px solid #1f2937; text-align:left}
    th{font-size:12px; letter-spacing:.08em; text-transform:uppercase; opacity:.8}
    tbody tr:hover{background:#0b132a}
    .rank{font-variant-numeric: tabular-nums; width:60px}
    .num{font-variant-numeric: tabular-nums}
    .pill{background:#111827; border:1px solid #1f2937; padding: 3px 8px; border-radius:999px; font-size:12px}
    .footer{opacity:.7; font-size:12px; margin-top:14px}
    .hidden{display:none}
    .error{background:#3b1d1d;border:1px solid #6b1d1d;color:#ffdada;padding:10px 12px;border-radius:12px;margin-top:12px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Overall Standings</h1>
    <div class="meta">Option A: week docs hold totals. We read every <code>weeks</code> doc via <code>collectionGroup('weeks')</code> and sum per-user using <strong>wins</strong>/<strong>losses</strong>/<strong>points</strong> (points defaults to wins when missing).</div>

    <div class="card">
      <div class="row">
        <div>
          <div><span class="pill" id="build">BUILD: unknown</span></div>
        </div>
        <div class="right">
          <button id="refreshBtn">Recalculate Now</button>
        </div>
      </div>

      <table id="standings">
        <thead>
          <tr>
            <th class="rank">Rank</th>
            <th>Player</th>
            <th class="num">Correct</th>
            <th class="num">Points</th>
            <th class="num">Weeks</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5">Loading…</td></tr>
        </tbody>
      </table>

      <div class="footer" id="sourceHint">Source: <span id="sourceLabel">detecting…</span></div>
      <div id="err" class="error hidden"></div>
    </div>
  </div>

  <script>
    // Your real Firebase web config
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.firebasestorage.app", // if console shows appspot.com instead, swap it
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754",
      measurementId: "G-MSJHYZ4VG2"
    };
    window.BUILD_ID = `overall-${new Date().toISOString()}`;
  </script>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collectionGroup, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $tbody = document.getElementById('tbody');
    const $sourceLabel = document.getElementById('sourceLabel');
    const $refreshBtn = document.getElementById('refreshBtn');
    const $err = document.getElementById('err');

    const showError = (msg) => { $err.textContent = msg instanceof Error ? (msg.stack || msg.message) : String(msg); $err.classList.remove('hidden'); console.error(msg); };
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    const firebaseConfig = window.FIREBASE_CONFIG;
    document.getElementById('build').textContent = `BUILD: ${window.BUILD_ID}`;

    if (!firebaseConfig || !firebaseConfig.projectId) showError('❗ FIREBASE_CONFIG is missing.');

    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    try { await signInAnonymously(auth); } catch(e) { console.warn('Anonymous auth failed (continuing):', e); }

    // Case-insensitive field picker
    function pick(d, keys) {
      const map = new Map(Object.keys(d).map(k => [k.toLowerCase(), k]));
      for (const k of keys) { const real = map.get(k.toLowerCase()); if (real != null && d[real] != null) return d[real]; }
      return undefined;
    }
    const toNum = (v) => { if (v === true) return 1; if (v === false || v == null) return 0; const n = Number(String(v).replace(/[^0-9.-]/g, "")); return Number.isFinite(n) ? n : 0; };

    function render(rows){
      $tbody.innerHTML = '';
      if (!rows.length){ $tbody.innerHTML = '<tr><td colspan="5">No data</td></tr>'; return; }
      rows.forEach((r, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${i+1}</td>
          <td>${escapeHtml(r.name ?? r.userName ?? r.email ?? r.userId ?? 'Unknown')}</td>
          <td class="num">${r.correct ?? 0}</td>
          <td class="num">${r.points ?? r.correct ?? 0}</td>
          <td class="num">${r.weeks ?? '-'}</td>`;
        $tbody.appendChild(tr);
      });
    }

    async function computeFromWeekTotals(){
      $refreshBtn.disabled = true; $refreshBtn.textContent = 'Recalculating…';
      try {
        const byUser = new Map();
        const add = (uid, name, email, week, wins, losses, points) => {
          if (!byUser.has(uid)) byUser.set(uid, { userId: uid, name, email, correct: 0, points: 0, _weeks: new Set() });
          const agg = byUser.get(uid);
          if (name && !agg.name) agg.name = name;
          if (email && !agg.email) agg.email = email;
          const w  = toNum(wins);
          const l  = toNum(losses);
          const pt = toNum(points);
          agg.correct += w;           // correct = wins
          agg.points  += (pt || w);   // points default to wins if not provided
          if (week != null) agg._weeks.add(String(week));
        };

        const weeksSnap = await getDocs(collectionGroup(db, 'weeks'));
        let used = 'collectionGroup(weeks) totals';

        for (const w of weeksSnap.docs) {
          const weekId = w.id;                          // e.g. "2025-Week-01"
          const parent = w.ref.parent;                  // …/picks/{uid}/weeks
          const uid    = parent?.parent?.id || 'unknown';
          const d      = w.data() || {};

          const name   = pick(d, ['userName','name','displayName','player','owner']);
          const email  = pick(d, ['email']);
          const wins   = pick(d, ['wins','win','correct','correctcount','correctpicks','w']);
          const losses = pick(d, ['losses','loss','incorrect','incorrectcount','l']);
          const points = pick(d, ['points','pts','total','totalpoints','score']);

          add(uid, name, email, weekId, wins, losses, points);
        }

        if (!byUser.size) {
          $sourceLabel.textContent = 'No data found';
          const first = weeksSnap.docs[0]?.data?.() || {}; const keys = Object.keys(first).join(', ') || '—';
          $tbody.innerHTML = `<tr><td colspan="5">No recognizable totals (wins/points) on week docs.<br/><small>Sample keys: ${keys}</small></td></tr>`;
          return;
        }

        const results = Array.from(byUser.values());
        for (const r of results) {
          if (!r.name) {
            try { const u = await getDoc(doc(db, 'users', r.userId)); if (u.exists()) r.name = u.data().displayName ?? u.data().name ?? r.userId; } catch {}
          }
          r.weeks = r._weeks.size; delete r._weeks;
        }

        const rows = results
          .map(r => ({ ...r, points: toNum(r.points), correct: toNum(r.correct) }))
          .sort((a,b)=> (b.points - a.points) || (b.correct - a.correct) || String(a.name||a.email||a.userId).localeCompare(String(b.name||b.email||b.userId)));

        $sourceLabel.textContent = used + ' (computed)';
        render(rows);
      } catch (e) { showError(e); }
      finally { $refreshBtn.disabled = false; $refreshBtn.textContent = 'Recalculate Now'; }
    }

    (async ()=>{ await computeFromWeekTotals(); })();
    $refreshBtn.addEventListener('click', computeFromWeekTotals);
  </script>
</body>
</html>
