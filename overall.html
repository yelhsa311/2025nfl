<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFL Picks — Overall Standings</title>
  <style>
    :root { --bg:#0b1220; --fg:#e6edf3; --card:#0f172a; --line:#1f2937; --accent:#1f6feb; }
    html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{margin:0}
    .sub{opacity:.85;margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    a.button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:12px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    a.button:visited{color:#fff}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#111827;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;opacity:.9}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line)}
    th{opacity:.8;text-transform:uppercase;font-size:12px;letter-spacing:.06em;text-align:left}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    tbody tr:hover{background:#0b132a}
    .muted{opacity:.75;font-size:12px;margin-top:8px}
    .err{margin-top:12px;background:#3b1d1d;border:1px solid #6b1d1d;color:#ffdada;padding:10px;border-radius:10px;white-space:pre-wrap;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Overall Standings</h1>
      <a class="button" href="./index.html">← Back to Weeks</a>
    </header>
    <p class="sub">Totals across <b>all weeks</b>. Updates live as admins mark wins/losses.</p>

    <div id="content" class="card">
      <div class="row">
        <span id="build" class="pill"></span>
        <span id="source" class="pill"></span>
        <span id="updated" class="pill right"></span>
      </div>

      <table id="standings">
        <thead><tr><th>Rank</th><th>Player</th><th class="num">Wins</th><th class="num">Losses</th></tr></thead>
        <tbody></tbody>
      </table>

      <div id="error" class="err"></div>
      <p class="muted">Names come from the pick docs or <code>/publicUsers/{uid}</code>.</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, collectionGroup, onSnapshot,
      getDocs, getDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  
    // ---- Firebase init (use your real config or window.FIREBASE_CONFIG) ----
    const app = getApps().length ? getApps()[0] : initializeApp(window.FIREBASE_CONFIG || {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.firebasestorage.app",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754"
    });
    const auth = getAuth(app);
    const db   = getFirestore(app);
    try { await signInAnonymously(auth); } catch {}
  
    const tbody    = document.querySelector("#standings tbody");
    const $source  = document.getElementById("source");
    const $updated = document.getElementById("updated");
    const $err     = document.getElementById("error");
  
    const esc = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const lc  = s => String(s ?? "").toLowerCase().trim();
  
    // winnersByWeek: weekId -> { [gameId]: { winner, home, away } }
    const winnersByWeek = new Map();
    // userWeeks: `${uid}|${weekId}` -> { uid, weekId, picks, name }
    const userWeeks = new Map();
    const weekListeners = new Map();
  
    function setUserWeek(uid, weekId, data){
      userWeeks.set(`${uid}|${weekId}`, {
        uid, weekId,
        picks: (data?.picks && typeof data.picks === 'object') ? data.picks : {},
        name:  data?.userName || data?.name || data?.displayName
      });
    }
  
    async function attachWinnersListener(weekId){
      if (weekListeners.has(weekId)) return;
  
      const tryPath = async (factory, label) => {
        try {
          // attach even if 0; we want live updates when winners are filled in
          const unsub = onSnapshot(factory(), (snap)=>{
            const m = {};
            snap.forEach(g => {
              const d = g.data() || {};
              m[g.id] = {
                winner: lc(d.winner ?? d.result ?? ""),
                home:   lc(d.home   ?? d.homeTeam ?? ""),
                away:   lc(d.away   ?? d.awayTeam ?? "")
              };
            });
            winnersByWeek.set(weekId, m);
            // helpful console
            console.log(`[winners] ${label}(${weekId}) ->`, Object.keys(m).length, "games");
            renderNow();
          });
          return unsub;
        } catch { return null; }
      };
  
      let unsub = await tryPath(() => collection(db, "weeks", weekId, "games"), "/weeks/*/games");
      if (!unsub) unsub = await tryPath(() => collection(db, weekId, "games"), "/{weekId}/games");
      if (!unsub) unsub = await tryPath(() => collection(db, weekId, weekId, "games"), "/{weekId}/{weekId}/games");
      if (unsub) weekListeners.set(weekId, unsub);
    }
  
    function pickToSide(pickValue, game){
      const p = lc(pickValue);
      if (!p) return "";
      if (p === "home" || p === "away") return p;
      // try team-name match
      if (game) {
        if (p === game.home || game.home.includes(p)) return "home";
        if (p === game.away || game.away.includes(p)) return "away";
      }
      return "";
    }
  
    async function enrichNames(rows){
      const missing = rows.filter(r => !r.name).map(r => r.uid);
      await Promise.all(missing.map(async uid=>{
        try {
          const s = await getDoc(doc(db, "publicUsers", uid));
          if (s.exists()) rows.find(r => r.uid === uid).name = s.data().displayName || uid;
        } catch {}
      }));
    }
  
    function computeTotals(){
      const perUser = new Map(); // uid -> { uid, name, wins, losses }
      for (const { uid, weekId, picks, name } of userWeeks.values()){
        const winners = winnersByWeek.get(weekId) || {};
        const row = perUser.get(uid) || { uid, name, wins: 0, losses: 0 };
  
        for (const [gameId, pickVal] of Object.entries(picks)){
          const game = winners[gameId];                 // { winner, home, away }
          if (!game) continue;                          // no winner yet or wrong id
          const side = pickToSide(pickVal, game);       // normalize to "home"/"away"
          if (!side) continue;
          if (side === game.winner) row.wins++;
          else                      row.losses++;
        }
        perUser.set(uid, row);
      }
      return Array.from(perUser.values());
    }
  
    async function renderNow(){
      try {
        const rows = computeTotals()
          .sort((a,b)=> (b.wins - a.wins) || (a.losses - b.losses) || String(a.name||a.uid).localeCompare(String(b.name||b.uid)));
        await enrichNames(rows);
  
        tbody.innerHTML = rows.length
          ? rows.map((r,i)=>`
             <tr>
               <td>${i+1}</td>
               <td>${esc(r.name ?? r.uid)}</td>
               <td class="num">${r.wins}</td>
               <td class="num">${r.losses}</td>
             </tr>`).join("")
          : `<tr><td colspan="4">No data</td></tr>`;
  
        $updated.textContent = "Updated: " + new Date().toLocaleString();
        $source.textContent  = "Source: winners(/weeks/*/games or /{week}/games) + picks maps(/picks/*/weeks/*)";
        if ($err) $err.style.display = "none";
      } catch (e) {
        console.error(e);
        if ($err){ $err.style.display='block'; $err.textContent = e.message; }
      }
    }
  
    // Listen to all user week docs under /picks/*/weeks/*
    onSnapshot(collectionGroup(db, "weeks"), (snap)=>{
      const seenWeeks = new Set();
      snap.forEach(w=>{
        const parent = w.ref.parent?.parent;            // /picks/{uid}
        if (!parent || parent.parent?.id !== "picks") return;
        const uid = parent.id;
        const weekId = w.id;
        setUserWeek(uid, weekId, w.data());
        seenWeeks.add(weekId);
      });
      for (const wId of seenWeeks) attachWinnersListener(wId);
      renderNow();
    });
  
    window.addEventListener('beforeunload', ()=>{ for (const u of weekListeners.values()) try{u()}catch{} });
  </script>


</body>
</html>
