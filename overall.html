<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, collectionGroup, onSnapshot,
    getDoc, doc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // Use your actual config (or window.FIREBASE_CONFIG if you already set it above)
  const app = getApps().length ? getApps()[0] : initializeApp(window.FIREBASE_CONFIG || {
    apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
    authDomain: "nfl-picks-b83c2.firebaseapp.com",
    projectId: "nfl-picks-b83c2",
    storageBucket: "nfl-picks-b83c2.firebasestorage.app",
    messagingSenderId: "802058909501",
    appId: "1:802058909501:web:bb935c188891934de07754"
  });
  const auth = getAuth(app);
  const db   = getFirestore(app);
  try { await signInAnonymously(auth); } catch {}

  const tbody    = document.querySelector("#standings tbody");
  const $source  = document.getElementById("source");
  const $updated = document.getElementById("updated");
  const $err     = document.getElementById("error");
  const esc = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const toSide = v => String(v ?? "").toLowerCase().trim();     // "home" | "away"

  // Global state
  const weekIds = new Set();                 // discovered week ids (e.g. "2025-Week-01")
  const winnersByWeek = new Map();           // weekId -> { gameId: "home"|"away" }
  const picksByUserWeek = new Map();         // `${uid}|${weekId}` -> { userId, userName, picks: {gameId:"home|away"} }
  let unsubs = [];                           // to clean up listeners if needed

  function upsertUserWeek(uid, weekId, data){
    const key = `${uid}|${weekId}`;
    const current = picksByUserWeek.get(key) || { userId: uid, weekId, picks: {}, userName: undefined };
    // merge picks map (we only need the {gameId: "home"|"away"} map)
    const src = data?.picks || {};
    current.picks = src && typeof src === 'object' ? src : {};
    current.userName = data?.userName || data?.name || data?.displayName || current.userName;
    picksByUserWeek.set(key, current);
  }

  async function enrichDisplayNames(perUser){
    const missing = Object.values(perUser).filter(r => !r.name).map(r => r.userId);
    await Promise.all(missing.map(async uid=>{
      try {
        const s = await getDoc(doc(db, "publicUsers", uid));
        if (s.exists()) perUser[uid].name = s.data().displayName || uid;
      } catch {}
    }));
  }

  function computeTotals(){
    // Aggregate across all weeks using winnersByWeek + picksByUserWeek
    const perUser = {};
    for (const { userId, weekId, picks, userName } of picksByUserWeek.values()){
      const weekWinners = winnersByWeek.get(weekId) || {};
      if (!perUser[userId]) perUser[userId] = { userId, name: userName, wins: 0, losses: 0 };

      for (const [gameId, pickVal] of Object.entries(picks || {})){
        const pick = toSide(pickVal);
        const winr = toSide(weekWinners[gameId]);
        if (!pick || !winr) continue;
        if (pick === winr) perUser[userId].wins++;
        else               perUser[userId].losses++;
      }
    }
    return perUser;
  }

  async function renderNow(){
    try {
      const perUser = computeTotals();
      await enrichDisplayNames(perUser);

      const rows = Object.values(perUser)
        .sort((a,b)=> (b.wins - a.wins) || (a.losses - b.losses) || String(a.name||a.userId).localeCompare(String(b.name||b.userId)));

      tbody.innerHTML = rows.length
        ? rows.map((r,i)=>`
          <tr>
            <td>${i+1}</td>
            <td>${esc(r.name ?? r.userId)}</td>
            <td class="num">${r.wins}</td>
            <td class="num">${r.losses}</td>
          </tr>`).join("")
        : `<tr><td colspan="4">No data</td></tr>`;

      $updated.textContent = "Updated: " + new Date().toLocaleString();
      $source.textContent  = "Source: winners(/weeks/*/games) + picks maps(/picks/*/weeks/*) (live)";
      if ($err) $err.style.display = "none";
    } catch(e){
      console.error(e);
      if ($err){ $err.style.display='block'; $err.textContent = e.message; }
    }
  }

  // 1) Listen to the root /weeks collection to discover weekIds, and for each, listen to /games
  unsubs.push(
    onSnapshot(collection(db, "weeks"), (weeksSnap)=>{
      weeksSnap.forEach(weekDoc=>{
        const wId = weekDoc.id;
        if (weekIds.has(wId)) return;
        weekIds.add(wId);

        // winners for this week
        unsubs.push(onSnapshot(collection(db, "weeks", wId, "games"), (gamesSnap)=>{
          const winners = {};
          gamesSnap.forEach(g=>{
            const d = g.data() || {};
            winners[g.id] = toSide(d.winner ?? d.result ?? d.w ?? d.W ?? "");
          });
          winnersByWeek.set(wId, winners);
          renderNow();
        }));
      });
    })
  );

  // 2) Listen to all week docs under /picks/*/weeks/* (we only need id + picks map)
  //    We filter in code to week docs (id === some week in weekIds) and read the 'picks' map.
  unsubs.push(
    onSnapshot(collectionGroup(db, "weeks"), (snap)=>{
      snap.forEach(w=>{
        const weekId = w.id;
        // Only consider user-week docs under /picks/{uid}/weeks/{weekId}
        const maybeUser = w.ref.parent?.parent; // /picks/{uid}
        if (!maybeUser || maybeUser.parent?.id !== "picks") return;
        const uid = maybeUser.id;
        upsertUserWeek(uid, weekId, w.data());
      });
      renderNow();
    })
  );

  window.addEventListener('beforeunload', ()=>{ try{ unsubs.forEach(u=>u&&u()); }catch{} });
</script>
