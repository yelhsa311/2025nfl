<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NFL Picks ‚Ä¢ User (v14.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1220; --card:#171a2b; --muted:#8fa0ff; --text:#e9ecff; --accent:#4c73ff; --danger:#ff6b6b; --ok:#31c48d; --border:#2a2f47 }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#0e1120;position:sticky;top:0;z-index:3}
    h1{margin:0;font-size:18px;letter-spacing:.4px}
    .muted{color:#aeb6ff9c}
    .badge{font-size:12px;padding:3px 7px;border:1px solid var(--border);border-radius:8px;background:#0e1330}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:360px 1fr}
    @media (max-width:1000px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card h2{margin:0 0 8px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .stack{display:grid;gap:10px}
    .grid{display:grid;gap:8px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    input,select,button{background:#0e1226;color:#e9ecff;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:#4c73ff;border-color:#2b4bd8}
    button.ghost{background:transparent}
    .hint{font-size:12px;color:#aeb6ff9c}
    .sep{height:1px;background:var(--border);margin:8px 0}
    table{width:100%;border-collapse:collapse;background:#0e1226;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{background:#0b0f1f;color:#b7c0ff}
    tbody tr:hover{background:#0f1430}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0d1130;color:#c7d0ff}
    .version{background:#0d1a36;border-color:#2d3a55;color:#9cc7ff;padding:5px 10px;font-size:12px}
    .winner{font-size:12px;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:#101542;color:#c7d0ff;margin-left:8px}
    .status-ok{color:var(--ok)}
    .status-bad{color:var(--danger)}
    .pick-cell{display:grid;gap:6px}
    .pick-result{display:inline-flex;align-items:center;gap:6px;padding:5px 8px;border-radius:9px;border:1px solid var(--border);font-size:12px;background:#0f1329;color:#c7d0ff}
    .pick-result .emoji{font-size:14px}
    .pick-win select{border-color:#1f9b73;box-shadow:0 0 0 1px #1f9b73;background:#10241c}
    .pick-loss select{border-color:#a23c3c;box-shadow:0 0 0 1px #a23c3c;background:#241012}
    .pick-win .pick-result{border-color:#1f9b73;background:#0f241c;color:#9af7c8}
    .pick-loss .pick-result{border-color:#a23c3c;background:#241012;color:#ffc0c0}
  </style>
</head>
<body>
  <header>
    <div class="row" style="align-items:center; gap:10px">
      <h1>üèà NFL Picks <span class="muted">¬∑ User</span></h1>
      <span class="pill version">v14.1</span>
    </div>
    <div id="authArea" class="row">
      <span id="who" class="badge">signed out</span>
      <button class="ghost" type="button" onclick="window.location.href='admin-grid.html'">Admin grid</button>
      <button id="btnSignOut" class="ghost" style="display:none" type="button">Sign out</button>
    </div>
  </header>

  <main>
    <section class="card stack">
      <h2>Your Account</h2>
      <form id="authForm" class="stack">
        <input id="inEmail" type="email" placeholder="email@example.com" />
        <input id="inPass" type="password" placeholder="password" />
        <div class="row">
          <button id="btnSignIn"  class="primary" type="submit">Sign in</button>
          <button id="btnCreate"  class="ghost"   type="button">Create account</button>
          <button id="btnReset"   class="ghost"   type="button">Forgot password</button>
        </div>
        <div id="authMsg" class="hint"></div>
      </form>

      <div class="sep"></div>

      <h2>Week</h2>
      <div class="grid cols-2">
        <select id="selWeek"></select>
        <input id="inSeason" placeholder="Season (e.g. 2025)" />
      </div>
      <div class="row">
        <button id="btnReload" class="ghost" type="button">Reload</button>
        <span class="hint">Choose your pick from the dropdown. Picks lock at kickoff.</span>
      </div>
    </section>

    <section class="card stack">
      <div class="row" style="align-items:center;justify-content:space-between">
        <h2 style="margin:0">Make Your Picks</h2>
        <div id="weekSummary" class="hint"></div>
      </div>
      <table id="tblGames">
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th>Matchup</th>
            <th style="width:200px">Kickoff</th>
            <th style="width:180px">Your Pick</th>
            <th style="width:160px">Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, sendPasswordResetEmail, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---- Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDC2DnD4I4nekKWnCkDD9dTwQZN4tj3g0w",
      authDomain: "nflpicks2025-51202.firebaseapp.com",
      projectId: "nflpicks2025-51202",
      storageBucket: "nflpicks2025-51202.appspot.com",
      messagingSenderId: "125791202188",
      appId: "1:125791202188:web:903f4c74dc84a5b69604a9",
      measurementId: "G-289KXJQZGG"
    };

    // ---- Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Ensure sign-in works even in private/incognito modes by preferring local persistence
    await setPersistence(auth, browserLocalPersistence).catch((e)=>{
      console.warn('persistence error', e);
      setAuthMessage(`${e.code || 'error'}: ${e.message || e}`);
    });

    // ---- DOM
    const who = document.getElementById('who');
    const btnSignOut = document.getElementById('btnSignOut');
    const authForm = document.getElementById('authForm');
    const inEmail = document.getElementById('inEmail');
    const inPass  = document.getElementById('inPass');
    const btnReload = document.getElementById('btnReload');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnCreate = document.getElementById('btnCreate');
    const btnReset = document.getElementById('btnReset');
    const authMsg = document.getElementById('authMsg');
    const selWeek = document.getElementById('selWeek');
    const inSeason = document.getElementById('inSeason');
    const tblGamesBody = document.querySelector('#tblGames tbody');
    const weekSummary = document.getElementById('weekSummary');

    // ---- Helpers
    const ts = () => serverTimestamp();
    function clearTable(tbody){ while (tbody.firstChild) tbody.removeChild(tbody.firstChild); }
    function fmtPct(c,t){ return t ? (Math.round((c/t)*1000)/10).toFixed(1)+'%' : '‚Äî'; }
    function kickoffMs(g){
      if (!g) return null;
      if (typeof g.kickoffTs === 'number' && Number.isFinite(g.kickoffTs)) return g.kickoffTs;
      if (g.kickoff?.toDate) return g.kickoff.toDate().getTime();
      const parsed = g.kickoff ? Date.parse(g.kickoff) : NaN;
      if (Number.isFinite(parsed)) return parsed;
      if (typeof g.createdAt === 'number' && Number.isFinite(g.createdAt)) return g.createdAt;
      if (g.createdAt?.toDate) return g.createdAt.toDate().getTime();
      return null;
    }

    // Collections
    const weekId = () => {
      const season = (inSeason.value || '').trim();
      const week = String(selWeek.value || '').padStart(2, '0');
      return season && week ? `${season}-Week-${week}` : '';
    };
    const colGames = (id) => collection(db, 'weeks', id, 'games');

    function setAuthMessage(text){ authMsg.textContent = text || ''; }

    async function doSignIn(evt){
      evt?.preventDefault();
      setAuthMessage('Signing in‚Ä¶');
      btnSignIn.disabled = btnCreate.disabled = btnReset.disabled = true;
      try {
        await signInWithEmailAndPassword(auth, inEmail.value.trim(), inPass.value);
        setAuthMessage('Signed in.');
      } catch (e) {
        console.error(e);
        setAuthMessage(`${e.code || 'error'}: ${e.message || e}`);
      } finally {
        btnSignIn.disabled = btnCreate.disabled = btnReset.disabled = false;
      }
    }

    async function doCreate(evt){
      evt?.preventDefault();
      const email = inEmail.value.trim();
      setAuthMessage('Creating account‚Ä¶');
      btnSignIn.disabled = btnCreate.disabled = btnReset.disabled = true;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, inPass.value);
        await setDoc(doc(db,'users',cred.user.uid), {
          displayName: email.split('@')[0],
          createdAt: serverTimestamp()
        }, { merge:true });
        setAuthMessage('Account created.');
      } catch (e) {
        console.error(e);
        if (e.code === 'auth/email-already-in-use') {
          setAuthMessage('Account already exists ‚Äî signing you in‚Ä¶');
          try {
            await signInWithEmailAndPassword(auth, email, inPass.value);
            setAuthMessage('Signed in.');
          } catch (e2) {
            console.error(e2);
            setAuthMessage(`${e2.code || 'error'}: ${e2.message || e2}`);
          }
        } else {
          setAuthMessage(`${e.code || 'error'}: ${e.message || e}`);
        }
      } finally {
        btnSignIn.disabled = btnCreate.disabled = btnReset.disabled = false;
      }
    }

    async function doReset(evt){
      evt?.preventDefault();
      const email = inEmail.value.trim();
      if (!email){
        setAuthMessage('Enter your email to get a reset link.');
        inEmail.focus();
        return;
      }
      setAuthMessage('Sending reset email‚Ä¶');
      btnSignIn.disabled = btnCreate.disabled = btnReset.disabled = true;
      try {
        await sendPasswordResetEmail(auth, email);
        setAuthMessage('Reset email sent. Check your inbox for a link to set a new password.');
      } catch (e) {
        console.error(e);
        setAuthMessage(`${e.code || 'error'}: ${e.message || e}`);
      } finally {
        btnSignIn.disabled = btnCreate.disabled = btnReset.disabled = false;
      }
    }

    // Wire up buttons and expose globals so inline handlers continue to work
    authForm.addEventListener('submit', doSignIn);
    btnCreate.addEventListener('click', doCreate);
    btnReset.addEventListener('click', doReset);
    window._signin = doSignIn;
    window._create = doCreate;
    window._reset = doReset;

    // ---- Auth state
    let unsubGames = null;
    let currentUser = null;
    let myPicks = new Map(); // gameId -> pick

    onAuthStateChanged(auth, async (u)=>{
      currentUser = u || null;
      if (u){
        who.textContent = u.email || u.uid;
        authForm.style.display='none';
        btnSignOut.style.display='inline-block';
        // ensure /users doc exists (optional nicety)
        await setDoc(doc(db,'users',u.uid), { displayName: (u.email||'').split('@')[0], updatedAt: ts() }, { merge:true });
        attachGameListener();
      } else {
        who.textContent = 'signed out';
        authForm.style.display='grid';
        btnSignOut.style.display='none';
        detachGameListener();
        clearTable(tblGamesBody);
        weekSummary.textContent = '';
      }
    });

    btnSignOut.onclick = ()=> signOut(auth);
    btnReload.onclick  = ()=> attachGameListener();

    // week options
    for (let w=1; w<=18; w++){
      const v=String(w).padStart(2,'0');
      const opt=document.createElement('option'); opt.value=v; opt.textContent='Week '+w; selWeek.appendChild(opt);
    }
    inSeason.value = new Date().getFullYear();
    selWeek.value = '01';
    selWeek.onchange = ()=> attachGameListener();
    inSeason.onchange = ()=> attachGameListener();

    function detachGameListener(){ if (unsubGames) {unsubGames(); unsubGames=null;} }

    async function attachGameListener(){
      if (!currentUser) return;
      const currentWeekId = weekId();
      if (!currentWeekId) return;

      detachGameListener();

      // Load user's existing picks for this week
      myPicks = new Map();
      try {
        const pickSnap = await getDoc(doc(db, 'picks', currentUser.uid, 'weeks', currentWeekId));
        const picks = pickSnap.exists() ? (pickSnap.data().picks || {}) : {};
        Object.entries(picks).forEach(([gid, pick]) => myPicks.set(gid, pick));
      } catch (e) {
        console.error('Error loading picks', e);
      }

      const gamesRef = colGames(currentWeekId);
      const handleSnap = (snap)=>{
        const games = snap.docs.map(d=>({ id:d.id, ...d.data() }))
          .sort((a,b)=>{
            const ka = kickoffMs(a);
            const kb = kickoffMs(b);
            if (ka === kb) return 0;
            if (ka === null) return 1;
            if (kb === null) return -1;
            return ka - kb;
          });
        renderGames(games);
      };
      const fallbackSubscribe = ()=> onSnapshot(gamesRef, handleSnap);
      unsubGames = onSnapshot(query(gamesRef, orderBy('kickoffTs', 'asc')), handleSnap, (err)=>{
        console.warn('kickoffTs ordering failed ‚Äî using unsorted listener', err);
        unsubGames();
        unsubGames = fallbackSubscribe();
      });
    }

    async function savePick(gameId, label){
      const currentWeekId = weekId();
      if (!currentWeekId) return;

      await setDoc(doc(db, 'picks', currentUser.uid, 'weeks', currentWeekId), {
        email: currentUser.email || '',
        weekId: currentWeekId,
        [`picks.${gameId}`]: label,
        updatedAt: ts(),
        createdAt: ts()
      }, { merge:true });

      myPicks.set(gameId, label); // optimistic update
    }

    function renderGames(games){
      clearTable(tblGamesBody);
      let correct=0, total=0;

      games.forEach((g, i)=>{
        const tr=document.createElement('tr');

        // #
        const tdIdx=document.createElement('td'); tdIdx.textContent=String(i+1); tr.appendChild(tdIdx);

        // Matchup
        const tdMatch=document.createElement('td');
        tdMatch.innerHTML = `<span class="pill">${g.away}</span> @ <span class="pill">${g.home}</span>` + (g.winner ? `<span class="winner">Winner: ${g.winner}</span>` : '');
        tr.appendChild(tdMatch);

        // Kickoff
        const tdKick=document.createElement('td');
        const koMs = kickoffMs(g);
        const koDate = Number.isFinite(koMs) ? new Date(koMs) : null;
        tdKick.textContent = koDate ? koDate.toLocaleString() : '‚Äî';
        tr.appendChild(tdKick);

        // --- Your Pick (dropdown, Home/Away only ‚Äî no TIE) ---
        const tdPick=document.createElement('td');
        tdPick.className = 'pick-cell';
        const select=document.createElement('select');
        ['', g.home, g.away].forEach(v=>{
          const o=document.createElement('option');
          o.value=v;
          o.textContent=v||'‚Äî select ‚Äî';
          select.appendChild(o);
        });
        const mine = myPicks.get(g.id) || '';
        select.value = mine || '';
        const locked = koDate ? koDate.getTime() <= Date.now() : false;
        select.disabled = locked;
        select.title = locked ? 'Locked at kickoff' : '';
        select.onchange = async ()=>{
          const label = select.value;
          if (!label) return; // ignore placeholder
          await savePick(g.id, label);
        };
        tdPick.appendChild(select);

        const resultTag=document.createElement('div');
        resultTag.className='pick-result';
        resultTag.style.display='none';
        tdPick.appendChild(resultTag);
        tr.appendChild(tdPick);

        // Status
        const tdStatus=document.createElement('td');
        if (g.winner) {
          total++;
          select.disabled = true;
          resultTag.style.display='inline-flex';
          if (mine){
            if (mine === g.winner) {
              tdStatus.textContent = 'Correct';
              tdStatus.className = 'status-ok';
              correct++;
              tdPick.classList.add('pick-win');
              resultTag.innerHTML = `<span class="emoji">üèÜ</span><span>You picked ${mine} ¬∑ Winner: ${g.winner}</span>`;
            } else {
              tdStatus.textContent = 'Wrong';
              tdStatus.className = 'status-bad';
              tdPick.classList.add('pick-loss');
              resultTag.innerHTML = `<span class="emoji">‚öîÔ∏è</span><span>You picked ${mine} ¬∑ Winner: ${g.winner}</span>`;
            }
          } else {
            tdStatus.textContent = 'No pick';
            resultTag.innerHTML = `<span class="emoji">üèÜ</span><span>Winner: ${g.winner}</span>`;
          }
        } else {
          tdStatus.textContent = mine ? `Your pick: ${mine}` : 'Your pick: ‚Äî';
          if (select.disabled) tdStatus.textContent += ' (locked)';
        }
        tr.appendChild(tdStatus);

        tblGamesBody.appendChild(tr);
      });

      weekSummary.textContent = total ? `This week: ${correct}/${total} (${fmtPct(correct,total)})` : '';
    }
  </script>
</body>
</html>
