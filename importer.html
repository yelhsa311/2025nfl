<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NFL Picks — Week Importer</title>
<style>
  :root{--bg:#0f1115;--fg:#e7e7e7;--muted:#9aa0a6;--card:#171a21;--border:#252a33;--accent:#6ea8ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  a{color:#9ea4ff;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{margin:.2rem 0 1rem}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px}
  input,button{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:10px;border-radius:10px}
  button.primary{outline:2px solid var(--accent)}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .muted{color:var(--muted)}
  pre{white-space:pre-wrap;background:#0b0d11;border:1px solid var(--border);padding:10px;border-radius:8px;max-height:260px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h1>Week Importer</h1>
    <a class="pill" href="index.html">← Back to App</a>
  </div>

  <!-- LOGIN -->
  <div id="auth" class="card">
    <div class="row">
      <input id="email" type="email" placeholder="Email">
      <input id="pass" type="password" placeholder="Password">
      <button id="signInBtn" class="primary">Sign in</button>
    </div>
    <div class="muted">Admins only. Upload a CSV with:
      <code>weekId,day,kickoff,home,away,winner,&lt;user1@email&gt;,...</code>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="card" style="display:none">
    <div class="row">
      <span id="userTag" class="pill"></span>
      <span id="adminTag" class="pill" style="display:none">ADMIN</span>
    </div>

    <div class="card">
      <div class="row">
        <input id="file" type="file" accept=".csv">
        <button id="previewBtn">Preview</button>
        <button id="importBtn" class="primary">Import</button>
        <button id="permBtn">Test Permissions</button>
      </div>
      <div class="muted">Time format: <code>YYYY-MM-DDTHH:mm</code> or <code>YYYY-MM-DD HH:mm</code></div>
    </div>

    <div class="card"><strong>Preview</strong><pre id="preview">No file yet.</pre></div>
    <div class="card"><strong>Log</strong><pre id="log"></pre></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, setDoc, writeBatch, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
  authDomain: "nfl-picks-b83c2.firebaseapp.com",
  projectId: "nfl-picks-b83c2",
  storageBucket: "nfl-picks-b83c2.appspot.com",
  messagingSenderId: "802058909501",
  appId: "1:802058909501:web:bb935c188891934de07754"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"];

const el = s => document.querySelector(s);
const log = (...a) => el("#log").textContent += a.join(" ") + "\n";

// --- sanitize helper ---
const clean = s => (s ?? "").trim().replace(/^[\uFEFF\u200B\u00A0]+|[\uFEFF\u200B\u00A0]+$/g, "").replace(/^"+|"+$/g,"");

// --- CSV parser ---
function parseCSV(text) {
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  text = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
  const lines = [];
  let inQ = false, cur = "", row = [];
  for (let i=0;i<text.length;i++){
    const c = text[i];
    if (c === '"'){ if (inQ && text[i+1]==='"'){cur+='"';i++;} else inQ=!inQ; continue; }
    if (!inQ && c === ","){ row.push(cur); cur=""; continue; }
    if (!inQ && c === "\n"){ row.push(cur); lines.push(row); row=[]; cur=""; continue; }
    cur += c;
  }
  if (cur.length || row.length){ row.push(cur); lines.push(row); }
  return lines.filter(r => r.some(x => (x ?? "").trim()!==""));
}

// --- auth ---
onAuthStateChanged(auth, (user)=>{
  if(!user){ el("#auth").style.display=""; el("#app").style.display="none"; return; }
  const isAdmin = ADMIN_UIDS.includes(user.uid);
  el("#userTag").textContent = user.email;
  el("#adminTag").style.display = isAdmin ? "" : "none";
  el("#auth").style.display="none"; el("#app").style.display="";
  if(!isAdmin){ alert("Admins only."); signOut(auth); }
});
el("#signInBtn").onclick = async ()=>{ try{ await signInWithEmailAndPassword(auth, el("#email").value, el("#pass").value); }catch(e){alert(e.message);} };

el("#permBtn").onclick = async ()=>{
  try{
    await setDoc(doc(db,"weeks","TEST-WEEK","games","probe"),{ok:true,at:Date.now()},{merge:true});
    log("✅ Permissions OK");
  }catch(e){ log("❌ Perm FAIL:", e.message); alert(e.message); }
};

// --- preview ---
el("#previewBtn").onclick = async ()=>{
  const f = el("#file").files?.[0];
  if(!f) return alert("Choose a CSV");
  const t = await f.text();
  const rows = parseCSV(t);
  el("#preview").textContent = "First line:\n"+t.slice(0,200)+"\nLines:"+rows.length;
};

// --- import ---
el("#importBtn").onclick = async ()=>{
  try{
    const f = el("#file").files?.[0];
    if(!f) return alert("Choose a CSV");
    const text = await f.text();
    const rows = parseCSV(text);
    const rawHeaders = rows[0].map(clean);
    const headers = rawHeaders.map(h=>h.toLowerCase());
    const fixed = ["weekid","day","kickoff","home","away","winner"];
    for(let i=0;i<fixed.length;i++){
      if(headers[i]!==fixed[i]) throw new Error(`Header ${i+1} mismatch: expected ${fixed[i]} got "${rawHeaders[i]}"`);
    }
    const userCols = rawHeaders.slice(6).map(clean).filter(Boolean);
    log("Users:",userCols.join(","));
    const batch = writeBatch(db);
    const perUser = new Map();
    let gameCount=0;
    for(let r=1;r<rows.length;r++){
      const row = rows[r];
      const [weekId,day,kickoff,home,away,winner] = row.slice(0,6).map(clean);
      if(!weekId||!home||!away) continue;
      const ts = Date.parse(kickoff.replace(" ","T"));
      const gameId = `${home.replaceAll(" ","_")}_vs_${away.replaceAll(" ","_")}`;
      const gRef = doc(db,"weeks",weekId,"games",gameId);
      batch.set(gRef,{day,home,away,createdAt:Date.now(),kickoffTs:ts||Date.now(),...(winner?{winner}:{})},{merge:true});
      for(let u=0;u<userCols.length;u++){
        const email=userCols[u]; const side=clean(row[6+u]||"").toLowerCase();
        if(side!=="home"&&side!=="away") continue;
        if(!perUser.has(email)) perUser.set(email,{weeks:new Map()});
        if(!perUser.get(email).weeks.has(weekId)) perUser.get(email).weeks.set(weekId,{picks:{}});
        perUser.get(email).weeks.get(weekId).picks[gameId]=side;
      }
      gameCount++;
    }
    await batch.commit(); log("Games committed:",gameCount);

    // write picks
    let pickDocs=0;
    for(const [email,obj] of perUser){
      for(const [weekId,data] of obj.weeks){
        await setDoc(doc(db,"picks",email.toLowerCase(),"weeks",weekId),
          {email,weekId,picks:data.picks,updatedAt:Date.now()},{merge:true});
        pickDocs++;
      }
    }
    log(`✅ Done. Games:${gameCount} | Pick docs:${pickDocs}`);
    alert("Import complete!");
  }catch(e){ log("❌ ERROR:",e.message); alert(e.message); }
};
</script>
</body>
</html>
