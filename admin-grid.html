<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Grid — Family NFL Picks</title>
  <style>
    :root{
      --bg:#0e1116;
      --panel:#141922;
      --panel-2:#1b2230;
      --text:#ebf0f7;
      --muted:#96a0b5;
      --accent:#5aa6ff;
      --danger:#ef4444;
      --ok:#22c55e;
      --chip:#0f1729;
      --input:#0f1420;
      --border:#232b3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    a{color:var(--accent);text-decoration:none}
    header{
      display:flex; align-items:center; gap:12px;
      padding:16px 20px; background:var(--panel);
      position:sticky; top:0; z-index:20; border-bottom:1px solid var(--border);
    }
    header .crumb{opacity:.8}
    header .spacer{flex:1}
    header .role{border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--muted); font-size:12px}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--panel); padding:12px; border:1px solid var(--border); border-radius:12px;
    }
    .toolbar .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted)}
    input, select{
      background:var(--input); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px;
    }
    input[type="datetime-local"]{padding-right:2px}
    button{
      background:#1a2434; color:#e8f0ff; border:1px solid var(--border);
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    button.primary{background:var(--accent); color:#08101e; border-color:#3b82f6}
    button.btn-danger{background:var(--danger); color:white; border-color:#ef4444}
    button:disabled{opacity:.5; cursor:not-allowed}
    .divider{width:2px; height:26px; background:var(--border); margin:0 6px; border-radius:2px}
    .chip{
      display:inline-flex; flex-wrap:wrap; gap:8px; align-items:center;
      padding:10px; background:var(--panel); border:1px solid var(--border); border-radius:12px; margin-top:10px;
    }
    .table{
      margin-top:14px; border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:var(--panel);
    }
    .thead, .trow{
      display:grid; grid-template-columns: 110px 200px 1fr 1fr 120px 150px 90px;
      align-items:center; gap:8px; border-bottom:1px solid var(--border);
      padding:10px;
    }
    .thead{background:var(--panel-2); color:var(--muted); font-weight:600}
    .trow:nth-child(2n){background:rgba(255,255,255,0.02)}
    .trow input, .trow select{width:100%}
    .right{display:flex; gap:8px; justify-content:flex-end}
    .status{color:var(--muted); margin-top:8px; font-size:13px}
    .note{color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <header>
    <a class="crumb" href="/index.html">← Back to App</a>
    <div style="font-weight:700; letter-spacing:.3px">Admin Grid</div>
    <div class="spacer"></div>
    <div id="userTag" class="role">…</div>
    <div id="roleTag" class="role">ADMIN</div>
  </header>

  <div class="wrap">
    <!-- TOOLBAR: Week + Admin actions + User Picks Logger -->
    <div class="toolbar" id="toolbar">
      <div class="group">
        <label>Season
          <input id="seasonInput" type="number" min="2000" max="2100" value="2025" style="width:96px">
        </label>
        <label>Week
          <select id="weekSelect"></select>
        </label>
        <button id="refreshBtn">Refresh</button>
        <button id="saveChangesBtn" class="primary">Save Game Changes</button>
      </div>

      <span class="divider"></span>

      <div class="group">
        <label>Day
          <select id="dayInput">
            <option>Thursday</option>
            <option>Friday</option>
            <option selected>Sunday</option>
            <option>Monday</option>
            <option>Saturday</option>
          </select>
        </label>
        <label>Home
          <input id="homeInput" placeholder="e.g. Philadelphia Eagles" style="min-width:210px">
        </label>
        <label>Away
          <input id="awayInput" placeholder="e.g. Dallas Cowboys" style="min-width:210px">
        </label>
        <label>Kickoff (local)
          <input id="kickoffInput" type="datetime-local">
        </label>
        <button id="addGameBtn">+ Add game</button>
      </div>

      <span class="divider"></span>

      <div class="group">
        <label>User email
          <input id="userEmail" style="min-width:260px" placeholder="email@example.com">
        </label>
        <button id="loadUserBtn">Load</button>
        <button id="saveUserBtn" class="primary">Save Picks</button>
      </div>
    </div>

    <!-- User quick tools -->
    <div class="chip" id="userQuickTools">
      <strong>User Picks:</strong>
      <button id="fillBlanksHomeBtn">Blanks → home</button>
      <button id="fillBlanksAwayBtn">Blanks → away</button>
      <button id="allHomeBtn">All → home</button>
      <button id="allAwayBtn">All → away</button>
      <button id="clearUserBtn" class="btn-danger">Clear</button>
      <span class="note">Tip: Load a user first to enable these.</span>
    </div>

    <!-- Table -->
    <div class="table">
      <div class="thead">
        <div>Day</div>
        <div>Kickoff</div>
        <div>Home</div>
        <div>Away</div>
        <div>Winner</div>
        <div id="pickHeader">Pick (no user loaded)</div>
        <div class="right">Actions</div>
      </div>
      <div id="rows"></div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <!-- Firebase + App Logic -->
  <script type="module">
    // --- Firebase (modular) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import { 
      getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc,
      query, where, orderBy, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.appspot.com",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754",
      measurementId: "G-MSJHYZ4VG2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- Small DOM utils ---
    const $ = sel => document.querySelector(sel);
    const el = (html) => {
      const t=document.createElement('template'); t.innerHTML=html.trim(); 
      return t.content.firstElementChild;
    };
    const byId = (id)=>document.getElementById(id);
    const fmt2 = (n)=> String(n).padStart(2,'0');

    // --- Admin allow-list (simple: emails) ---
    const ADMIN_EMAILS = ["yelhsa311@gmail.com"]; // add others as needed

    // --- App State ---
    const state = {
      season: 2025,
      weekNum: 1,
      weekId: "2025-Week-01",
      games: [],             // array of {id, day, kickoff ISO string, home, away, winner}
      currentUser: "",       // email
      picksByUser: new Map() // email -> { [gameId]: 'home'|'away' }
    };

    function computeWeekId(season, weekNum){
      return `${season}-Week-${fmt2(weekNum)}`;
    }

    // Populate week dropdown
    for(let w=1; w<=22; w++){ // include preseason/playoffs if desired
      const opt = document.createElement('option');
      opt.value = String(w);
      opt.textContent = `Week ${w}`;
      byId('weekSelect').appendChild(opt);
    }
    byId('weekSelect').value = String(state.weekNum);

    // --- Auth gate & header ---
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.replace('/index.html');
        return;
      }
      // Header shows email only (no UID)
      byId('userTag').textContent = user.email || "";
      const isAdmin = ADMIN_EMAILS.includes((user.email||"").toLowerCase());
      if(!isAdmin){
        alert(
          "Admins only.\\n\\nAdd this email to ADMIN_EMAILS (or grant an admin role):\\n" +
          `Email: ${user.email}`
        );
        await signOut(auth);
        location.replace('/index.html');
        return;
      }
      initUI();
      await loadWeek();
    });

    // --- UI wiring ---
    function initUI(){
      byId('seasonInput').addEventListener('change', (e)=>{
        state.season = Number(e.target.value||2025);
        state.weekId = computeWeekId(state.season, state.weekNum);
        loadWeek();
      });

      byId('weekSelect').addEventListener('change', (e)=>{
        state.weekNum = Number(e.target.value||1);
        state.weekId  = computeWeekId(state.season, state.weekNum);
        loadWeek();
      });

      byId('refreshBtn').addEventListener('click', ()=> loadWeek());
      byId('saveChangesBtn').addEventListener('click', ()=> saveGameChanges());

      byId('addGameBtn').addEventListener('click', addGameFromInputs);

      // User Picks Logger
      byId('loadUserBtn').addEventListener('click', async ()=>{
        const email = (byId('userEmail').value||"").trim().toLowerCase();
        if(!email) { return alert("Enter a user email first."); }
        state.currentUser = email;
        byId('pickHeader').textContent = `Pick (${email})`;
        await loadWeek(); // reload picks for this user
        setStatus(`Loaded user: ${email}`);
      });
      byId('saveUserBtn').addEventListener('click', saveSelectedUser);

      // Quick Tools
      byId('fillBlanksHomeBtn').addEventListener('click', ()=> fillUserPicks("home", true));
      byId('fillBlanksAwayBtn').addEventListener('click', ()=> fillUserPicks("away", true));
      byId('allHomeBtn').addEventListener('click', ()=> fillUserPicks("home", false));
      byId('allAwayBtn').addEventListener('click', ()=> fillUserPicks("away", false));
      byId('clearUserBtn').addEventListener('click', clearUserPicks);
    }

    // --- Helpers ---
    const uidFromEmail = (email) => (email||"").toLowerCase()
      .replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,64);

    function setStatus(msg){ byId('status').textContent = msg || ""; }

    function toLocalDatetimeValue(iso){
      if(!iso) return "";
      const d = new Date(iso);
      const yyyy = d.getFullYear();
      const mm = fmt2(d.getMonth()+1);
      const dd = fmt2(d.getDate());
      const hh = fmt2(d.getHours());
      const mi = fmt2(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    
    async function loadWeek(){
      setStatus("Loading…");
    
      // 1) Fetch without orderBy (no index required)
      const q = query(collection(db, "games"), where("weekId", "==", state.weekId));
      const snap = await getDocs(q);
    
      // 2) Build array and sort locally by kickoff ISO
      state.games = [];
      snap.forEach(d => {
        const data = d.data();
        state.games.push({
          id: d.id,
          day: data.day || "",
          kickoff: data.kickoff || "",   // ISO string from importer
          home: data.home || "",
          away: data.away || "",
          winner: data.winner || ""
        });
      });

  // Sort by kickoff ascending (handles ISO or empty)
  state.games.sort((a,b) => new Date(a.kickoff) - new Date(b.kickoff));

  console.log("[AdminGrid] weekId:", state.weekId, "docs:", state.games.length);
  renderGrid();
  setStatus(`Adds to ${state.weekId} • ${state.games.length} game(s)`);
}


      // Load picks for active user (single-column mode)
      state.picksByUser.clear();
      if(state.currentUser){
        const uid = uidFromEmail(state.currentUser);
        const pRef = doc(db, "picks", uid, "weeks", state.weekId);
        const psnap = await getDoc(pRef);
        const picks = psnap.exists() ? (psnap.data().picks || {}) : {};
        state.picksByUser.set(state.currentUser, picks);
      }

      renderGrid();
      setStatus(`Adds to ${state.weekId} • ${state.games.length} game(s)`);
    }

    function renderGrid(){
      const rows = byId('rows');
      rows.innerHTML = "";
      for(const g of state.games){
        rows.appendChild(renderRow(g));
      }
    }

    function renderRow(game){
      const userPick = (state.currentUser && state.picksByUser.get(state.currentUser) || {})[game.id] || "";
      const node = el(`
        <div class="trow" data-id="${game.id}">
          <input data-field="day" value="${escapeHtml(game.day)}" placeholder="Thursday">
          <input data-field="kickoff" type="datetime-local" value="${toLocalDatetimeValue(game.kickoff)}">
          <input data-field="home" value="${escapeHtml(game.home)}" placeholder="Home team">
          <input data-field="away" value="${escapeHtml(game.away)}" placeholder="Away team">
          <select data-field="winner">
            <option value=""></option>
            <option value="home" ${game.winner==="home"?"selected":""}>home</option>
            <option value="away" ${game.winner==="away"?"selected":""}>away</option>
          </select>
          <select data-field="pick" ${state.currentUser ? "" : "disabled"}>
            <option value=""></option>
            <option value="home" ${userPick==="home"?"selected":""}>home</option>
            <option value="away" ${userPick==="away"?"selected":""}>away</option>
          </select>
          <div class="right">
            <button class="btn-danger" data-action="delete">Delete</button>
          </div>
        </div>
      `);

      node.querySelector('[data-action="delete"]').addEventListener('click', async ()=>{
        if(!confirm("Delete this game?")) return;
        await deleteDoc(doc(db, "games", game.id));
        await loadWeek();
      });

      // Listen for user pick changes (in-memory)
      const pickSel = node.querySelector('select[data-field="pick"]');
      if(pickSel){
        pickSel.addEventListener('change', ()=>{
          ensurePickMap();
          const pm = state.picksByUser.get(state.currentUser);
          pm[game.id] = pickSel.value || "";
        });
      }

      return node;
    }

    function ensurePickMap(){
      if(!state.currentUser) return;
      if(!state.picksByUser.has(state.currentUser)){
        state.picksByUser.set(state.currentUser, {});
      }
    }

    async function saveGameChanges(){
      // Iterate rows and write updates
      const rows = [...document.querySelectorAll('.trow')];
      let updated = 0;
      for(const r of rows){
        const id = r.getAttribute('data-id');
        const payload = {
          day: r.querySelector('[data-field="day"]').value.trim(),
          kickoff: r.querySelector('[data-field="kickoff"]').value ? new Date(r.querySelector('[data-field="kickoff"]').value).toISOString() : "",
          home: r.querySelector('[data-field="home"]').value.trim(),
          away: r.querySelector('[data-field="away"]').value.trim(),
          winner: r.querySelector('[data-field="winner"]').value || ""
        };
        await updateDoc(doc(db, "games", id), payload);
        updated++;
      }
      setStatus(`Saved ${updated} game(s).`);
    }

    async function addGameFromInputs(){
      const day = byId('dayInput').value;
      const home = (byId('homeInput').value||"").trim();
      const away = (byId('awayInput').value||"").trim();
      const kickoffValue = byId('kickoffInput').value;
      if(!home || !away || !kickoffValue){
        alert("Please fill Home, Away, and Kickoff.");
        return;
      }
      const kickoffIso = new Date(kickoffValue).toISOString();
      const payload = { weekId: state.weekId, day, home, away, kickoff: kickoffIso, winner: "" };
      await addDoc(collection(db, "games"), payload);
      // clear inputs (keep day)
      byId('homeInput').value = "";
      byId('awayInput').value = "";
      byId('kickoffInput').value = "";
      await loadWeek();
      setStatus("Game added.");
    }

    // --- User pick helpers ---
    function getSelectedUserEmail(){
      if(!state.currentUser){
        alert("Load a user first (enter email, then click Load).");
        return "";
      }
      return state.currentUser;
    }

    function fillUserPicks(val, blanksOnly){
      const email = getSelectedUserEmail(); if(!email) return;
      ensurePickMap();
      const pm = state.picksByUser.get(email);
      for(const g of state.games){
        if(blanksOnly && pm[g.id]) continue;
        pm[g.id] = val;
      }
      renderGrid();
    }

    function clearUserPicks(){
      const email = getSelectedUserEmail(); if(!email) return;
      ensurePickMap();
      const pm = state.picksByUser.get(email);
      for(const g of state.games){ pm[g.id] = ""; }
      renderGrid();
    }

    async function saveSelectedUser(){
      const email = getSelectedUserEmail(); if(!email) return;
      ensurePickMap();
      const pm = state.picksByUser.get(email);
      const uid = uidFromEmail(email);
      const pRef = doc(db, "picks", uid, "weeks", state.weekId);
      await setDoc(pRef, { picks: pm, savedAt: serverTimestamp() }, { merge: true });
      setStatus(`Saved picks for ${email}.`);
    }

    // --- Simple HTML escape ---
    function escapeHtml(s){
      return (s??"").replace(/[&<>"]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'
      }[c]));
    }
  </script>
</body>
</html>
