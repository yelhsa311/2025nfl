<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Family NFL Picks</title>
<style>
  :root{
    --bg:#0f1115; --fg:#e7e7e7; --muted:#9aa0a6; --card:#171a21; --border:#252a33; --accent:#6ea8ff;
    --good-bg:#e6f7ee; --good-fg:#0b6b2e;          /* Correct (green) */
    --bad-bg:#fdeaea;  --bad-fg:#9d1c1c;           /* Incorrect (red) */
    --pend-bg:#e9eef7; --pend-fg:#1f3a5f;          /* Pending (blue-ish) */
    --final-bg:#efe1ff;--final-fg:#5a2ea6;         /* Finalized (purple) */
    --pick:#2c7be5; --pick-fg:#fff;                /* Selected pick button */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  a{color:#aeb3ff;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}
  select,input,button{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 10px;border-radius:10px}
  button:hover{filter:brightness(1.1);cursor:pointer}
  h1{margin:.2rem 0}
  .muted{color:var(--muted)}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:13px}
  .chip.final{background:var(--final-bg); color:var(--final-fg); border-color:#cdb4ff}
  .chip.pending{background:var(--pend-bg); color:var(--pend-fg); border-color:#c4d1f0}
  .chip.good{background:var(--good-bg); color:var(--good-fg); border-color:#bfead0}
  .chip.bad{ background:var(--bad-bg);  color:var(--bad-fg);  border-color:#f5bcbc}
  .legend .chip{margin-right:6px}

  .day{margin:14px 0 6px 0; color:#cbd2f1; font-weight:600}
  .game{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;margin:6px 0}
  .team{padding:10px;border:1px solid var(--border);border-radius:10px;background:#141923;font-size:15px;text-align:center}
  .team.pick{background:var(--pick); color:var(--pick-fg); border-color:#2a6fd0;}
  .team.disabled{opacity:.55; pointer-events:none}
  .team.result-win{outline:2px solid #3ecf8e;}
  .team.result-loss{outline:2px solid #f87171;}
  .vs{min-width:140px;text-align:center;color:var(--muted);font-size:14px}
  .time{display:block;font-size:12px;color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="row" style="justify-content:space-between">
    <h1>Family NFL Picks</h1>
    <div class="row">
      <span id="who" class="pill"></span>
      <button id="logoutBtn" title="Sign out">Sign out</button>
    </div>
  </div>

  <!-- Login -->
  <div id="login" class="card">
    <h2 style="margin-top:0">Sign in</h2>
    <div class="row">
      <input id="email" type="email" placeholder="Email" autocomplete="username" />
      <input id="pass" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="emailBtn">Sign in</button>
      <button id="googleBtn">Google</button>
    </div>
    <div id="err" class="muted" style="color:#ff9c9c"></div>
    <div class="muted" style="margin-top:6px">If the Google popup is blocked, try allowing popups or use email.</div>
  </div>

  <!-- App -->
  <div id="app" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label>Week:
          <select id="weekSelect"></select>
        </label>
        <button id="refreshBtn">Refresh</button>
        <span class="legend muted">
          <span class="chip pending">Pending</span>
          <span class="chip good">Correct</span>
          <span class="chip bad">Incorrect</span>
          <span class="chip final">Final</span>
        </span>
      </div>
      <div class="row">
        <span id="lockChip" class="chip pending">Loadingâ€¦</span>
      </div>
    </div>

    <div class="divider"></div>

    <div id="gamesRoot"></div>
    <div id="empty" class="muted">No games yet for this week.</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // --- Config (yours) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
    authDomain: "nfl-picks-b83c2.firebaseapp.com",
    projectId: "nfl-picks-b83c2",
    storageBucket: "nfl-picks-b83c2.appspot.com",
    messagingSenderId: "802058909501",
    appId: "1:802058909501:web:bb935c188891934de07754"
  };

  // --- Init ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);
  const provider = new GoogleAuthProvider();

  // --- State ---
  const $ = (id) => document.getElementById(id);
  const state = {
    user: null,
    weekId: "2025-Week-01",
    games: [],               // [{id, day, home, away, kickoffTs, winner}]
    picks: {},               // { [gameId]: "home"|"away" }
    locked: false
  };

  // --- UI helpers ---
  function show(el){ if (el) el.style.display=""; }
  function hide(el){ if (el) el.style.display="none"; }
  const fmtTime = (ms) => ms ? new Date(ms).toLocaleTimeString([], { hour:"numeric", minute:"2-digit" }) : "TBD";

  // --- Auth actions ---
  $("emailBtn").onclick = async () => {
    $("err").textContent = "";
    try {
      await signInWithEmailAndPassword(auth, $("email").value.trim(), $("pass").value);
    } catch (e) { $("err").textContent = e.message || String(e); }
  };
  $("googleBtn").onclick = async () => {
    $("err").textContent = "";
    try { await signInWithPopup(auth, provider); }
    catch (e) { $("err").textContent = e.message || String(e); }
  };
  $("logoutBtn").onclick = async () => { try { await signOut(auth); } catch {} };

  // --- Auth state ---
  onAuthStateChanged(auth, async (user) => {
    state.user = user || null;
    if (!user){
      show($("login")); hide($("app"));
      $("who").textContent = "";
      return;
    }
    hide($("login")); show($("app"));
    $("who").textContent = user.email || user.displayName || user.uid;

    // Week selector
    const sel = $("weekSelect"); sel.innerHTML = "";
    for (let i=1;i<=18;i++){
      const id = `2025-Week-${String(i).padStart(2,"0")}`;
      const opt = document.createElement("option"); opt.value=id; opt.textContent=`Week ${i}`;
      sel.appendChild(opt);
    }
    const remembered = localStorage.getItem("userWeek");
    state.weekId = remembered || state.weekId;
    sel.value = state.weekId;
    sel.onchange = () => { state.weekId = sel.value; localStorage.setItem("userWeek", state.weekId); loadWeek(); };

    $("refreshBtn").onclick = loadWeek;

    await loadWeek();
  });

  // --- Load week data (games, winners, lock, my picks) ---
  let unsubLock=null, unsubMyPicks=null, unsubGames=null;
  async function loadWeek(){
    unsubLock?.(); unsubMyPicks?.(); unsubGames?.();
    $("gamesRoot").innerHTML = ""; $("empty").style.display = "none";

    // Lock meta listener (weeks/{weekId}/meta/lock)
    const lockRef = doc(db, "weeks", state.weekId, "meta", "lock");
    unsubLock = onSnapshot(lockRef, snap => {
      const d = snap.exists() ? snap.data() : {};
      state.locked = !!d.locked; // finalized by admin
      renderLockChip(d);
      renderGames(); // update disabled/enabled states
    });

    // Games ordered by kickoff
    const gq = query(collection(db, "weeks", state.weekId, "games"), orderBy("kickoffTs", "asc"));
    unsubGames = onSnapshot(gq, snap => {
      state.games = [];
      snap.forEach(docu => {
        const g = docu.data();
        state.games.push({
          id: docu.id,
          day: g.day || "",
          home: g.home || "",
          away: g.away || "",
          kickoffTs: typeof g.kickoffTs==="number" ? g.kickoffTs : null,
          winner: g.winner || ""
        });
      });
      renderGames();
    });

    // My picks doc
    const myRef = doc(db, "picks", state.user.uid, "weeks", state.weekId);
    unsubMyPicks = onSnapshot(myRef, snap => {
      state.picks = snap.exists() ? (snap.data().picks || {}) : {};
      renderGames();
    });
  }

  function renderLockChip(meta){
    const chip = $("lockChip");
    if (state.locked){
      chip.className = "chip final";
      chip.textContent = "Finalized";
      return;
    }
    chip.className = "chip pending";
    chip.textContent = "Open";
  }

  function groupByDay(games){
    const order = ["Thursday","Friday","Saturday","Sunday","Monday","Other"];
    const map = new Map(order.map(d => [d, []]));
    const norm = d => {
      const x = (d||"").toLowerCase().trim();
      const m = {thursday:"Thursday", friday:"Friday", saturday:"Saturday", sunday:"Sunday", monday:"Monday"};
      return m[x] || "Other";
    };
    for (const g of games){ map.get(norm(g.day)).push(g); }
    return order.map(d => ({ day:d, items: map.get(d) || [] })).filter(group => group.items.length);
  }

  function renderGames(){
    const root = $("gamesRoot");
    root.innerHTML = "";
    const groups = groupByDay(state.games);
    if (!groups.length){ $("empty").style.display=""; return; }
    $("empty").style.display="none";

    for (const {day, items} of groups){
      const h = document.createElement("div");
      h.className = "day"; h.textContent = day;
      root.appendChild(h);

      for (const g of items){
        root.appendChild(renderGameRow(g));
      }
    }
  }

  function renderGameRow(g){
    const row = document.createElement("div");
    row.className = "game";

    const home = document.createElement("button");
    home.className = "team";
    home.textContent = g.home;

    const center = document.createElement("div");
    center.className = "vs";
    center.innerHTML = `vs <span class="time">${fmtTime(g.kickoffTs)}</span>`;

    const away = document.createElement("button");
    away.className = "team";
    away.textContent = g.away;

    // Apply my pick state
    const mine = state.picks[g.id] || "";
    if (mine === "home") home.classList.add("pick");
    if (mine === "away") away.classList.add("pick");

    // Apply result styling (distinct from pick)
    if (g.winner === "home") {
      home.classList.add("result-win");
      if (mine === "away") away.classList.add("result-loss");
    } else if (g.winner === "away") {
      away.classList.add("result-win");
      if (mine === "home") home.classList.add("result-loss");
    }

    // Disable interaction if finalized
    const disabled = state.locked;
    if (disabled){ home.classList.add("disabled"); away.classList.add("disabled"); }

    // Click handlers
    home.onclick = () => choose(g.id, "home");
    away.onclick = () => choose(g.id, "away");

    // Add a tiny status chip for clarity
    const chip = document.createElement("div");
    const status = (g.winner)
      ? (mine ? (mine===g.winner ? "Correct" : "Incorrect") : "Final")
      : (mine ? "Pending" : "Pending");
    chip.className = "chip " +
      (status==="Correct" ? "good" :
       status==="Incorrect" ? "bad" :
       status==="Final" ? "final" : "pending");
    chip.textContent = status;
    center.appendChild(document.createElement("br"));
    center.appendChild(chip);

    row.appendChild(home);
    row.appendChild(center);
    row.appendChild(away);
    return row;
  }

  async function choose(gameId, side){
    if (!state.user) return;
    if (state.locked) return; // finalized: no more changes
    const ref = doc(db, "picks", state.user.uid, "weeks", state.weekId);
    const next = { ...(state.picks || {}) };
    next[gameId] = side;
    try{
      await setDoc(ref, {
        email: state.user.email || null,
        weekId: state.weekId,
        picks: next,
        updatedAt: Date.now()
      }, { merge:true });
    }catch(e){
      alert("Save error: " + (e.message || e));
    }
  }
</script>
</body>
</html>
