<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NFL Picks — Admin Grid</title>
<style>
  :root{--bg:#0f1115;--fg:#e7e7e7;--muted:#9aa0a6;--card:#171a21;--border:#252a33;--accent:#6ea8ff;--warn:#ffd56e;--good:#86f5b2}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  a{color:#aeb3ff;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px}
  select,input,button{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 10px;border-radius:10px}
  button.primary{outline:2px solid var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;vertical-align:middle;font-size:14px}
  th{position:sticky;top:0;background:var(--card);z-index:2}
  tbody tr:hover{background:#12151c}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .muted{color:var(--muted)}
  .dirty{background:rgba(255,213,110,.12)}
  .ok{color:var(--good)}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h1 style="margin:.2rem 0">Admin Grid</h1>
    <div class="row">
      <a class="pill" href="index.html">← Back to App</a>
      <span id="userTag" class="pill"></span>
      <span id="adminTag" class="pill" style="display:none">ADMIN</span>
    </div>
  </div>

  <div id="auth" class="card">
    <div class="row">
      <input id="email" type="email" placeholder="Email">
      <input id="pass" type="password" placeholder="Password">
      <button id="signInBtn" class="primary">Sign in</button>
    </div>
    <div class="muted" style="margin-top:6px">Admins only. This view edits games (winner) and users’ picks for a week.</div>
  </div>

  <div id="app" class="card" style="display:none">
    <div class="row" style="gap:12px">
      <label>Week:
        <select id="weekSelect"></select>
      </label>

      <button id="refreshBtn">Refresh</button>

      <label>Users (comma-separated):
        <input id="usersInput" style="min-width:360px" placeholder="email1@example.com, email2@example.com">
      </label>
      <button id="applyUsersBtn">Apply Users</button>

      <button id="saveBtn" class="primary">Save Changes</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="card" style="max-height:70vh;overflow:auto">
      <table id="grid">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card muted" id="log" style="white-space:pre-wrap"></div>
  </div>
</div>

<script type="module">
  // Firebase (same project as your app)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, setDoc, writeBatch, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
    authDomain: "nfl-picks-b83c2.firebaseapp.com",
    projectId: "nfl-picks-b83c2",
    storageBucket: "nfl-picks-b83c2.appspot.com",
    messagingSenderId: "802058909501",
    appId: "1:802058909501:web:bb935c188891934de07754"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Keep this in sync with your index.html
  const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"];

  // Helpers
  const el = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  const fmtTime = ts => ts ? new Date(ts).toLocaleString([], { month:"short", day:"2-digit", hour:"numeric", minute:"2-digit" }) : "";

  const slug = s => (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  const uidFromEmail = email => slug(email).slice(0,64);
  const makeGameId = (home, away, kickoffTs) => `${slug(home)}__${slug(away)}__${kickoffTs ?? "na"}`;

  const state = {
    weekId: null,
    users: [],          // emails
    games: [],          // [{id, day, home, away, kickoffTs, winner}]
    picksByUser: new Map(), // email -> { [gameId]: "home"|"away" }
    dirty: { games: new Set(), picks: new Set() } // track edited rows
  };

  function log(...a){ el("#log").textContent += a.join(" ") + "\n"; }
  function setStatus(t){ el("#status").textContent = t || ""; }

  // Auth
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      el("#auth").style.display="";
      el("#app").style.display="none";
      return;
    }
    const isAdmin = ADMIN_UIDS.includes(user.uid);
    el("#userTag").textContent = user.email;
    el("#adminTag").style.display = isAdmin ? "" : "none";
    el("#auth").style.display="none";
    el("#app").style.display="";
    if(!isAdmin){ alert("Admins only."); signOut(auth); }
  });

  byId("signInBtn").onclick = async ()=>{
    try{
      await signInWithEmailAndPassword(auth, byId("email").value.trim(), byId("pass").value);
    }catch(e){ alert(e.message); }
  };

  // Week selector
  const sel = byId("weekSelect");
  for (let i=1;i<=18;i++){
    const id = `2025-Week-${String(i).padStart(2,"0")}`;
    const o = document.createElement("option");
    o.value=id; o.textContent=`Week ${i}`;
    sel.appendChild(o);
  }
  const remembered = localStorage.getItem("adminGridWeek");
  sel.value = remembered || `2025-Week-01`;
  state.weekId = sel.value;
  sel.onchange = ()=>{ state.weekId = sel.value; localStorage.setItem("adminGridWeek", state.weekId); loadWeek(); };

  byId("refreshBtn").onclick = loadWeek;

  // Users input
  function saveUsersPref(){
    localStorage.setItem("adminGridUsers:"+state.weekId, JSON.stringify(state.users));
    byId("usersInput").value = state.users.join(", ");
  }
  function loadUsersPref(){
    const raw = localStorage.getItem("adminGridUsers:"+state.weekId);
    if (raw) {
      try { state.users = JSON.parse(raw) || []; }
      catch { state.users = []; }
      byId("usersInput").value = state.users.join(", ");
    }
  }
  byId("applyUsersBtn").onclick = ()=>{
    const emails = byId("usersInput").value.split(",").map(s=>s.trim()).filter(Boolean);
    state.users = emails;
    saveUsersPref();
    renderGrid();
  };

  // Load week: games + auto-detect users from picks (merge with saved list)
  async function loadWeek(){
    setStatus("Loading…");
    el("#thead").innerHTML = "";
    el("#tbody").innerHTML = "";
    state.games = [];
    state.picksByUser.clear();
    state.dirty.games.clear();
    state.dirty.picks.clear();

    loadUsersPref();

    // Fetch games for the week (order by kickoffTs)
    const gq = query(collection(db,"weeks",state.weekId,"games"), orderBy("kickoffTs","asc"));
    const gSnap = await getDocs(gq);
    gSnap.forEach(d=>{
      const v = d.data();
      state.games.push({
        id: d.id,
        day: v.day || "",
        home: v.home || "",
        away: v.away || "",
        kickoffTs: v.kickoffTs || null,
        winner: v.winner || ""
      });
    });

    // If no games yet, show empty grid
    if (!state.games.length){
      renderGrid();
      setStatus("No games found for "+state.weekId);
      // still try to auto-detect users from picks
    }

    // Auto-detect users from picks docs for this week
    // (we scan picks/*/weeks/{weekId} — but we don’t know all users, so we can’t list all; instead,
    // we rely on the saved users list OR the ones we’ve seen before.)
    // To help, we’ll try a small heuristic: check localStorage for a global list.
    const globalUsers = JSON.parse(localStorage.getItem("adminGridUsers:GLOBAL") || "[]");
    const merged = new Set([...(state.users||[]), ...globalUsers]);
    state.users = [...merged];
    saveUsersPref(); // keep in sync

    // Load picks for each known user for this week
    for (const email of state.users){
      const uid = uidFromEmail(email);
      const pRef = doc(db,"picks",uid,"weeks",state.weekId);
      try{
        const snap = await getDocs(collection(db,"picks",uid,"weeks")); // we cannot read a single doc with getDocs, so:
      }catch{}
    }
    // Better: fetch each doc directly with setDoc/get; but dynamic import:
    // Lightweight single-doc read using fetch-like approach (workaround):
    // We’ll just lazy-load picks when rendering each user column.

    renderGrid();
    setStatus("");
  }

  // Lazy fetch a user's picks doc for the current week
  async function getUserPicks(email){
    if (state.picksByUser.has(email)) return state.picksByUser.get(email);
    const uid = uidFromEmail(email);
    const url = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/picks/${uid}/weeks/${state.weekId}`;
    try{
      const res = await fetch(url);
      if (res.ok){
        const json = await res.json();
        const picks = (json.fields && json.fields.picks && json.fields.picks.mapValue && json.fields.picks.mapValue.fields) || {};
        const obj = {};
        for (const [k,v] of Object.entries(picks)) obj[k] = (v.stringValue || "").toLowerCase();
        state.picksByUser.set(email, obj);
        return obj;
      }
    }catch(e){ /* ignore */ }
    const empty = {};
    state.picksByUser.set(email, empty);
    return empty;
  }

  function headerHtml(){
    const cols = [
      "<th style='min-width:80px'>Day</th>",
      "<th style='min-width:160px'>Kickoff</th>",
      "<th style='min-width:200px'>Home</th>",
      "<th style='min-width:200px'>Away</th>",
      "<th style='min-width:120px'>Winner</th>",
    ];
    for (const email of state.users) cols.push(`<th style="min-width:140px">${email}</th>`);
    return `<tr>${cols.join("")}</tr>`;
  }

  async function renderGrid(){
    el("#thead").innerHTML = headerHtml();
    const tb = el("#tbody");
    tb.innerHTML = "";

    // Preload picks for all users (parallel)
    await Promise.all(state.users.map(getUserPicks));

    for (const g of state.games){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.day || ""}</td>
        <td>${fmtTime(g.kickoffTs)}</td>
        <td>${g.home}</td>
        <td>${g.away}</td>
        <td>${winnerCell(g)}</td>
      `;
      // User pick cells
      for (const email of state.users){
        const picks = state.picksByUser.get(email) || {};
        const val = picks[g.id] || "";
        const td = document.createElement("td");
        td.appendChild(pickSelect(g, email, val));
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  }

  function option(tag, val, txt, selected){ return `<option value="${val}" ${selected?'selected':''}>${txt}</option>`; }
  function winnerCell(g){
    const v = g.winner || "";
    return `
      <select data-kind="winner" data-gameid="${g.id}">
        ${option("","", "", v==="")}
        ${option("","home","home", v==="home")}
        ${option("","away","away", v==="away")}
      </select>
    `;
  }
  function pickSelect(g, email, current){
    const s = document.createElement("select");
    s.innerHTML = `
      ${option("","", "", current==="")}
      ${option("","home","home", current==="home")}
      ${option("","away","away", current==="away")}
    `;
    s.dataset.kind = "pick";
    s.dataset.gameid = g.id;
    s.dataset.email = email;
    s.onchange = () => {
      s.classList.add("dirty");
      state.dirty.picks.add(email); // mark that user's doc needs save
      // update local cache immediately
      const p = state.picksByUser.get(email) || {};
      p[g.id] = s.value || "";
      state.picksByUser.set(email, p);
    };
    return s;
  }

  // Track winner changes
  el("#tbody").addEventListener("change", (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLSelectElement)) return;
    if (t.dataset.kind === "winner"){
      t.classList.add("dirty");
      state.dirty.games.add(t.dataset.gameid);
      // update local game
      const g = state.games.find(x => x.id === t.dataset.gameid);
      if (g) g.winner = t.value || "";
    }
  });

  // SAVE
  byId("saveBtn").onclick = async ()=>{
    try{
      setStatus("Saving…");
      const batch = writeBatch(db);

      // Save winners for dirty games
      const gamesDirty = [...state.dirty.games];
      for (const gid of gamesDirty){
        const g = state.games.find(x => x.id === gid);
        if (!g) continue;
        const ref = doc(db, "weeks", state.weekId, "games", gid);
        batch.set(ref, { winner: g.winner || null, updatedAt: Date.now() }, { merge:true });
      }

      await batch.commit();

      // Save picks for users marked dirty
      let pickDocs = 0;
      for (const email of state.dirty.picks){
        const picks = state.picksByUser.get(email) || {};
        const uid = uidFromEmail(email);
        const ref = doc(db, "picks", uid, "weeks", state.weekId);
        await setDoc(ref, { email, weekId: state.weekId, picks, updatedAt: Date.now() }, { merge:true });
        pickDocs++;
      }

      state.dirty.games.clear();
      state.dirty.picks.clear();
      // clear dirty UI marks
      document.querySelectorAll(".dirty").forEach(n=>n.classList.remove("dirty"));
      setStatus(`Saved winners: ${gamesDirty.length} | picks docs: ${pickDocs}`);
    }catch(e){
      console.error(e);
      setStatus("Save error: " + (e.message||e));
      alert("Save error: " + (e.message||e));
    }
  };

  // Init
  loadWeek();
</script>
</body>
</html>
