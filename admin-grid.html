<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NFL Picks ‚Äî Admin Grid (v2.0)</title>
<style>
  :root{--bg:#0f1115;--fg:#e7e7e7;--muted:#9aa0a6;--card:#171a21;--border:#252a33;--accent:#6ea8ff;--warn:#ffd56e;--good:#86f5b2;--danger:#ff8c8c}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  a{color:#aeb3ff;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px}
  select,input,button{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 10px;border-radius:10px}
  button.primary{outline:2px solid var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;vertical-align:middle;font-size:14px}
  th{position:sticky;top:0;background:var(--card);z-index:1}
  tbody tr:hover{background:#12151c}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .muted{color:var(--muted)}
  .dirty{background:rgba(255,213,110,.12)}
  .ok{color:var(--good)}
  .warn{color:var(--warn)}
  .danger{color:var(--danger)}
  .btn-danger{background:#5b2020;border:1px solid #802020;color:#ffcccc;padding:6px 10px;border-radius:8px}
  .btn-danger:hover{background:#7a2a2a}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px}
  .divider{height:1px;background:var(--border);margin:8px 0}
  .version-pill{background:#0f1629;border-color:#2d3a55;color:#9cc7ff}
  .import-link{margin-left:12px; color:#5aa6ff; text-decoration:none;} .import-link:hover{text-decoration:underline;}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div class="row" style="align-items:center; gap:10px">
      <h1 style="margin:.2rem 0">Admin Grid</h1>
      <span class="pill version-pill">v2.0</span>
    </div>
    <div class="row">
      <a class="pill" href="index.html">‚Üê Back to App</a> <a href='./admin-import.html' class='import-link'>üì• Go to Importer</a>
      <span id="userTag" class="pill"></span>
      <span id="adminTag" class="pill" style="display:none">ADMIN</span>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="auth" class="card">
    <div class="row" style="flex-wrap:wrap; gap:10px; align-items:flex-start;">
      <div class="row" style="gap:8px">
        <input id="email" type="email" placeholder="Email">
        <input id="pass" type="password" placeholder="Password">
        <button id="signInBtn" class="primary">Sign in</button>
      </div>
      <button id="googleBtn" style="display:flex; align-items:center; gap:8px;">‚û°Ô∏è Sign in with Google</button>
    </div>
    <div id="authMsg" class="muted" style="margin-top:6px">Admins only. Manage games, winners, and user picks per week.</div>
  </div>

  <!-- APP -->
  <div id="app" class="card" style="display:none">
    <div class="row" style="gap:12px">
      <label>Week:
        <select id="weekSelect"></select>
      </label>

      <button id="refreshBtn">Refresh</button>

      <label>Users (comma-separated):
        <input id="usersInput" style="min-width:360px" placeholder="email1@example.com, email2@example.com">
      </label>
      <button id="applyUsersBtn">Apply Users</button>

      <button id="saveBtn" class="primary">Save Changes</button>
      <span id="status" class="muted"></span>
    </div>

    <!-- Add Game panel -->
    <div class="card" id="addGamePanel">
      <div class="row" style="gap:12px; align-items:flex-end;">
        <label>Day
          <select id="addDay">
            <option>Thursday</option>
            <option>Friday</option>
            <option>Saturday</option>
            <option selected>Sunday</option>
            <option>Monday</option>
          </select>
        </label>

        <label>Home
          <input id="addHome" placeholder="e.g. Dallas Cowboys" />
        </label>

        <label>Away
          <input id="addAway" placeholder="e.g. Philadelphia Eagles" />
        </label>

        <label>Kickoff (local)
          <input id="addKick" type="datetime-local" />
        </label>

        <button id="addGameBtn" class="primary">+ Add game</button>
        <span class="muted">Adds to <strong id="wkLabel"></strong></span>
      </div>
    </div>

    <!-- Cleanup + Tools -->
    <div class="row" style="margin-top:10px; gap:10px;">
      <button id="removeDupesBtn">Remove Duplicates</button>
      <button id="clearGamesBtn">Clear All Games for Week</button>
      <span class="divider" style="width:1px;"></span>
      <span class="chip">Orphans: <span id="orphanCount" class="warn">‚Äî</span>
        <button id="scanOrphansBtn" style="margin-left:8px">Scan</button>
        <button id="fixOrphansBtn">Fix</button>
      </span>
      <span class="divider" style="width:1px;"></span>
      <span class="chip">User Tools:
        <select id="userSelect" style="margin-left:6px; min-width:220px"></select>
        <button id="fillBlanksHomeBtn">Blanks ‚Üí home</button>
        <button id="fillBlanksAwayBtn">Blanks ‚Üí away</button>
        <button id="allHomeBtn">All ‚Üí home</button>
        <button id="allAwayBtn">All ‚Üí away</button>
        <button id="clearUserBtn" class="btn-danger">Clear</button>
        <button id="saveUserBtn" class="primary">Save user</button>
      </span>
    </div>

    <!-- Create user accounts without self-signup -->
    <div class="card" style="margin-top:10px;">
      <div class="row" style="gap:10px; align-items:flex-end; flex-wrap:wrap;">
        <div style="min-width:160px;">
          <strong>Create user</strong>
          <div class="muted">Pre-create login credentials for family</div>
        </div>
        <label>Username
          <input id="newUsername" placeholder="Display name (optional)" />
        </label>
        <label>Email
          <input id="newEmail" type="email" placeholder="user@example.com" />
        </label>
        <label>Password
          <input id="newPass" type="password" placeholder="Min 6 characters" />
        </label>
        <button id="createUserBtn" class="primary">Create user</button>
      </div>
    </div>

    <div class="card" style="max-height:70vh;overflow:auto">
      <table id="grid">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card muted" id="log" style="white-space:pre-wrap"></div>
  </div>
</div>

<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, getDoc, doc, setDoc, writeBatch,
    query, orderBy, addDoc, deleteDoc, collectionGroup, deleteField, where, documentId
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // --- Firebase config (yours) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
    authDomain: "nfl-picks-b83c2.firebaseapp.com",
    projectId: "nfl-picks-b83c2",
    storageBucket: "nfl-picks-b83c2.appspot.com",
    messagingSenderId: "802058909501",
    appId: "1:802058909501:web:bb935c188891934de07754"
  };

  // --- Init ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  setPersistence(auth, browserLocalPersistence).catch(()=>{});
  const db = getFirestore(app);

  // --- Admin allowlist ---
  const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"];   // add more UIDs here
  const ADMIN_EMAILS = ["yelhsa311@gmail.com"];          // or allow by email

  // --- Helpers ---
  const el = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  const log  = (...a)=>{ el("#log").textContent += a.join(" ") + "\n"; };
  const setStatus = t => { el("#status").textContent = t || ""; };
  const fmtTime = ts => ts ? new Date(ts).toLocaleString([], { month:"short", day:"2-digit", hour:"numeric", minute:"2-digit" }) : "";
  const slug = s => (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  const parseEmails = raw => (raw||"").split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  const uidFromEmail = email => slug(email).slice(0,64);

  const state = {
    weekId: null,
    users: [],                 // emails (columns)
    games: [],                 // [{id, day, home, away, kickoffTs, winner}]
    picksByUser: new Map(),    // email -> { [gameId]: "home"|"away" }
    dirty: { games: new Set(), picks: new Set() },
    orphans: new Map()         // email -> [gameId,...] where gameId not in games
  };

  // --- Auth flow ---
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      el("#auth").style.display="";
      el("#app").style.display="none";
      return;
    }

    const isAdmin =
      ADMIN_UIDS.includes(user.uid) ||
      ADMIN_EMAILS.includes((user.email || "").toLowerCase());

    el("#userTag").textContent = `${user.email} ‚Ä¢ uid:${user.uid}`;
    el("#adminTag").style.display = isAdmin ? "" : "none";

    if (!isAdmin) {
      const msg = `Admins only. Add this UID to ADMIN_UIDS or email to ADMIN_EMAILS.`;
      byId("authMsg").textContent = `${msg} UID: ${user.uid} Email: ${user.email || "(no email)"}`;
      alert(`${msg}\n\nUID: ${user.uid}\nEmail: ${user.email}`);
      signOut(auth); // Non-blocking
      return;
    }

    el("#auth").style.display = "none";
    el("#app").style.display  = "";

    // week select
    const sel = byId("weekSelect"); sel.innerHTML="";
    for (let i=1;i<=18;i++){
      const id = `2025-Week-${String(i).padStart(2,"0")}`;
      const o = document.createElement("option"); o.value=id; o.textContent=`Week ${i}`;
      sel.appendChild(o);
    }
    const remembered = localStorage.getItem("adminGridWeek");
    state.weekId = remembered || `2025-Week-01`;
    sel.value = state.weekId;
    sel.onchange = ()=>{ state.weekId = sel.value; localStorage.setItem("adminGridWeek", state.weekId); loadWeek(); };

    // actions
    byId("refreshBtn").onclick = loadWeek;
    byId("applyUsersBtn").onclick = ()=> applyUsers();
    byId("saveBtn").onclick = saveAll;
    byId("addGameBtn").onclick = addGame;
    byId("clearGamesBtn").onclick = clearGamesForWeek;

    byId("scanOrphansBtn").onclick = scanOrphans;
    byId("fixOrphansBtn").onclick = fixOrphans;

    byId("fillBlanksHomeBtn").onclick = ()=> fillUserPicks("home", true);
    byId("fillBlanksAwayBtn").onclick = ()=> fillUserPicks("away", true);
    byId("allHomeBtn").onclick        = ()=> fillUserPicks("home", false);
    byId("allAwayBtn").onclick        = ()=> fillUserPicks("away", false);
    byId("clearUserBtn").onclick      = clearUserPicks;
    byId("saveUserBtn").onclick       = saveSelectedUser;
    byId("createUserBtn").onclick     = createAccount;

    // init
    loadUsersPref();
    loadWeek();
  });

  // Real sign-in handler
  byId("signInBtn").onclick = async ()=>{
    try{
      await signInWithEmailAndPassword(auth, byId("email").value.trim(), byId("pass").value);
    }catch(e){ alert(e.message); }
  };

  // Google sign-in helper
  byId("googleBtn").onclick = async ()=>{
    try{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }catch(e){
      console.error(e);
      byId("authMsg").textContent = e.message || String(e);
      alert(e.message || String(e));
    }
  };

  // --- Admin-created accounts (avoid signing the admin out) ---
  let secondaryAuth = null;
  function getSecondaryAuth(){
    if (secondaryAuth) return secondaryAuth;
    const secondaryApp = getApps().find(a => a.name === "__SECONDARY__") || initializeApp(firebaseConfig, "__SECONDARY__");
    secondaryAuth = getAuth(secondaryApp);
    return secondaryAuth;
  }

  async function createAccount(){
    const email = byId("newEmail").value.trim();
    const username = byId("newUsername").value.trim();
    const pass = byId("newPass").value;

    if (!email || !pass){
      alert("Email and password are required.");
      return;
    }
    setStatus("Creating user‚Ä¶");
    try{
      const auth2 = getSecondaryAuth();
      const cred = await createUserWithEmailAndPassword(auth2, email, pass);
      if (username){
        await updateProfile(cred.user, { displayName: username });
      }
      log("Created user:", email, username ? `(username: ${username})` : "");
      setStatus(`Created ${email} successfully`);
      byId("newEmail").value = "";
      byId("newUsername").value = "";
      byId("newPass").value = "";
    }catch(err){
      console.error(err);
      alert(err.message || err);
      setStatus("User creation failed");
    }
  }

  // Users prefs
  function saveUsersPref(){
    localStorage.setItem("adminGridUsers:"+state.weekId, JSON.stringify(state.users));
    localStorage.setItem("adminGridUsers:GLOBAL", JSON.stringify(Array.from(new Set(state.users))));
    byId("usersInput").value = state.users.join(", ");
    refreshUserSelect();
  }
  function loadUsersPref(){
    const raw = localStorage.getItem("adminGridUsers:"+state.weekId);
    if (raw){
      try { state.users = JSON.parse(raw) || []; }
      catch { state.users = []; }
    }
    byId("usersInput").value = (state.users||[]).join(", ");
    refreshUserSelect();
  }
  async function applyUsers(){
    const emails = parseEmails(byId("usersInput").value);
    state.users = emails;
    saveUsersPref();
    await loadPicksForUsers();
    renderGrid();
    setStatus(state.users.length ? `Users applied (${state.users.length}).` : "Add at least one user to use quick tools.");
  }
  function refreshUserSelect(){
    const sel = byId("userSelect");
    sel.innerHTML = "";
    for (const email of state.users){
      const opt = document.createElement("option");
      opt.value = email; opt.textContent = email;
      sel.appendChild(opt);
    }
    if (!sel.value && sel.options.length){ sel.value = sel.options[0].value; }
  }

  async function clearGamesForWeek(){
    if(!confirm(`Delete ALL games for ${state.weekId}?\n\nThis will also prune related picks.`)) return;
    try{
      setStatus("Deleting all games for week‚Ä¶");
      const snap = await getDocs(collection(db, "weeks", state.weekId, "games"));
      if (snap.empty){ setStatus("No games to delete for this week."); return; }

      const ids = snap.docs.map(d => d.id);
      let batch = writeBatch(db), opCount = 0;
      for (const d of snap.docs){
        batch.delete(d.ref); opCount++;
        if (opCount >= 450){ await batch.commit(); batch = writeBatch(db); opCount = 0; }
      }
      if (opCount > 0) await batch.commit();

      await pruneGamesFromAllPicks(state.weekId, ids);
      setStatus(`Deleted ${ids.length} game${ids.length===1?'':'s'} and pruned picks.`);
      await loadWeek();
    }catch(e){
      console.error(e);
      setStatus("Clear week error: " + (e.message||e));
      alert("Clear week error: " + (e.message||e));
    }
  }

  // Add Game
  const toMs = (val) => {
    if (!val) return null; const ms = Date.parse(val); return Number.isFinite(ms) ? ms : null;
  };
  async function addGame(){
    try{
      const day  = byId("addDay").value.trim() || "Sunday";
      const home = byId("addHome").value.trim();
      const away = byId("addAway").value.trim();
      const kick = byId("addKick").value; // "YYYY-MM-DDTHH:mm"
      const kickoffTs = toMs(kick);

      if (!home || !away){ alert("Please enter both Home and Away teams."); return; }

      await addDoc(collection(db, "weeks", state.weekId, "games"), {
        day, home, away, createdAt: Date.now(), ...(kickoffTs ? { kickoffTs } : {})
      });

      byId("addHome").value=""; byId("addAway").value=""; byId("addKick").value="";
      setStatus("Game added.");
      await loadWeek();
    }catch(e){
      console.error(e);
      setStatus("Add game error: " + (e.message||e));
      alert("Add game error: " + (e.message||e));
    }
  }

  // Load games + picks
  async function loadWeek(){
    try{
      setStatus("Loading‚Ä¶");
      byId("wkLabel").textContent = state.weekId;
      el("#thead").innerHTML = ""; el("#tbody").innerHTML = "";
      state.games = []; state.picksByUser.clear();
      state.dirty.games.clear(); state.dirty.picks.clear();
      state.orphans.clear();
      byId("orphanCount").textContent = "‚Äî";

      // games: order by kickoffTs (or createdAt as fallback)
      const gq = query(collection(db,"weeks",state.weekId,"games"), orderBy("kickoffTs","asc"));
      const snap = await getDocs(gq);
      snap.forEach(d=>{
        const v=d.data();
        state.games.push({
          id:d.id,
          day:v.day||"",
          home:v.home||"",
          away:v.away||"",
          kickoffTs: typeof v.kickoffTs==="number" ? v.kickoffTs : null,
          winner:v.winner||""
        });
      });

      // ensure users list
      const globalUsers = JSON.parse(localStorage.getItem("adminGridUsers:GLOBAL") || "[]");
      const merged = new Set([...(state.users||[]), ...globalUsers]);
      state.users = [...merged];
      saveUsersPref();

      // fallback: pull user emails from existing picks if none configured yet
      if (!state.users.length) {
        await hydrateUsersFromPicks();
      }

      await loadPicksForUsers();

    renderGrid();
    setStatus(state.games.length ? "" : "No games found for "+state.weekId);
  }catch(e){
      console.error(e);
      setStatus("Load error: " + (e.message||e));
    }
  }

  function headerHtml(){
    const cols = [
      "<th style='min-width:90px'>Day</th>",
      "<th style='min-width:160px'>Kickoff</th>",
      "<th style='min-width:220px'>Home</th>",
      "<th style='min-width:220px'>Away</th>",
      "<th style='min-width:120px'>Winner</th>",
      "<th style='min-width:90px'></th>" // delete column
    ];
    for (const email of state.users) cols.push(`<th style="min-width:140px">${email}</th>`);
    return `<tr>${cols.join("")}</tr>`;
  }

  function option(val, txt, selected){ return `<option value="${val}" ${selected?'selected':''}>${txt}</option>`; }

  function winnerCell(g){
    const v = g.winner || "";
    return `
      <select data-kind="winner" data-gameid="${g.id}">
        ${option("", "", v==="")}
        ${option("home","home", v==="home")}
        ${option("away","away", v==="away")}
      </select>
    `;
  }

  function pickSelect(g, email, current){
    const s = document.createElement("select");
    s.innerHTML = `
      ${option("", "", current==="")}
      ${option("home","home", current==="home")}
      ${option("away","away", current==="away")}
    `;
    s.dataset.kind="pick";
    s.dataset.gameid=g.id;
    s.dataset.email=email;
    s.onchange = () => {
      s.classList.add("dirty");
      state.dirty.picks.add(email);
      const p = state.picksByUser.get(email) || {};
      p[g.id] = s.value || "";
      state.picksByUser.set(email, p);
    };
    return s;
  }

  async function renderGrid(){
    el("#thead").innerHTML = headerHtml();
    const tb = el("#tbody");
    tb.innerHTML = "";

    for (const g of state.games){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.day || ""}</td>
        <td>${fmtTime(g.kickoffTs)}</td>
        <td>${g.home}</td>
        <td>${g.away}</td>
        <td>${winnerCell(g)}</td>
        <td><button class="btn-danger" data-del="${g.id}">Delete</button></td>
      `;

      for (const email of state.users){
        const picks = state.picksByUser.get(email) || {};
        const val = picks[g.id] || "";
        const td = document.createElement("td");
        td.dataset.user = email;
        td.dataset.gameid = g.id;

        // make the cell clickable to cycle "", "home", "away"
        td.style.cursor = "pointer";
        td.title = "Click to cycle pick: blank ‚Üí home ‚Üí away";

        const sel = pickSelect(g, email, val);
        td.appendChild(sel);
        td.addEventListener("click", (evt) => {
          // avoid double change if actual <select> was clicked
          if (evt.target && evt.target.tagName === "SELECT") return;
          cycleCell(td);
        });

        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }

    // Bind delete buttons AFTER rows are created
    tb.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const gid = btn.dataset.del;
        if (!confirm("Delete this game?")) return;

        await deleteDoc(doc(db, "weeks", state.weekId, "games", gid));
        await pruneGamesFromAllPicks(state.weekId, [gid]);   // prune stale picks
        setStatus(`Deleted ${gid}`);
        await loadWeek();
      });
    });
  }

  // Click-to-cycle helper
  function cycleCell(td){
    const email = td.dataset.user;
    const gameId = td.dataset.gameid;
    if (!email || !gameId) return;

    const p = state.picksByUser.get(email) || {};
    const curr = p[gameId] || "";
    const next = curr === "" ? "home" : curr === "home" ? "away" : "";
    p[gameId] = next;
    state.picksByUser.set(email, p);
    state.dirty.picks.add(email);

    const sel = td.querySelector("select");
    if (sel){ sel.value = next; sel.classList.add("dirty"); }
  }

  // Track winner changes (from select)
  el("#tbody").addEventListener("change", (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLSelectElement)) return;
    if (t.dataset.kind === "winner"){
      t.classList.add("dirty");
      state.dirty.games.add(t.dataset.gameid);
      const g = state.games.find(x => x.id === t.dataset.gameid);
      if (g) g.winner = t.value || "";
    }
  });

  // Save all
  async function saveAll(){
    try{
      setStatus("Saving‚Ä¶");
      // winners (batch)
      const batch = writeBatch(db);
      const gameIds = [...state.dirty.games];
      for (const gid of gameIds){
        const g = state.games.find(x => x.id === gid);
        if (!g) continue;
        batch.set(doc(db,"weeks",state.weekId,"games",gid), { winner: g.winner || null, updatedAt: Date.now() }, { merge:true });
      }
      await batch.commit();

      // picks (per user)
      let pickDocs=0;
      for (const email of state.dirty.picks){
        const uid = uidFromEmail(email);
        const picks = state.picksByUser.get(email) || {};
        await setDoc(doc(db,"picks",uid,"weeks",state.weekId),
          { email, weekId: state.weekId, picks, updatedAt: Date.now() }, { merge:true });
        pickDocs++;
      }

      state.dirty.games.clear();
      state.dirty.picks.clear();
      document.querySelectorAll(".dirty").forEach(n=>n.classList.remove("dirty"));
      setStatus(`Saved winners: ${gameIds.length} | picks docs: ${pickDocs}`);
    }catch(e){
      console.error(e);
      setStatus("Save error: " + (e.message||e));
      alert("Save error: " + (e.message||e));
    }
  }

  // ---- PRUNE DELETED GAME IDS FROM ALL USERS' PICKS ----
  async function pruneGamesFromAllPicks(weekId, gameIds) {
    if (!gameIds?.length) return;
    const q = query(collectionGroup(db, "weeks"));
    const snap = await getDocs(q);

    let batch = writeBatch(db), opCount = 0, totalUpdates = 0;
    for (const d of snap.docs) {
      const data = d.data();
      if (data.weekId !== weekId) continue;

      const updates = {};
      let hasAny = false;
      for (const gid of gameIds) {
        if (data.picks && Object.prototype.hasOwnProperty.call(data.picks, gid)) {
          updates[`picks.${gid}`] = deleteField();
          hasAny = true;
        }
      }
      if (!hasAny) continue;

      updates.updatedAt = Date.now();
      batch.update(d.ref, updates);
      opCount++; totalUpdates++;

      if (opCount >= 450) {
        await batch.commit();
        batch = writeBatch(db);
        opCount = 0;
      }
    }
    if (opCount > 0) await batch.commit();

    setStatus(`Pruned ${totalUpdates} pick entr${totalUpdates===1?'y':'ies'} referencing deleted game(s).`);
  }

  // ---- ORPHAN CHECKER ----
  async function scanOrphans(){
    setStatus("Scanning for orphan picks‚Ä¶");
    state.orphans.clear();

    // Build set of valid gameIds for this week
    const gamesSnap = await getDocs(collection(db, "weeks", state.weekId, "games"));
    const valid = new Set(gamesSnap.docs.map(d => d.id));

    // Walk all picks docs for this week
    const q = query(collectionGroup(db, "weeks"));
    const snap = await getDocs(q);

    let count = 0;
    for (const d of snap.docs){
      const data = d.data();
      if (data.weekId !== state.weekId) continue;
      const email = (data.email || "").trim() || d.ref.path.split("/")[1];
      const picks = data.picks || {};
      const badIds = Object.keys(picks).filter(gid => !valid.has(gid));
      if (badIds.length){
        state.orphans.set(email, badIds);
        count += badIds.length;
      }
    }
    byId("orphanCount").textContent = String(count || "0");
    if (count === 0) setStatus("No orphan picks found.");
    else setStatus(`Found ${count} orphan pick entr${count===1?'y':'ies'}. Click Fix to prune.`);
  }

  async function fixOrphans(){
    if (state.orphans.size === 0){
      setStatus("Nothing to fix.");
      return;
    }
    // Collect all orphan IDs (unique) and prune
    const ids = new Set();
    for (const arr of state.orphans.values()){ for (const id of arr) ids.add(id); }
    await pruneGamesFromAllPicks(state.weekId, Array.from(ids));
    state.orphans.clear();
    byId("orphanCount").textContent = "0";
    setStatus("Orphans pruned.");
    await loadWeek();
  }

  // ---- USER QUICK TOOLS ----
  function getSelectedUserEmail(){
    const sel = byId("userSelect");
    const email = sel.value || "";
    if (!email){ alert("Select a user first."); }
    return email;
  }

  function fillUserPicks(side, blanksOnly){
    const email = getSelectedUserEmail(); if (!email) return;
    const p = state.picksByUser.get(email) || {};
    for (const g of state.games){
      if (blanksOnly && p[g.id]) continue;
      p[g.id] = side;
    }
    state.picksByUser.set(email, p);
    state.dirty.picks.add(email);
    // Reflect in UI (update that user's selects)
    elAllUserSelects(email).forEach(sel => { if (blanksOnly && sel.value) return; sel.value = side; sel.classList.add("dirty"); });
    setStatus(`${blanksOnly ? "Blanks" : "All"} for ${email} set to ${side}.`);
  }

  function clearUserPicks(){
    const email = getSelectedUserEmail(); if (!email) return;
    const p = state.picksByUser.get(email) || {};
    for (const g of state.games){ p[g.id] = ""; }
    state.picksByUser.set(email, p);
    state.dirty.picks.add(email);
    elAllUserSelects(email).forEach(sel => { sel.value = ""; sel.classList.add("dirty"); });
    setStatus(`Cleared all picks for ${email}.`);
  }

  function elAllUserSelects(email){
    // All <select data-kind="pick" data-email="...">
    return Array.from(document.querySelectorAll(`select[data-kind="pick"][data-email="${cssEscape(email)}"]`));
  }

  function cssEscape(s){ return s.replace(/["\\]/g, "\\$&"); }

  async function loadPicksForUsers(){
    state.picksByUser.clear();
    for (const email of state.users){
      const uid = uidFromEmail(email);
      const pRef = doc(db,"picks",uid,"weeks",state.weekId);
      try{
        const psnap = await getDoc(pRef);
        const picks = psnap.exists() ? (psnap.data().picks||{}) : {};
        state.picksByUser.set(email, picks);
      }catch{}
    }
    refreshUserSelect();
    if (!state.users.length){ setStatus("Add users to enable quick tools."); }
  }

  // Auto-collect users from existing picks when none are set locally
  async function hydrateUsersFromPicks(){
    try {
      let snap = await getDocs(query(collectionGroup(db, "weeks"), where("weekId", "==", state.weekId)));

      // Fallback for older picks missing the weekId field: match on doc id instead
      if (snap.empty) {
        snap = await getDocs(query(collectionGroup(db, "weeks"), where(documentId(), "==", state.weekId)));
      }

      const merged = new Set(state.users || []);
      snap.forEach(d => {
        const data = d.data() || {};
        const email = (data.email || "").trim() || d.ref.path.split("/")[1] || "";
        if (email) merged.add(email);
      });
      state.users = [...merged];
      refreshUserSelect();
      if (state.users.length) {
        saveUsersPref();
        setStatus(`Loaded ${state.users.length} user${state.users.length===1?'':'s'} from picks.`);
      } else {
        setStatus("No users found for this week. Add emails to use quick tools or save picks to populate users.");
      }
    } catch (e) {
      console.error(e);
      setStatus("User load error: " + (e.message || e));
    }
  }

  async function saveSelectedUser(){
    const email = getSelectedUserEmail(); if (!email) return;
    try{
      const uid = uidFromEmail(email);
      const picks = state.picksByUser.get(email) || {};
      await setDoc(doc(db,"picks",uid,"weeks",state.weekId),
        { email, weekId: state.weekId, picks, updatedAt: Date.now() }, { merge:true });
      // Clean dirty marks for this user‚Äôs column
      document.querySelectorAll(`select[data-kind="pick"][data-email="${cssEscape(email)}"]`)
        .forEach(n=>n.classList.remove("dirty"));
      state.dirty.picks.delete(email);
      setStatus(`Saved picks for ${email}.`);
    }catch(e){
      alert("Save user error: " + (e.message||e));
    }
  }

  // Enhance pickSelect to carry data-email for quick tools
  // (Monkey-patch after definition; safe because function is hoisted)
  const _orig_pickSelect = pickSelect;
  pickSelect = function(g, email, current){
    const s = _orig_pickSelect(g, email, current);
    s.setAttribute("data-email", email);
    return s;
  }
</script>
</body>
</html>
