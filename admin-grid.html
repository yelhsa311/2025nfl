<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NFL Picks — Admin Grid</title>
<style>
  :root{--bg:#0f1115;--fg:#e7e7e7;--muted:#9aa0a6;--card:#171a21;--border:#252a33;--accent:#6ea8ff;--warn:#ffd56e;--good:#86f5b2}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  a{color:#aeb3ff;text-decoration:none}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px}
  select,input,button{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:8px 10px;border-radius:10px}
  button.primary{outline:2px solid var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;vertical-align:middle;font-size:14px}
  th{position:sticky;top:0;background:var(--card);z-index:1}
  tbody tr:hover{background:#12151c}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .muted{color:var(--muted)}
  .dirty{background:rgba(255,213,110,.12)}
  .ok{color:var(--good)}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h1 style="margin:.2rem 0">Admin Grid</h1>
    <div class="row">
      <a class="pill" href="index.html">← Back to App</a>
      <span id="userTag" class="pill"></span>
      <span id="adminTag" class="pill" style="display:none">ADMIN</span>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="auth" class="card">
    <div class="row">
      <input id="email" type="email" placeholder="Email">
      <input id="pass" type="password" placeholder="Password">
      <button id="signInBtn" class="primary">Sign in</button>
    </div>
    <div class="muted" style="margin-top:6px">Admins only. Manage games, winners, and user picks per week.</div>
  </div>

  <!-- APP -->
  <div id="app" class="card" style="display:none">
    <div class="row" style="gap:12px">
      <label>Week:
        <select id="weekSelect"></select>
      </label>

      <button id="refreshBtn">Refresh</button>

      <label>Users (comma-separated):
        <input id="usersInput" style="min-width:360px" placeholder="email1@example.com, email2@example.com">
      </label>
      <button id="applyUsersBtn">Apply Users</button>

      <button id="saveBtn" class="primary">Save Changes</button>
      <span id="status" class="muted"></span>
    </div>

    <!-- Add Game panel -->
    <div class="card" id="addGamePanel">
      <div class="row" style="gap:12px; align-items:flex-end;">
        <label>Day
          <select id="addDay">
            <option>Thursday</option>
            <option>Friday</option>
            <option>Saturday</option>
            <option selected>Sunday</option>
            <option>Monday</option>
          </select>
        </label>

        <label>Home
          <input id="addHome" placeholder="e.g. Dallas Cowboys" />
        </label>

        <label>Away
          <input id="addAway" placeholder="e.g. Philadelphia Eagles" />
        </label>

        <label>Kickoff (local)
          <input id="addKick" type="datetime-local" />
        </label>

        <button id="addGameBtn" class="primary">+ Add game</button>
        <span class="muted">Adds to <strong id="wkLabel"></strong></span>
      </div>
    </div>

    <div class="card" style="max-height:70vh;overflow:auto">
      <table id="grid">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card muted" id="log" style="white-space:pre-wrap"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, collection, getDocs, getDoc, doc, setDoc, writeBatch, query, orderBy, addDoc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
    authDomain: "nfl-picks-b83c2.firebaseapp.com",
    projectId: "nfl-picks-b83c2",
    storageBucket: "nfl-picks-b83c2.appspot.com",
    messagingSenderId: "802058909501",
    appId: "1:802058909501:web:bb935c188891934de07754"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"]; // your admin uid

  const el = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  const log  = (...a)=>{ el("#log").textContent += a.join(" ") + "\n"; };
  const setStatus = t => { el("#status").textContent = t || ""; };
  const fmtTime = ts => ts ? new Date(ts).toLocaleString([], { month:"short", day:"2-digit", hour:"numeric", minute:"2-digit" }) : "";

  const slug = s => (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  const uidFromEmail = email => slug(email).slice(0,64);

  const state = {
    weekId: null,
    users: [],                 // emails (columns)
    games: [],                 // [{id, day, home, away, kickoffTs, winner}]
    picksByUser: new Map(),    // email -> { [gameId]: "home"|"away" }
    dirty: { games: new Set(), picks: new Set() }
  };

  // Auth
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      el("#auth").style.display="";
      el("#app").style.display="none";
      return;
    }
    const isAdmin = ADMIN_UIDS.includes(user.uid);
    el("#userTag").textContent = user.email;
    el("#adminTag").style.display = isAdmin ? "" : "none";
    el("#auth").style.display="none";
    el("#app").style.display="";
    if(!isAdmin){ alert("Admins only."); signOut(auth); return; }

    // week select
    const sel = byId("weekSelect"); sel.innerHTML="";
    for (let i=1;i<=18;i++){
      const id = `2025-Week-${String(i).padStart(2,"0")}`;
      const o = document.createElement("option"); o.value=id; o.textContent=`Week ${i}`;
      sel.appendChild(o);
    }
    const remembered = localStorage.getItem("adminGridWeek");
    state.weekId = remembered || `2025-Week-01`;
    sel.value = state.weekId;
    sel.onchange = ()=>{ state.weekId = sel.value; localStorage.setItem("adminGridWeek", state.weekId); loadWeek(); };

    // actions
    byId("signInBtn").onclick = async ()=>{};
    byId("refreshBtn").onclick = loadWeek;
    byId("applyUsersBtn").onclick = applyUsers;
    byId("saveBtn").onclick = saveAll;
    byId("addGameBtn").onclick = addGame;

    // init
    loadUsersPref();
    loadWeek();
  });

  byId("signInBtn").onclick = async ()=>{
    try{
      await signInWithEmailAndPassword(auth, byId("email").value.trim(), byId("pass").value);
    }catch(e){ alert(e.message); }
  };

  // Users prefs
  function saveUsersPref(){
    localStorage.setItem("adminGridUsers:"+state.weekId, JSON.stringify(state.users));
    localStorage.setItem("adminGridUsers:GLOBAL", JSON.stringify(Array.from(new Set(state.users))));
    byId("usersInput").value = state.users.join(", ");
  }
  function loadUsersPref(){
    const raw = localStorage.getItem("adminGridUsers:"+state.weekId);
    if (raw){
      try { state.users = JSON.parse(raw) || []; }
      catch { state.users = []; }
    }
    byId("usersInput").value = (state.users||[]).join(", ");
  }
  function applyUsers(){
    const emails = byId("usersInput").value.split(",").map(s=>s.trim()).filter(Boolean);
    state.users = emails;
    saveUsersPref();
    renderGrid();
  }

  // Add Game
  const toMs = (val) => {
    if (!val) return null; const ms = Date.parse(val); return Number.isFinite(ms) ? ms : null;
  };
  async function addGame(){
    try{
      const day  = byId("addDay").value.trim() || "Sunday";
      const home = byId("addHome").value.trim();
      const away = byId("addAway").value.trim();
      const kick = byId("addKick").value; // "YYYY-MM-DDTHH:mm"
      const kickoffTs = toMs(kick);

      if (!home || !away){ alert("Please enter both Home and Away teams."); return; }

      await addDoc(collection(db, "weeks", state.weekId, "games"), {
        day, home, away, createdAt: Date.now(), ...(kickoffTs ? { kickoffTs } : {})
      });

      byId("addHome").value=""; byId("addAway").value=""; byId("addKick").value="";
      setStatus("Game added.");
      await loadWeek();
    }catch(e){
      console.error(e);
      setStatus("Add game error: " + (e.message||e));
      alert("Add game error: " + (e.message||e));
    }
  }

  <div class="row" style="margin-top:10px; gap:10px;">
  <button id="removeDupesBtn">Remove Duplicates</button>
  <button id="clearGamesBtn">Clear All Games for Week</button>
  </div>

  
  // Load games + picks
  async function loadWeek(){
    try{
      setStatus("Loading…");
      byId("wkLabel").textContent = state.weekId;
      el("#thead").innerHTML = ""; el("#tbody").innerHTML = "";
      state.games = []; state.picksByUser.clear();
      state.dirty.games.clear(); state.dirty.picks.clear();

      // games: order by kickoffTs (or createdAt as fallback)
      const gq = query(collection(db,"weeks",state.weekId,"games"), orderBy("kickoffTs","asc"));
      const snap = await getDocs(gq);
      snap.forEach(d=>{
        const v=d.data();
        state.games.push({
          id:d.id,
          day:v.day||"",
          home:v.home||"",
          away:v.away||"",
          kickoffTs: typeof v.kickoffTs==="number" ? v.kickoffTs : null,
          winner:v.winner||""
        });
      });

      // ensure users list
      const globalUsers = JSON.parse(localStorage.getItem("adminGridUsers:GLOBAL") || "[]");
      const merged = new Set([...(state.users||[]), ...globalUsers]);
      state.users = [...merged];
      saveUsersPref();

      // prefetch picks for listed users
      for (const email of state.users){
        const uid = uidFromEmail(email);
        const pRef = doc(db,"picks",uid,"weeks",state.weekId);
        try{
          const psnap = await getDoc(pRef);
          const picks = psnap.exists() ? (psnap.data().picks||{}) : {};
          state.picksByUser.set(email, picks);
        }catch{}
      }

      renderGrid();
      setStatus(state.games.length ? "" : "No games found for "+state.weekId);
    }catch(e){
      console.error(e);
      setStatus("Load error: " + (e.message||e));
    }
  }

  function headerHtml(){
    const cols = [
      "<th style='min-width:90px'>Day</th>",
      "<th style='min-width:160px'>Kickoff</th>",
      "<th style='min-width:220px'>Home</th>",
      "<th style='min-width:220px'>Away</th>",
      "<th style='min-width:120px'>Winner</th>",
    ];
    for (const email of state.users) cols.push(`<th style="min-width:140px">${email}</th>`);
    return `<tr>${cols.join("")}</tr>`;
  }

  function option(val, txt, selected){ return `<option value="${val}" ${selected?'selected':''}>${txt}</option>`; }

  function winnerCell(g){
    const v = g.winner || "";
    return `
      <select data-kind="winner" data-gameid="${g.id}">
        ${option("", "", v==="")}
        ${option("home","home", v==="home")}
        ${option("away","away", v==="away")}
      </select>
    `;
  }

  function pickSelect(g, email, current){
    const s = document.createElement("select");
    s.innerHTML = `
      ${option("", "", current==="")}
      ${option("home","home", current==="home")}
      ${option("away","away", current==="away")}
    `;
    s.dataset.kind="pick";
    s.dataset.gameid=g.id;
    s.dataset.email=email;
    s.onchange = () => {
      s.classList.add("dirty");
      state.dirty.picks.add(email);
      const p = state.picksByUser.get(email) || {};
      p[g.id] = s.value || "";
      state.picksByUser.set(email, p);
    };
    return s;
  }

  async function renderGrid(){
    el("#thead").innerHTML = headerHtml();
    const tb = el("#tbody");
    tb.innerHTML = "";

    for (const g of state.games){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.day || ""}</td>
        <td>${fmtTime(g.kickoffTs)}</td>
        <td>${g.home}</td>
        <td>${g.away}</td>
        <td>${winnerCell(g)}</td>
        <td><button class="btn-danger" data-del="${g.id}">Delete</button></td>
      `;

      for (const email of state.users){
        const picks = state.picksByUser.get(email) || {};
        const val = picks[g.id] || "";
        const td = document.createElement("td");
        td.appendChild(pickSelect(g, email, val));
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  // Bind delete buttons AFTER rows are created
  tb.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const gid = btn.dataset.del;
      if (confirm("Delete this game?")) {
        await deleteDoc(doc(db, "weeks", state.weekId, "games", gid));
        setStatus(`Deleted ${gid}`);
        await loadWeek(); // refresh grid to remove deleted row
      }
    });
  });    
  }

  // track winner changes
  el("#tbody").addEventListener("change", (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLSelectElement)) return;
    if (t.dataset.kind === "winner"){
      t.classList.add("dirty");
      state.dirty.games.add(t.dataset.gameid);
      const g = state.games.find(x => x.id === t.dataset.gameid);
      if (g) g.winner = t.value || "";
    }
  });

  async function saveAll(){
    try{
      setStatus("Saving…");
      // winners (batch)
      const batch = writeBatch(db);
      const gameIds = [...state.dirty.games];
      for (const gid of gameIds){
        const g = state.games.find(x => x.id === gid);
        if (!g) continue;
        batch.set(doc(db,"weeks",state.weekId,"games",gid), { winner: g.winner || null, updatedAt: Date.now() }, { merge:true });
      }
      await batch.commit();

      // picks (per user)
      let pickDocs=0;
      for (const email of state.dirty.picks){
        const uid = uidFromEmail(email);
        const picks = state.picksByUser.get(email) || {};
        await setDoc(doc(db,"picks",uid,"weeks",state.weekId),
          { email, weekId: state.weekId, picks, updatedAt: Date.now() }, { merge:true });
        pickDocs++;
      }

      state.dirty.games.clear();
      state.dirty.picks.clear();
      document.querySelectorAll(".dirty").forEach(n=>n.classList.remove("dirty"));
      setStatus(`Saved winners: ${gameIds.length} | picks docs: ${pickDocs}`);
    }catch(e){
      console.error(e);
      setStatus("Save error: " + (e.message||e));
      alert("Save error: " + (e.message||e));
    }
  }
  // --- ADMIN CLEANUP TOOLS ---
  
  document.getElementById("removeDupesBtn").onclick = async () => {
    if (!confirm("Remove duplicate games for this week?")) return;
    const gamesSnap = await getDocs(collection(db, "weeks", state.weekId, "games"));
    const seen = new Map();
    const toDelete = [];
    gamesSnap.forEach(d => {
      const g = d.data();
      const key = `${(g.day||"").toLowerCase()}|${(g.home||"").toLowerCase()}|${(g.away||"").toLowerCase()}|${g.kickoffTs||0}`;
      if (seen.has(key)) {
        toDelete.push(d.ref);
      } else {
        seen.set(key, d.ref);
      }
    });
    for (const ref of toDelete) await deleteDoc(ref);
    setStatus(`Removed ${toDelete.length} duplicate game(s).`);
    await loadWeek();
  };
  
  document.getElementById("clearGamesBtn").onclick = async () => {
    if (!confirm(`Delete ALL games for ${state.weekId}?`)) return;
    const gamesSnap = await getDocs(collection(db, "weeks", state.weekId, "games"));
    let count = 0;
    for (const docSnap of gamesSnap.docs) {
      await deleteDoc(docSnap.ref);
      count++;
    }
    setStatus(`Deleted ${count} games for ${state.weekId}.`);
    await loadWeek();
  };  
</script>
</body>
</html>
