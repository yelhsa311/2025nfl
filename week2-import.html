<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFL Picks – Week 2 Importer</title>
  <style>
    html,body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#08111f; color:#e6edf3;}
    .wrap{max-width: 980px; margin: 32px auto; padding: 0 16px}
    h1{margin:0 0 10px}
    .card{background:#0f172a; border:1px solid #1f2937; border-radius:16px; padding:18px}
    label{display:block; margin:10px 0 6px; font-size:14px; opacity:.9}
    input[type="text"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #253042; background:#0b1326; color:#e6edf3}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    button{background:#1f6feb; color:white; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    button.secondary{background:#111827; border:1px solid #263447}
    table{width:100%; border-collapse:collapse; margin-top:12px}
    th,td{border-bottom:1px solid #1f2937; padding:8px 10px; font-size:13px}
    .muted{opacity:.75; font-size:13px}
    .ok{color:#7ee787}
    .err{color:#ff7b72}
    .log{white-space:pre-wrap; background:#0b1326; padding:10px; border-radius:10px; border:1px solid #253042; height:160px; overflow:auto}
    .pill{display:inline-flex; gap:8px; align-items:center; background:#111827; border:1px solid #1f2937; border-radius:999px; padding:4px 10px; font-size:12px; opacity:.9}
    .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Week 2 Importer</h1>
    <p class="muted">Upload a CSV exported from your sheet to seed picks for <strong>Week 2</strong> (or change the week id below).</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Week ID</label>
          <input id="weekId" type="text" placeholder="2025-Week-02" value="2025-Week-02" />
        </div>
        <div>
          <label>Write Mode</label>
          <select id="mode">
            <option value="map">/picks/{uid}/weeks/{week}/  (picks map on week doc)</option>
            <option value="subpicks">/picks/{uid}/weeks/{week}/picks/{gameId}  (one doc per game)</option>
          </select>
        </div>
      </div>

      <div class="bar">
        <span id="build" class="pill"></span>
        <span id="authState" class="pill">Auth: (not signed in)</span>
      </div>

      <label>CSV file (UTF-8)</label>
      <input id="file" type="file" accept=".csv" />
      <p class="muted">Required columns: <code>userId</code>, <code>userName</code>, <code>gameId</code>, <code>pick</code>. Extra columns are ignored.</p>

      <div class="bar">
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <input id="seedNames" type="checkbox" /> Also create/update <code>/publicUsers/{uid}.displayName</code>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <input id="mergeMode" type="checkbox" checked /> Merge with existing picks (don’t overwrite other games)
        </label>
      </div>

      <div style="margin:14px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <button id="dryRun">Preview (Dry Run)</button>
        <button id="importBtn">Import to Firestore (Admin)</button>
        <button id="signIn" class="secondary">Sign in with Google</button>
        <button id="signOut" class="secondary">Sign out</button>
      </div>

      <div id="preview"></div>
      <h3>Log</h3>
      <div id="log" class="log"></div>
      <p class="muted">Tip: Imports need an <strong>admin</strong> session (your rules allow owner or admin writes). Dry run works without sign-in.</p>
    </div>
  </div>

  <!-- Your Firebase config -->
  <script>
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.firebasestorage.app",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754",
      measurementId: "G-MSJHYZ4VG2"
    };
  </script>

  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, writeBatch, doc, collection, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // --- init ---
    const app = getApps().length ? getApps()[0] : initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- DOM helpers ---
    const $file = document.getElementById('file');
    const $preview = document.getElementById('preview');
    const $log = document.getElementById('log');
    const $mode = document.getElementById('mode');
    const $weekId = document.getElementById('weekId');
    const $seedNames = document.getElementById('seedNames');
    const $mergeMode = document.getElementById('mergeMode');
    const $build = document.getElementById('build');
    const $authState = document.getElementById('authState');

    $build.textContent = "BUILD: week2-import-" + new Date().toISOString();

    const log = (m) => {$log.textContent += m + "\\n"; $log.scrollTop = $log.scrollHeight;}

    function parseCsv(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file, { header:true, skipEmptyLines:true,
          transformHeader: h => h.trim(),
          complete: r=>resolve(r.data), error: reject
        });
      });
    }

    function renderPreview(rows){
      const sample = rows.slice(0, 12);
      if (!sample.length){ $preview.innerHTML = '<p class="err">No rows.</p>'; return; }
      const cols = Object.keys(sample[0]);
      $preview.innerHTML = \`<table><thead><tr>\${cols.map(c=>\`<th>\${c}</th>\`).join('')}</tr></thead><tbody>\${sample.map(r=>\`<tr>\${cols.map(c=>\`<td>\${(r[c]??'')}</td>\`).join('')}</tr>\`).join('')}</tbody></table>\`;
    }

    // Merge rows -> per-user picks map for the selected week
    function buildUserMaps(rows){
      const week = $weekId.value.trim();
      const users = new Map(); // uid -> { userId, userName, picks:{} }
      for (const r of rows){
        const uid  = String(r.userId || r.uid || '').trim();
        const name = (r.userName || r.name || '').trim();
        const gameId = String(r.gameId || r.game || r.matchId || '').trim();
        const pick   = String(r.pick || r.teamPick || '').trim();

        if (!uid || !gameId){ continue; }
        if (!users.has(uid)) users.set(uid, { userId: uid, userName: name || undefined, week, picks: {} });
        const u = users.get(uid);
        // If merge mode off, last write wins; if on, we only set if not already present.
        if ($mergeMode.checked){
          if (!u.picks[gameId]) u.picks[gameId] = pick;
        } else {
          u.picks[gameId] = pick;
        }
      }
      return users;
    }

    async function doImport(rows){
      const mode = $mode.value;
      const week = $weekId.value.trim();
      if (!week){ alert('Enter week id'); return; }
      const provider = new GoogleAuthProvider();

      // Ensure admin-ish session (your rules require admin to write other users' docs)
      if (!auth.currentUser){
        log("Signing in… (popup)");
        await signInWithPopup(auth, provider);
      } else {
        log("Using current session: " + (auth.currentUser.email || auth.currentUser.uid));
      }

      const users = buildUserMaps(rows);
      log(\`Preparing import for \${users.size} users, mode=\${mode}, week=\${week}\`);

      let batch = writeBatch(db); let ops = 0; let committed = 0;

      for (const [uid, data] of users){
        const weekRef = doc(collection(doc(collection(doc(db,'picks'), uid),'weeks'), week));

        if (mode === 'map'){
          // Merge picks into a map on the week doc
          // If mergeMode is checked, we need to read existing and merge client-side to avoid overwriting others
          if ($mergeMode.checked){
            try{
              const snap = await getDoc(weekRef);
              const existing = snap.exists() ? (snap.data().picks || {}) : {};
              data.picks = { ...existing, ...data.picks };
            }catch(e){ /* best effort */ }
          }
          const payload = {
            userId: uid,
            userName: data.userName,
            week,
            picks: data.picks,
            updatedAt: new Date()
          };
          batch.set(weekRef, payload, { merge:true });
          ops++;
        } else {
          // subpicks: write one doc per gameId under /picks/{uid}/weeks/{week}/picks/{gameId}
          for (const [gameId, pick] of Object.entries(data.picks)){
            const subRef = doc(collection(weekRef, 'picks'), gameId);
            const payload = { userId: uid, userName: data.userName, week, gameId, pick };
            batch.set(subRef, payload, { merge:true });
            ops++;
            if (ops % 400 === 0){ await batch.commit(); committed += 400; log(\`Committed \${committed} ops…\`); batch = writeBatch(db); }
          }
        }

        // Optionally seed display names
        if ($seedNames.checked && data.userName){
          const puRef = doc(collection(db, 'publicUsers'), uid);
          batch.set(puRef, { displayName: data.userName, updatedAt: new Date() }, { merge:true });
          ops++;
        }

        if (ops % 400 === 0){ await batch.commit(); committed += 400; log(\`Committed \${committed} ops…\`); batch = writeBatch(db); }
      }

      if (ops % 400 !== 0){ await batch.commit(); committed += (ops % 400); }
      log(\`✅ Done. Wrote \${ops} ops total.\`);
    }

    // --- auth UI ---
    const $signIn = document.getElementById('signIn');
    const $signOut = document.getElementById('signOut');

    $signIn.addEventListener('click', async ()=>{
      try{
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(e){ log('❌ Sign-in failed: ' + (e.message || e)); }
    });
    $signOut.addEventListener('click', async ()=>{
      try{ await signOut(auth); }catch(e){}
    });

    onAuthStateChanged(auth, (u)=>{
      if (u){
        $authState.textContent = 'Auth: ' + (u.email || u.uid);
      } else {
        $authState.textContent = 'Auth: (not signed in)';
      }
    });

    // --- buttons ---
    document.getElementById('dryRun').addEventListener('click', async()=>{
      $log.textContent='';
      const file = $file.files?.[0];
      if (!file){ alert('Choose a CSV first.'); return; }
      const rows = await parseCsv(file);
      renderPreview(rows);
      const users = buildUserMaps(rows);
      log(\`Parsed \${rows.length} rows. Will import \${users.size} users.\`);
      const sample = [...users.values()].slice(0,3);
      for (const s of sample){
        log('Sample user: ' + s.userId + ' → ' + JSON.stringify(s.picks).slice(0,200));
      }
    });

    document.getElementById('importBtn').addEventListener('click', async()=>{
      $log.textContent='';
      const file = $file.files?.[0];
      if (!file){ alert('Choose a CSV first.'); return; }
      const rows = await parseCsv(file);
      renderPreview(rows);
      try{ await doImport(rows); } catch(e){ log('❌ ' + (e.stack||e.message||e)); }
    });
  </script>
</body>
</html>
