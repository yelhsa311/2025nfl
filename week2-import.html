<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Week Games Importer (Games → /weeks/{week}/games)</title>
  <style>
    :root{--bg:#0b1220;--fg:#e6edf3;--card:#0f172a;--muted:#96a2b4;--accent:#1f6feb;--border:#1f2937;}
    html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 8px}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    label{display:block;margin:10px 0 6px;font-size:14px}
    input[type="text"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1326;color:var(--fg)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.secondary{background:#263141}
    .btns{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px}
    .ok{color:#7ee787}.err{color:#ff7b72}
    .log{white-space:pre-wrap;background:#0b1326;border:1px solid var(--border);border-radius:12px;padding:12px;height:220px;overflow:auto}
    code{background:#0b1326;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Games Importer</h1>
    <p class="muted">Uploads a CSV of games into <code>/weeks/{weekId}/games/{gameId}</code>. Re-imports are idempotent if you use the same IDs.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Week ID (e.g., <code>2025-Week-02</code>)</label>
          <input id="weekId" type="text" placeholder="2025-Week-02" value="2025-Week-02" />
        </div>
        <div>
          <label>Auth</label>
          <div id="authState" class="muted">Not signed in</div>
          <div class="btns" style="margin-top:8px">
            <button id="signIn" class="secondary" type="button">Sign in with Google</button>
            <button id="signOut" class="secondary" type="button">Sign out</button>
          </div>
        </div>
      </div>

      <label>CSV file (UTF-8)</label>
      <input id="file" type="file" accept=".csv" />

      <div style="margin:10px 0">
        <input id="useSlugId" type="checkbox" checked />
        <label for="useSlugId" style="display:inline">Use stable <code>gameId</code> from "<em>home-vs-away</em>" if no <code>gameId</code> column is present</label>
      </div>

      <div class="btns" style="margin:12px 0">
        <button id="dryRun" type="button">Preview (Dry Run)</button>
        <button id="importBtn" type="button">Import to Firestore (Admin)</button>
      </div>

      <div id="preview"></div>

      <h3>Log</h3>
      <div id="log" class="log"></div>

      <p class="muted" style="margin-top:12px">
        Expected headers: <code>weekId,home,away,day,kickoff,winner</code>
        (optional: <code>gameId</code>). <br/>
        <strong>winner</strong> can be <code>home</code>/<code>away</code> or the exact team name.
      </p>
    </div>
  </div>

  <!-- Firebase config: fill with your project values -->
  <script>
    // If you already set window.FIREBASE_CONFIG elsewhere, you can remove or ignore this block.
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.firebasestorage.app",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754"
    };
  </script>

  <!-- PapaParse for robust CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ----- App init -----
    const app = getApps().length ? getApps()[0] : initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ----- DOM -----
    const $weekId   = document.getElementById('weekId');
    const $file     = document.getElementById('file');
    const $useSlug  = document.getElementById('useSlugId');
    const $dryRun   = document.getElementById('dryRun');
    const $import   = document.getElementById('importBtn');
    const $log      = document.getElementById('log');
    const $preview  = document.getElementById('preview');
    const $signIn   = document.getElementById('signIn');
    const $signOut  = document.getElementById('signOut');
    const $authState= document.getElementById('authState');

    const log = (m) => { $log.textContent += m + "\\n"; $log.scrollTop = $log.scrollHeight; };

    onAuthStateChanged(auth, (u) => {
      if (u) $authState.textContent = `Signed in: ${u.email || u.uid}`;
      else   $authState.textContent = 'Not signed in';
    });

    $signIn.onclick = async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (e) {
        log('❌ Sign-in failed: ' + (e.message || e));
      }
    };
    $signOut.onclick = async () => {
      try { await auth.signOut(); } catch (e) { log('❌ Sign-out error: ' + e.message); }
    };

    // ----- CSV helpers -----
    function parseCsv(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, { header:true, skipEmptyLines:true, complete: r => resolve(r.data), error: reject });
      });
    }

    const slug = s => String(s||'').toLowerCase()
      .replace(/&/g,'and').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function normalizeWinner(row) {
      const w = String(row.winner||'').trim();
      const home = (row.home||'').trim();
      const away = (row.away||'').trim();
      if (!w) return null;
      const wl = w.toLowerCase();
      if (wl === 'home' || wl === 'away') return wl;
      if (w === home) return 'home';
      if (w === away) return 'away';
      return null; // unknown/mismatch
    }

    function renderPreview(rows) {
      if (!rows.length) { $preview.innerHTML = '<p class="err">No rows detected.</p>'; return; }
      const sample = rows.slice(0, 12);
      const cols = ['weekId','gameId','home','away','day','kickoff','winner'];
      const head = '<thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead>';
      const body = '<tbody>' + sample.map(r =>
        '<tr>' + cols.map(c=>`<td>${(r[c]??'')}</td>`).join('') + '</tr>'
      ).join('') + '</tbody>';
      $preview.innerHTML = `<table>${head}${body}</table>`;
    }

    async function dryRun() {
      $log.textContent = '';
      const file = $file.files?.[0];
      if (!file) { alert('Choose a CSV file first.'); return; }
      const rows = await parseCsv(file);
      if (!rows.length) { log('No rows in CSV.'); return; }

      const week = $weekId.value.trim();
      if (!week) { alert('Enter a Week ID.'); return; }

      let ok = 0, bad = 0;
      for (const r of rows) {
        r.weekId = (r.weekId || week).trim();
        if (!r.weekId || !r.home || !r.away) { bad++; continue; }
        if (!r.gameId && $useSlug.checked) {
          r.gameId = `${slug(r.home)}-vs-${slug(r.away)}`;
        }
        r.winner = normalizeWinner(r);
        ok++;
      }
      renderPreview(rows);
      log(`Parsed ${rows.length} rows. OK=${ok}, skipped=${bad}`);
      log(`Ready to write /weeks/{weekId}/games/{gameId or autoId}.`);
    }

    async function doImport() {
      $log.textContent = '';
      const u = auth.currentUser;
      if (!u) { alert('Sign in with Google (admin) first.'); return; }

      const file = $file.files?.[0];
      if (!file) { alert('Choose a CSV file first.'); return; }
      const rows = await parseCsv(file);
      if (!rows.length) { log('No rows in CSV.'); return; }

      const week = $weekId.value.trim();
      if (!week) { alert('Enter a Week ID.'); return; }

      let wrote = 0, skipped = 0;
      for (const r of rows) {
        const rowWeek = (r.weekId || week).trim();
        const home = (r.home||'').trim();
        const away = (r.away||'').trim();
        const day = (r.day||'').trim();
        const kickoff = (r.kickoff||'').trim();
        const gameId = (r.gameId || ($useSlug.checked ? `${slug(home)}-vs-${slug(away)}` : '')).trim();
        if (!rowWeek || !home || !away) { skipped++; continue; }

        const winner = normalizeWinner({ winner:r.winner, home, away });

        const ref = gameId
          ? doc(db, 'weeks', rowWeek, 'games', gameId)
          : doc(doc(db, 'weeks', rowWeek), 'games'); // auto-id fallback (less idempotent)

        const data = {
          home, away, day, kickoff,
          ...(winner ? { winner } : {}),
          updatedAt: serverTimestamp(),
          // helpful duplicates for convenience:
          weekId: rowWeek,
          gameId: gameId || ref.id,
        };

        try {
          await setDoc(ref, data, { merge:true });
          wrote++;
        } catch (e) {
          log(`❌ write failed for ${rowWeek} ${home} vs ${away}: ${e.message||e}`);
        }
      }

      log(`✅ Done. Wrote ${wrote} game docs. Skipped ${skipped}.`);
    }

    $dryRun.addEventListener('click', dryRun);
    $import.addEventListener('click', doImport);
  </script>
</body>
</html>
