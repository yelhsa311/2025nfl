<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Week Picks Importer (/picks)</title>
  <style>
    :root{--bg:#0b1220;--fg:#e6edf3;--card:#0f172a;--muted:#96a2b4;--accent:#1f6feb;--border:#1f2937}
    html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    label{display:block;margin:10px 0 6px;font-size:14px}
    input[type="text"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1326;color:var(--fg)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.secondary{background:#263141}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:13px}
    .log{white-space:pre-wrap;background:#0b1326;border:1px solid var(--border);border-radius:12px;padding:12px;height:240px;overflow:auto}
    .muted{color:var(--muted)} code{background:#0b1326;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Week Picks Importer</h1>
    <p class="muted">Imports player picks into <code>/picks/{uid}/weeks/{week}</code>. Choose a write mode below.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Week ID</label>
          <input id="weekId" type="text" value="2025-Week-02" />
        </div>
        <div>
          <label>Write Mode</label>
          <select id="mode">
            <option value="subdocs">/picks/{uid}/weeks/{week}/picks/{gameId} (one doc per game)</option>
            <option value="weekmap">/picks/{uid}/weeks/{week} (picks map on week doc)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Auth</label>
          <div id="authState" class="muted">Not signed in</div>
          <div class="btns">
            <button id="signIn" class="secondary" type="button">Sign in with Google</button>
            <button id="signOut" class="secondary" type="button">Sign out</button>
          </div>
        </div>
        <div>
          <label>CSV file (UTF-8)</label>
          <input id="file" type="file" accept=".csv" />
        </div>
      </div>

      <div style="margin:6px 0 8px">
        <input id="resolveNames" type="checkbox" checked />
        <label for="resolveNames" style="display:inline">Resolve <code>displayName</code> → <code>uid</code> from <code>/publicUsers</code></label>
        <br/>
        <input id="resolveIndex" type="checkbox" checked />
        <label for="resolveIndex" style="display:inline">Resolve <code>gameIndex</code> → <code>gameId</code> from <code>/weeks/{week}/games</code></label>
        <br/>
        <input id="merge" type="checkbox" checked />
        <label for="merge" style="display:inline">Merge (don’t overwrite other games)</label>
      </div>

      <div class="btns">
        <button id="dryRun" type="button">Preview (Dry Run)</button>
        <button id="importBtn" type="button">Import to Firestore (Admin)</button>
      </div>

      <div id="preview"></div>
      <h3>Log</h3>
      <div id="log" class="log"></div>

      <p class="muted" style="margin-top:12px">
        Expected headers (any order; extras ignored):<br/>
        • For <strong>subdocs</strong>: <code>weekId,displayName,userId,gameId,gameIndex,pick</code><br/>
        • For <strong>week map</strong>: <code>weekId,displayName,userId,gameId,gameIndex,pick</code> (same; we build a map)
      </p>
    </div>
  </div>

  <script>
    // Your Firebase config (same as other pages)
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.firebasestorage.app",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754"
    };
  </script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, getDocs, collection, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = getApps().length ? getApps()[0] : initializeApp(window.FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // DOM
    const $weekId  = document.getElementById('weekId');
    const $mode    = document.getElementById('mode');
    const $file    = document.getElementById('file');
    const $dryRun  = document.getElementById('dryRun');
    const $import  = document.getElementById('importBtn');
    const $resolveNames = document.getElementById('resolveNames');
    const $resolveIndex = document.getElementById('resolveIndex');
    const $merge   = document.getElementById('merge');
    const $log     = document.getElementById('log');
    const $preview = document.getElementById('preview');
    const $signIn  = document.getElementById('signIn');
    const $signOut = document.getElementById('signOut');
    const $authState = document.getElementById('authState');

    const log = (m)=>{ $log.textContent += m + "\n"; $log.scrollTop = $log.scrollHeight; };

    onAuthStateChanged(auth, (u)=>{
      $authState.textContent = u ? `Signed in: ${u.email || u.uid}` : 'Not signed in';
    });
    $signIn.onclick = ()=> signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>log('❌ Sign-in: '+(e.message||e)));
    $signOut.onclick= ()=> auth.signOut().catch(e=>log('❌ Sign-out: '+(e.message||e)));

    function parseCsv(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject});
      });
    }

    async function getPublicUsersMap(){
      const snap = await getDocs(collection(db,'publicUsers'));
      const byName = new Map();
      snap.forEach(d=>{
        const v = d.data()||{};
        const name = (v.displayName||v.userName||'').trim().toLowerCase();
        if (name) byName.set(name, d.id);
      });
      return byName;
    }

    async function getWeekGameIds(weekId){
      const snap = await getDocs(collection(doc(collection(db,'weeks'), weekId),'games'));
      // Sort by created order (Firestore doesn’t guarantee order); relying on natural order is OK for your dataset
      const ids = snap.docs.map(d=>d.id);
      return ids; // index 0 => gameIndex 1
    }

    function renderPreview(rows){
      const sample = rows.slice(0,12);
      const cols = ['weekId','displayName','userId','gameId','gameIndex','pick','resolvedUid','resolvedGameId'];
      const head = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
      const body = '<tbody>'+sample.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]??''}</td>`).join('')+'</tr>').join('')+'</tbody>';
      $preview.innerHTML = `<table>${head}${body}</table>`;
    }

    async function prepareRows(rows, weekId){
      const useNames = $resolveNames.checked;
      const useIndex = $resolveIndex.checked;

      let nameToUid;
      if (useNames) nameToUid = await getPublicUsersMap();

      let gameIds;
      if (useIndex) gameIds = await getWeekGameIds(weekId);

      for (const r of rows){
        r.weekId = (r.weekId || weekId).trim();
        // resolve uid from displayName if needed
        if (!r.userId && useNames){
          const key = String(r.displayName||r.userName||'').trim().toLowerCase();
          r.resolvedUid = key ? nameToUid.get(key) : undefined;
        }
        // resolve gameId from gameIndex if needed
        if (!r.gameId && r.gameIndex && useIndex && gameIds?.length){
          const idx = Math.max(1, Number(r.gameIndex|0)) - 1;
          r.resolvedGameId = gameIds[idx];
        }
      }
      return rows;
    }

    $dryRun.onclick = async ()=>{
      $log.textContent='';
      const file = $file.files?.[0];
      if (!file){ alert('Choose a CSV first.'); return; }
      const week = $weekId.value.trim();
      if (!week){ alert('Enter Week ID'); return; }

      const rows = await parseCsv(file);
      await prepareRows(rows, week);
      renderPreview(rows);
      log(`Parsed ${rows.length} rows. Ready for mode "${$mode.value}".`);
    };

    $import.onclick = async ()=>{
      $log.textContent='';
      if (!auth.currentUser){ alert('Sign in first (admin)'); return; }

      const file = $file.files?.[0];
      if (!file){ alert('Choose a CSV first.'); return; }
      const week = $weekId.value.trim();
      if (!week){ alert('Enter Week ID'); return; }

      const mode = $mode.value;
      const rows = await parseCsv(file);
      await prepareRows(rows, week);

      let writes = 0, skipped = 0;
      for (const r of rows){
        const uid = (r.userId || r.resolvedUid || '').trim();
        const gameId = (r.gameId || r.resolvedGameId || '').trim();
        const pick = String(r.pick||'').trim().toLowerCase();
        const displayName = (r.displayName || r.userName || '').trim();

        if (!uid){ skipped++; continue; }
        if (!pick){ skipped++; continue; }

        if (mode === 'subdocs'){
          if (!gameId){ skipped++; continue; }
          const ref = doc(collection(doc(collection(doc(db,'picks'), uid),'weeks'), week),'picks', gameId);
          const data = { userId: uid, userName: displayName || undefined, gameId, week, pick };
          try { await setDoc(ref, data, { merge: $merge.checked }); writes++; }
          catch(e){ log('❌ '+(e.message||e)); }
        } else {
          // week map
          const ref = doc(collection(doc(db,'picks'), uid),'weeks', week);
          const path = `picks.${gameId || 'unknown'}`;
          try {
            if ($merge.checked) await setDoc(ref, { userId: uid, userName: displayName || undefined, week, picks: { [gameId]: pick } }, { merge:true });
            else await setDoc(ref, { userId: uid, userName: displayName || undefined, week, picks: { [gameId]: pick } });
            writes++;
          } catch(e){ log('❌ '+(e.message||e)); }
        }
      }
      log(`✅ Done. Wrote ${writes} rows. Skipped ${skipped}.`);
    };
  </script>
</body>
</html>
