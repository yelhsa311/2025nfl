<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Everyone's Picks (v1.1)</title>
  <style>
    :root{--bg:#0f1115;--fg:#e7e7e7;--muted:#9aa0a6;--card:#171a21;--border:#252a33;--accent:#6ea8ff;--good:#86f5b2;--bad:#ff8c8c;--info:#c7b6ff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    a{color:#aeb3ff;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    h1{margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
    .version-pill{background:#0d1428;color:#9cc7ff;border-color:#2d3a55;font-size:12px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:10px;border-radius:10px}
    button.primary{outline:2px solid var(--accent)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
    th{background:#12151c}
    tbody tr:hover{background:#131722}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0f1424}
    .chip.win{border-color:#1b7a51;background:#10241c;color:#9af7c8}
    .chip.lose{border-color:#943131;background:#241012;color:#ffb3b3}
    .chip.pending{border-color:#423d63;background:#141426;color:#c7b6ff}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row" style="align-items:center; gap:8px">
        <h1 style="margin:0">Everyone's Picks</h1>
        <span class="pill version-pill">v1.1</span>
      </div>
      <div class="row">
        <a class="pill" href="index.html">← Back to App</a>
        <span id="userTag" class="pill" style="display:none"></span>
        <button id="signOutBtn" style="display:none">Sign out</button>
      </div>
    </header>

    <div id="auth" class="card">
      <div class="row">
        <input id="email" type="email" placeholder="Email" />
        <input id="pass" type="password" placeholder="Password" />
        <button id="signInBtn" class="primary">Sign in</button>
      </div>
      <div class="muted" style="margin-top:6px">Sign in to see this week's picks.</div>
    </div>

    <div id="app" class="card" style="display:none">
      <div class="row">
        <label>Season:
          <input id="seasonInput" type="number" style="width:110px" />
        </label>
        <label>Week:
          <select id="weekSelect"></select>
        </label>
        <button id="refreshBtn">Refresh</button>
      </div>
      <div class="note" id="status"></div>
      <div id="tableWrap"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, orderBy, query, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDC2DnD4I4nekKWnCkDD9dTwQZN4tj3g0w",
      authDomain: "nflpicks2025-51202.firebaseapp.com",
      projectId: "nflpicks2025-51202",
      storageBucket: "nflpicks2025-51202.appspot.com",
      messagingSenderId: "125791202188",
      appId: "1:125791202188:web:903f4c74dc84a5b69604a9",
      measurementId: "G-289KXJQZGG"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    const state = {
      season: String(new Date().getFullYear()),
      week: "01",
      games: [],
      picks: [] // { userId, name, email, picks }
    };

    const lc = (s) => String(s || "").toLowerCase();

    const el = (s) => document.querySelector(s);

    el("#signInBtn").onclick = async () => {
      const email = el("#email").value.trim();
      const pass = el("#pass").value;
      if (!email || !pass) { alert("Enter email and password."); return; }
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ alert(e.message || e); }
    };

    el("#signOutBtn").onclick = async () => { try{ await signOut(auth); } finally{ location.reload(); } };
    el("#refreshBtn").onclick = () => loadWeek();

    onAuthStateChanged(auth, async (user) => {
      if (!user){
        el("#auth").style.display = "block";
        el("#app").style.display = "none";
        el("#userTag").style.display = "none";
        el("#signOutBtn").style.display = "none";
        return;
      }
      el("#auth").style.display = "none";
      el("#app").style.display = "block";
      el("#userTag").style.display = "inline-flex";
      el("#userTag").textContent = user.email;
      el("#signOutBtn").style.display = "inline-flex";
      setupWeeks();
      await loadWeek();
    });

    function setupWeeks(){
      const sel = el("#weekSelect"); sel.innerHTML = "";
      for (let i=1;i<=18;i++){
        const o = document.createElement("option");
        o.value = String(i).padStart(2,"0"); o.textContent = `Week ${i}`;
        sel.appendChild(o);
      }
      const seasonInput = el("#seasonInput");
      const rememberedSeason = localStorage.getItem("everyoneSeason");
      if (rememberedSeason) state.season = rememberedSeason;
      const rememberedWeek = localStorage.getItem("everyoneWeekId");
      if (rememberedWeek) state.week = rememberedWeek;
      seasonInput.value = state.season;
      sel.value = state.week;
      seasonInput.onchange = () => {
        state.season = seasonInput.value.trim();
        localStorage.setItem("everyoneSeason", state.season);
      };
      sel.onchange = () => {
        state.week = sel.value;
        localStorage.setItem("everyoneWeekId", state.week);
        loadWeek();
      };
    }

    async function loadWeek(){
      setStatus("Loading…");
      await Promise.all([loadGames(), loadPicks()]);
      renderTable();
      setStatus(state.games.length ? "" : "No games found for this week.");
    }

    async function loadGames(){
      state.games = [];
      try{
        const q = query(collection(db, "seasons", state.season, "weeks", state.week, "games"), orderBy("kickoff", "asc"));
        const snap = await getDocs(q);
        snap.forEach(d => {
          const v = d.data();
          state.games.push({
            id: d.id,
            home: v.home || "",
            away: v.away || "",
            winner: v.winner || "",
            kickoff: v.kickoff?.toMillis ? v.kickoff.toMillis() : (v.kickoff || v.kickoffTs || null)
          });
        });
      }catch(e){ setStatus("Game load error: " + (e.message||e)); }
    }

    async function loadPicks(){
      state.picks = [];
      try{
        const snap = await getDocs(collection(db, "seasons", state.season, "weeks", state.week, "picks"));
        const byUser = new Map();
        snap.forEach(d => {
          const data = d.data() || {};
          const uid = data.userId || "unknown";
          const gameId = data.gameId || d.id.split("_")[1] || "";
          if (!gameId) return;
          const entry = byUser.get(uid) || { userId: uid, picks: {} };
          entry.picks[gameId] = data.pick || "";
          byUser.set(uid, entry);
        });

        const enriched = [];
        for (const entry of byUser.values()){
          let name = "";
          let email = "";
          try {
            const uDoc = await getDoc(doc(db, "users", entry.userId));
            if (uDoc.exists()){
              const u = uDoc.data() || {};
              name = u.displayName || u.userName || u.name || "";
              email = u.email || u.userEmail || "";
            }
          } catch {}
          enriched.push({ ...entry, name, email });
        }

        enriched.sort((a,b)=>{
          const aLabel = a.name || a.email || a.userId;
          const bLabel = b.name || b.email || b.userId;
          return aLabel.localeCompare(bLabel);
        });

        state.picks = enriched;
      }catch(e){ setStatus("Pick load error: " + (e.message||e)); }
    }

    function renderTable(){
      const wrap = el("#tableWrap");
      if (!state.games.length){ wrap.innerHTML = ""; return; }

      const headerCells = ["<th style='min-width:200px'>User</th>"];
      state.games.forEach((g, idx) => {
        const label = `${idx+1}. ${g.away} @ ${g.home}`;
        const win = g.winner ? `<div class='note'>Winner: ${g.winner}</div>` : "";
        headerCells.push(`<th style="min-width:160px">${label}${win}</th>`);
      });

      const rows = state.picks.map(({ name, email, userId, picks }) => {
        const label = name || email || userId || "(unknown)";
        const cells = [`<td>${label}</td>`];
        for (const g of state.games){
          const choice = picks[g.id];
          const chipLabel = choice || "No pick";
          const hasWinner = !!g.winner;
          const status = !choice ? "pending" : hasWinner ? (lc(g.winner) === lc(choice) ? "win" : "lose") : "pending";
          cells.push(`<td><span class="chip ${status}">${statusIcon(status)} ${chipLabel}</span></td>`);
        }
        return `<tr>${cells.join("")}</tr>`;
      });

      if (!rows.length){
        wrap.innerHTML = `<div class="muted">No picks submitted for this week yet.</div>`;
        return;
      }

      wrap.innerHTML = `
        <table>
          <thead><tr>${headerCells.join("")}</tr></thead>
          <tbody>${rows.join("")}</tbody>
        </table>
      `;
    }

    function statusIcon(status){
      if (status === "win") return "✅";
      if (status === "lose") return "❌";
      return "⏳";
    }

    function setStatus(msg){ el("#status").textContent = msg || ""; }
  </script>
</body>
</html>
