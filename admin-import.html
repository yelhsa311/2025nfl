<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Importer ‚Äî Games Only (v8.0)</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#141922; --panel-2:#1b2230;
      --text:#ebf0f7; --muted:#96a0b5; --accent:#5aa6ff;
      --danger:#ef4444; --ok:#22c55e; --chip:#0f1729;
      --input:#0f1420; --border:#232b3a; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    a{color:var(--accent); text-decoration:none}
    header{display:flex; gap:12px; align-items:center; padding:16px 20px; background:var(--panel);
      position:sticky; top:0; z-index:20; border-bottom:1px solid var(--border)}
    header .sp{flex:1} .role{border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--muted); font-size:12px}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:var(--panel); padding:12px; border:1px solid var(--border); border-radius:12px}
    .toolbar .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted)}
    input, select{background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px}
    button{background:#1a2434; color:#e8f0ff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    button.primary{background:var(--accent); color:#08101e; border-color:#3b82f6}
    button.btn-danger{background:var(--danger); color:white; border-color:#ef4444}
    .divider{width:2px; height:26px; background:var(--border); margin:0 6px; border-radius:2px}
    .table{margin-top:14px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel)}
    .thead, .trow{display:grid; grid-template-columns: 110px 220px 1fr 1fr 140px 90px; align-items:center; gap:8px; border-bottom:1px solid var(--border); padding:10px}
    .thead{background:var(--panel-2); color:var(--muted); font-weight:600}
    .trow:nth-child(2n){background:rgba(255,255,255,0.02)}
    .trow input, .trow select{width:100%}
    .right{display:flex; gap:8px; justify-content:flex-end}
    .status{color:var(--muted); margin-top:8px; font-size:13px}
    .card{margin-top:14px; border:1px solid var(--border); border-radius:12px; background:var(--panel); padding:12px}
    code{background:#0c111b; border:1px solid var(--border); padding:2px 6px; border-radius:8px}
    #debugList{font-size:13px; color:var(--muted); max-height:180px; overflow:auto}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.open{display:flex}
    .modal .sheet{width:min(960px, 96vw); max-height:92vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; position:relative}
    .modal h3{margin:0 0 8px 0}
    progress{width:100%; height:14px}
    #log{white-space:pre-wrap; background:#0c111b; border:1px solid var(--border);
      border-radius:10px; padding:10px; max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border:1px solid var(--border); padding:6px 8px}
    th{background:var(--panel-2); color:var(--muted)}
    .drop{border:1px dashed var(--border); border-radius:12px; padding:12px; text-align:center; background:#0c111b55}
    #openImportBtn{position:relative; z-index:3}
  </style>
</head>
<body>
  <header>
    <a href="./index.html" id="backLink">‚Üê Back to App</a>
    <strong>Admin Importer ‚Äî Games Only <span class="role" style="margin-left:8px">v8.0</span></strong>
    <div class="sp"></div>
    <div id="userTag" class="role">‚Ä¶</div>
    <div id="roleTag" class="role">ADMIN</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="group">
        <label>Season <input id="seasonInput" type="number" min="2000" max="2100" value="2025" style="width:96px"></label>
        <label>Week 
          <select id="weekSelect">
            <option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option><option value="4">Week 4</option>
            <option value="5">Week 5</option><option value="6">Week 6</option><option value="7">Week 7</option><option value="8">Week 8</option>
            <option value="9">Week 9</option><option value="10">Week 10</option><option value="11">Week 11</option><option value="12">Week 12</option>
            <option value="13">Week 13</option><option value="14">Week 14</option><option value="15">Week 15</option><option value="16">Week 16</option>
            <option value="17">Week 17</option><option value="18">Week 18</option><option value="19">Week 19</option><option value="20">Week 20</option>
            <option value="21">Week 21</option><option value="22">Week 22</option>
          </select>
        </label>
        <button id="refreshBtn" type="button">Refresh</button>
      </div>
      <span class="divider"></span>
      <div class="group">
        <label>Day
          <select id="dayInput">
            <option>Thursday</option><option>Friday</option><option selected>Sunday</option><option>Monday</option><option>Saturday</option>
          </select>
        </label>
        <label>Home <input id="homeInput" placeholder="Home team" style="min-width:180px"></label>
        <label>Away <input id="awayInput" placeholder="Away team" style="min-width:180px"></label>
        <label>Kickoff <input id="kickoffInput" type="datetime-local"></label>
        <button id="addGameBtn" type="button">+ Add game</button>
        <button id="saveChangesBtn" type="button" class="primary">Save Game Changes</button>
        <button id="openImportBtn" type="button">üì• Import Week (CSV)</button>
      </div>
    </div>

    <div class="table">
      <div class="thead">
        <div>Day</div><div>Kickoff</div><div>Home</div><div>Away</div><div>Winner</div><div class="right">Actions</div>
      </div>
      <div id="rows"></div>
    </div>

    <div id="status" class="status"></div>
    <div class="role" id="bootBadge" style="margin-top:6px; display:inline-block;">JS Loaded</div>

    <div class="card">
      <strong>Debug</strong>
      <div class="status">weekId: <code id="wid">‚Äî</code> ‚Ä¢ docs found: <code id="docCount">0</code></div>
      <div id="debugList"></div>
    </div>
  </div>

  <!-- Importer Modal -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex; align-items:center; gap:10px">
        <h3>Import Week ‚Äî Games Only</h3>
        <div class="sp"></div>
        <button id="closeImportBtn" type="button">Close</button>
      </div>
      <div class="card" style="margin-top:8px">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center">
          <label>Season <input id="impSeason" type="number" min="2000" max="2100" value="2025" style="width:120px"></label>
          <label>Week # <select id="impWeek"></select></label>
          <label><input id="impReplace" type="checkbox"> Replace games for this week (delete existing first)</label>
          <label><input id="impDry" type="checkbox"> Dry-run (no writes)</label>
          <label>CSV File <input id="impFile" type="file" accept=".csv"></label>
          <div class="role">CSV columns: day,kickoff_local,home,away,winner</div>
          <div><button id="genTplBtn" type="button">Generate template</button></div>
          <div class="sp"></div>
          <div><button id="impPreviewBtn" type="button">Preview</button> <button id="impRunBtn" type="button" class="primary">Import</button></div>
        </div>
        <div id="drop" class="drop" style="margin-top:10px">Drag & drop your CSV here (or use the file picker above)</div>
      </div>
      <div id="previewCard" class="card" style="display:none">
        <strong>Preview</strong>
        <div class="status" id="previewInfo"></div>
        <div style="max-height:360px; overflow:auto; margin-top:8px">
          <table id="previewTable"></table>
        </div>
      </div>
      <div class="card">
        <div class="status" id="impStatus">Idle.</div>
        <progress id="impProg" max="100" value="0" style="display:none"></progress>
        <details>
          <summary>Details / Logs</summary>
          <div id="log"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs (no modules) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    // ===== Utilities =====
    function $(sel){ return document.querySelector(sel); }
    function byId(id){ return document.getElementById(id); }
    const fmt2 = n => String(n).padStart(2,'0');
    const weekId = (season, w) => season + "-Week-" + fmt2(w);
    function toLocal(iso){ if(!iso) return ""; const d=new Date(iso);
      const y=d.getFullYear(), m=fmt2(d.getMonth()+1), da=fmt2(d.getDate()), h=fmt2(d.getHours()), mi=fmt2(d.getMinutes());
      return y+"-"+m+"-"+da+"T"+h+":"+mi;
    }
    function setStatus(m){ byId('status').textContent = m||""; }
    function impSetStatus(m){ byId('impStatus').textContent = m||""; }
    function impLog(m){ var L=byId('log'); L.textContent += (m+"\\n"); L.scrollTop=L.scrollHeight; }
    function impProg(v){ var el=byId('impProg'); el.style.display='block'; el.value=v; }

    // ===== State =====
    const state = { season:2025, weekNum:1, weekId:weekId(2025,1), games:[], parsed:null };
    for(let i=1;i<=22;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=i; byId('impWeek').appendChild(o); }
    byId('impWeek').value="1"; byId('weekSelect').value="1";

    // ===== Firebase init (compat) =====
    const cfg = {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.appspot.com",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754",
      measurementId: "G-MSJHYZ4VG2"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"];

    // ===== Auth gate =====
    auth.onAuthStateChanged(async function(user){
      if(!user){ location.replace('./index.html'); return; }
      if(ADMIN_UIDS.indexOf(user.uid)===-1){ alert("Admins only."); await auth.signOut(); location.replace('./index.html'); return; }
      byId('userTag').textContent = user.email || "";
      loadWeek();
    });

    // ===== UI wiring =====
    byId('seasonInput').addEventListener('change', function(){ state.season=Number(byId('seasonInput').value||2025); state.weekId=weekId(state.season,state.weekNum); loadWeek(); });
    byId('weekSelect').addEventListener('change', function(){ state.weekNum=Number(byId('weekSelect').value||1); state.weekId=weekId(state.season,state.weekNum); byId('impWeek').value=String(state.weekNum); loadWeek(); });
    byId('refreshBtn').addEventListener('click', loadWeek);
    byId('addGameBtn').addEventListener('click', addGame);
    byId('saveChangesBtn').addEventListener('click', saveChanges);
    byId('openImportBtn').addEventListener('click', function(){ byId('importModal').classList.add('open'); setTimeout(function(){ byId('impFile').focus(); }, 0); });
    byId('closeImportBtn').addEventListener('click', function(){ byId('importModal').classList.remove('open'); });
    byId('genTplBtn').addEventListener('click', generateTemplate);
    byId('impPreviewBtn').addEventListener('click', previewCsv);
    byId('impRunBtn').addEventListener('click', runImport);

    // Drag & drop
    (function(){
      var drop = byId('drop');
      ['dragenter','dragover'].forEach(function(evt){ drop.addEventListener(evt, function(e){ e.preventDefault(); drop.classList.add('drag'); }); });
      ['dragleave','drop'].forEach(function(evt){ drop.addEventListener(evt, function(e){ e.preventDefault(); drop.classList.remove('drag'); }); });
      drop.addEventListener('drop', function(e){
        var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        parseCsvFile(f).then(function(p){ state.parsed = p; if(p) renderPreview(p); });
      });
    })();

    // ===== Data =====
    async function loadWeek(){
      try{
        setStatus("Loading‚Ä¶"); byId('wid').textContent = state.weekId;
        const snap = await db.collection('games').where('weekId','==', state.weekId).get();
        state.games = [];
        snap.forEach(function(d){
          var g = d.data();
          state.games.push({ id:d.id, day:g.day||"", kickoff:g.kickoff||"", home:g.home||"", away:g.away||"", winner:g.winner||"" });
        });
        state.games.sort(function(a,b){ return new Date(a.kickoff)-new Date(b.kickoff); });
        renderGrid();
        byId('docCount').textContent = String(state.games.length);
        const list = state.games.slice(0,10).map(function(x){ return "‚Ä¢ " + x.home + " vs " + x.away + " (" + x.day + ")"; }).join('<br>');
        byId('debugList').innerHTML = list || '<em>No games</em>';
        setStatus("Week " + state.weekNum + " ‚Ä¢ " + state.games.length + " game(s)");
      }catch(err){ console.error(err); setStatus("Load error: " + (err.message||err)); }
    }

    function renderGrid(){
      var rows = byId('rows'); rows.innerHTML = "";
      state.games.forEach(function(g){ rows.appendChild(row(g)); });
    }
    function row(game){
      var node = document.createElement('div');
      node.className = 'trow';
      node.setAttribute('data-id', game.id);
      node.innerHTML = ''
        + '<input data-field="day" value="'+(game.day)+'" placeholder="Thursday">'
        + '<input data-field="kickoff" type="datetime-local" value="'+toLocal(game.kickoff)+'">'
        + '<input data-field="home" value="'+(game.home)+'" placeholder="Home team">'
        + '<input data-field="away" value="'+(game.away)+'" placeholder="Away team">'
        + '<select data-field="winner">'
        +   '<option value=""></option>'
        +   '<option value="home" '+(game.winner==="home"?"selected":"")+'>home</option>'
        +   '<option value="away" '+(game.winner==="away"?"selected":"")+'>away</option>'
        + '</select>'
        + '<div class="right"><button class="btn-danger" type="button" data-action="delete">Delete</button></div>';
      node.querySelector('[data-action="delete"]').addEventListener('click', async function(){
        if(!confirm("Delete this game?")) return;
        await db.collection('games').doc(game.id).delete();
        await loadWeek();
      });
      return node;
    }

    async function saveChanges(){
      var rows = Array.prototype.slice.call(document.querySelectorAll('.trow'));
      let count = 0;
      for(const r of rows){
        const id = r.getAttribute('data-id');
        const payload = {
          day: r.querySelector('[data-field="day"]').value.trim(),
          kickoff: r.querySelector('[data-field="kickoff"]').value ? new Date(r.querySelector('[data-field="kickoff"]').value).toISOString() : "",
          home: r.querySelector('[data-field="home"]').value.trim(),
          away: r.querySelector('[data-field="away"]').value.trim(),
          winner: r.querySelector('[data-field="winner"]').value || ""
        };
        await db.collection('games').doc(id).update(payload);
        count++;
      }
      setStatus("Saved " + count + " game(s).");
    }

    async function addGame(){
      const day = byId('dayInput').value;
      const home = byId('homeInput').value.trim();
      const away = byId('awayInput').value.trim();
      const kick = byId('kickoffInput').value;
      if(!home || !away || !kick){ alert("Fill Home, Away, Kickoff."); return; }
      const payload = { weekId: state.weekId, day, home, away, kickoff: new Date(kick).toISOString(), winner: "" };
      await db.collection('games').add(payload);
      byId('homeInput').value=""; byId('awayInput').value=""; byId('kickoffInput').value="";
      await loadWeek();
    }

    // ===== CSV/Import =====
    function parseAmPm(s){
      if(!s) return null;
      const t = String(s).trim();
      const parts = t.split(' ');
      if(parts.length < 2) return null;
      const datePart = parts[0].replace('-', '/');
      const timePart = parts[1];
      const ampm = (parts[2]||'').toLowerCase();
      const dBits = datePart.split('/');
      if(dBits.length !== 3) return null;
      let M = parseInt(dBits[0],10), D = parseInt(dBits[1],10), Y = parseInt(dBits[2],10);
      const tm = timePart.split(':');
      if(tm.length < 2) return null;
      let h = parseInt(tm[0],10), min = parseInt(tm[1],10);
      if(!isFinite(M)||!isFinite(D)||!isFinite(Y)||!isFinite(h)||!isFinite(min)) return null;
      if(Y<100) Y += 2000;
      const ap = ampm;
      const isPM = ap.indexOf('pm')>=0;
      const isAM = ap.indexOf('am')>=0;
      if(isPM && h<12) h+=12;
      if(isAM && h===12) h=0;
      const mm = String(M).padStart(2,'0'), dd = String(D).padStart(2,'0');
      const hh = String(h).padStart(2,'0'), mmin = String(min).padStart(2,'0');
      return Y+"-"+mm+"-"+dd+"T"+hh+":"+mmin+":00";
    }
    function toIso(localStr){
      if(!localStr) return "";
      const s = String(localStr).trim();
      const d1 = new Date(s.indexOf(' ')>=0 ? s.replace(' ','T') : s);
      if(!isNaN(d1.getTime())) return d1.toISOString();
      const alt = parseAmPm(s);
      if(alt){
        const d2 = new Date(alt);
        if(!isNaN(d2.getTime())) return d2.toISOString();
      }
      throw new Error("Invalid kickoff_local datetime: " + localStr);
    }
    function splitCsvLine(line, delim){
      var out=[], cur="", inQ=false, d=delim||',';
      for(var i=0;i<line.length;i++){
        var ch=line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else { inQ = !inQ; }
        } else if(ch === d && !inQ){
          out.push(cur); cur="";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(function(s){ return (s||'').trim(); });
    }
    async function parseCsvFile(file){
      if(!file){ alert("Pick a CSV file first or drop it into the box."); return null; }
      const raw = await file.text();
      impLog('Read CSV: ' + (file.name||'unnamed') + ' (' + raw.length + ' bytes)');
      let text = raw.split('\r\n').join('\n'); text = text.split('\r').join('\n');
      const linesAll = text.split('\n');
      const lines = linesAll.filter(function(l){ return (l||'').trim().length>0; });
      impLog('CSV diagnostics: bytes=' + raw.length + ', lines(raw)=' + linesAll.length + ', lines(trimmed)=' + lines.length);
      if(lines.length < 2){ alert("CSV has no data rows. Ensure header + at least one row."); return null; }
      const delim = (lines[0].indexOf(';')>=0 && lines[0].indexOf(',')<0) ? ';' : ',';
      const headers = splitCsvLine(lines[0], delim).map(function(s){ return s.toLowerCase(); });
      const expected = ["day","kickoff_local","home","away","winner"];
      for(var i=0;i<expected.length;i++){ if((headers[i]||"")!==expected[i]){ alert("Expected first columns: day,kickoff_local,home,away,winner"); return null; } }
      const games=[], rows=[];
      for(var li=1; li<lines.length; li++){
        const cols = splitCsvLine(lines[li], delim);
        if(cols.length===0) continue;
        const day = cols[0], kickoffLocal = cols[1], home = cols[2], away = cols[3], winner = cols[4]||"";
        if(!day && !home && !away) continue;
        const iso = toIso(kickoffLocal);
        games.push({ day:day, home:home, away:away, winner:winner.toLowerCase(), kickoffIso: iso });
        rows.push({ std:[day,kickoffLocal,home,away,winner] });
      }
      return { headers:headers, games:games, rows:rows };
    }
    function renderPreview(p){
      byId('previewInfo').textContent = "Games: " + p.games.length;
      const tbl = byId('previewTable'); tbl.innerHTML="";
      const trh = document.createElement("tr");
      ["day","kickoff_local","home","away","winner"].forEach(function(h){ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
      tbl.appendChild(trh);
      p.rows.forEach(function(r){ const tr=document.createElement("tr"); r.std.forEach(function(v){ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); }); tbl.appendChild(tr); });
      byId('previewCard').style.display="block";
    }
    async function previewCsv(){
      const f = byId('impFile').files[0];
      state.parsed = await parseCsvFile(f);
      if(state.parsed) renderPreview(state.parsed);
    }
    async function runImport(){
      try{
        if(!state.parsed){
          const f = byId('impFile').files[0];
          state.parsed = await parseCsvFile(f);
          if(!state.parsed) return;
        }
        const season = Number(byId('impSeason').value||2025);
        const wn = Number(byId('impWeek').value||1);
        const wid = weekId(season, wn);
        const replace = byId('impReplace').checked;
        const dry = byId('impDry').checked;

        impSetStatus("Importing‚Ä¶"); impLog("Import start for " + wid); impProg(1);

        if(replace){
          impSetStatus("Deleting existing games‚Ä¶"); impLog("Delete pass starting");
          const qs = await db.collection('games').where('weekId','==', wid).get();
          if(!dry){
            const bDel = db.batch();
            qs.forEach(function(d){ bDel.delete(db.collection('games').doc(d.id)); });
            await bDel.commit();
          }
          impLog("Deleted " + qs.size + " game(s)");
        }
        impProg(15);

        if(!dry){
          const bGames = db.batch();
          state.parsed.games.forEach(function(g){
            const ref = db.collection('games').doc();
            bGames.set(ref, { weekId: wid, day: g.day, home: g.home, away: g.away, winner: g.winner||"", kickoff: g.kickoffIso });
          });
          await bGames.commit();
        }
        impLog("Wrote " + state.parsed.games.length + " game(s)");
        impProg(100);
        impSetStatus("‚úÖ Import complete.");
        alert("Import complete!\\n\\nGames added: " + state.parsed.games.length + (dry ? "\\n\\n(DRY-RUN: no writes performed)" : ""));
        if(wid === state.weekId) await loadWeek();
      }catch(err){
        console.error(err); impSetStatus("‚ùå Import failed. See details below."); impLog(err && err.message ? err.message : String(err)); alert("Import failed: " + (err && err.message ? err.message : String(err)));
      }
    }
    function generateTemplate(){
      const csv = "day,kickoff_local,home,away,winner\n";
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download="week-template.csv"; document.body.appendChild(a); a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

  })();
  </script>
</body>
</html>
