<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Grid ‚Äî Importer (v5)</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#141922; --panel-2:#1b2230;
      --text:#ebf0f7; --muted:#96a0b5; --accent:#5aa6ff;
      --danger:#ef4444; --ok:#22c55e; --chip:#0f1729;
      --input:#0f1420; --border:#232b3a; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    a{color:var(--accent); text-decoration:none}
    header{display:flex; gap:12px; align-items:center; padding:16px 20px; background:var(--panel);
      position:sticky; top:0; z-index:20; border-bottom:1px solid var(--border)}
    header .sp{flex:1} .role{border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--muted); font-size:12px}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:var(--panel); padding:12px; border:1px solid var(--border); border-radius:12px}
    .toolbar .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted)}
    input, select{background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px}
    button{background:#1a2434; color:#e8f0ff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    button.primary{background:var(--accent); color:#08101e; border-color:#3b82f6}
    button.btn-danger{background:var(--danger); color:white; border-color:#ef4444}
    .divider{width:2px; height:26px; background:var(--border); margin:0 6px; border-radius:2px}
    .chip{display:inline-flex; flex-wrap:wrap; gap:8px; align-items:center; padding:10px; background:var(--panel); border:1px solid var(--border); border-radius:12px; margin-top:10px}
    .table{margin-top:14px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel)}
    .thead, .trow{display:grid; grid-template-columns: 110px 200px 1fr 1fr 120px 150px 90px; align-items:center; gap:8px; border-bottom:1px solid var(--border); padding:10px}
    .thead{background:var(--panel-2); color:var(--muted); font-weight:600}
    .trow:nth-child(2n){background:rgba(255,255,255,0.02)}
    .trow input, .trow select{width:100%}
    .right{display:flex; gap:8px; justify-content:flex-end}
    .status{color:var(--muted); margin-top:8px; font-size:13px}
    .note{color:var(--muted); font-size:12px}
    .card{margin-top:14px; border:1px solid var(--border); border-radius:12px; background:var(--panel); padding:12px}
    code{background:#0c111b; border:1px solid var(--border); padding:2px 6px; border-radius:8px}
    #debugList{font-size:13px; color:var(--muted); max-height:180px; overflow:auto}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.open{display:flex}
    .modal .sheet{width:min(960px, 96vw); max-height:92vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px}
    .modal h3{margin:0 0 8px 0}
    progress{width:100%; height:14px}
    #log{white-space:pre-wrap; background:#0c111b; border:1px solid var(--border);
      border-radius:10px; padding:10px; max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border:1px solid var(--border); padding:6px 8px}
    th{background:var(--panel-2); color:var(--muted)}
    .warn{color:#f59e0b}
  </style>
</head>
<body>
  <header>
    <a href="./index.html">‚Üê Back to App</a>
    <strong>Admin Grid ‚Äî Importer</strong>
    <div class="sp"></div>
    <div id="userTag" class="role">‚Ä¶</div>
    <div id="roleTag" class="role">ADMIN</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="group">
        <label>Season <input id="seasonInput" type="number" min="2000" max="2100" value="2025" style="width:96px"></label>
        <label>Week 
          <select id="weekSelect">
            <option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option><option value="4">Week 4</option>
            <option value="5">Week 5</option><option value="6">Week 6</option><option value="7">Week 7</option><option value="8">Week 8</option>
            <option value="9">Week 9</option><option value="10">Week 10</option><option value="11">Week 11</option><option value="12">Week 12</option>
            <option value="13">Week 13</option><option value="14">Week 14</option><option value="15">Week 15</option><option value="16">Week 16</option>
            <option value="17">Week 17</option><option value="18">Week 18</option><option value="19">Week 19</option><option value="20">Week 20</option>
            <option value="21">Week 21</option><option value="22">Week 22</option>
          </select>
        </label>
        <button id="refreshBtn">Refresh</button>
      </div>
      <span class="divider"></span>
      <div class="group">
        <label>Day
          <select id="dayInput">
            <option>Thursday</option><option>Friday</option><option selected>Sunday</option><option>Monday</option><option>Saturday</option>
          </select>
        </label>
        <label>Home <input id="homeInput" placeholder="Home team" style="min-width:180px"></label>
        <label>Away <input id="awayInput" placeholder="Away team" style="min-width:180px"></label>
        <label>Kickoff <input id="kickoffInput" type="datetime-local"></label>
        <button id="addGameBtn">+ Add game</button>
        <button id="saveChangesBtn" class="primary">Save Game Changes</button>
      </div>
      <span class="divider"></span>
      <div class="group">
        <label>User email
          <input id="userEmail" style="min-width:260px" placeholder="email@example.com">
        </label>
        <button id="loadUserBtn">Load</button>
        <button id="saveUserBtn" class="primary">Save Picks</button>
        <button id="setUidBtn" title="Manually set UID mapping for this email">Set UID</button>
        <button id="openImportBtn">üì• Import Week</button>
      </div>
    </div>

    <div class="chip">
      <strong>User Picks:</strong>
      <button id="fillBlanksHomeBtn">Blanks ‚Üí home</button>
      <button id="fillBlanksAwayBtn">Blanks ‚Üí away</button>
      <button id="allHomeBtn">All ‚Üí home</button>
      <button id="allAwayBtn">All ‚Üí away</button>
      <button id="clearUserBtn" class="btn-danger">Clear</button>
      <span class="note">Load a user first. If header says <span class="warn">UID not found</span>, click ‚ÄúSet UID‚Äù.</span>
    </div>

    <div class="table">
      <div class="thead">
        <div>Day</div><div>Kickoff</div><div>Home</div><div>Away</div><div>Winner</div><div id="pickHeader">Pick (load user)</div><div class="right">Actions</div>
      </div>
      <div id="rows"></div>
    </div>

    <div id="status" class="status"></div>

    <div class="card">
      <strong>Debug</strong>
      <div class="status">weekId: <code id="wid">‚Äî</code> ‚Ä¢ docs found: <code id="docCount">0</code></div>
      <div id="debugList"></div>
    </div>
  </div>

  <div id="importModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex; align-items:center; gap:10px">
        <h3>Import Week & Picks</h3>
        <div class="sp"></div>
        <button id="closeImportBtn">Close</button>
      </div>
      <div class="card" style="margin-top:8px">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center">
          <label>Season <input id="impSeason" type="number" min="2000" max="2100" value="2025" style="width:120px"></label>
          <label>Week #
            <select id="impWeek"></select>
          </label>
          <label><input id="impReplace" type="checkbox"> Replace games for this week (delete existing first)</label>
          <label><input id="impDry" type="checkbox"> Dry-run (no writes)</label>
          <label>CSV File <input id="impFile" type="file" accept=".csv"></label>
          <div class="note">CSV: day, kickoff_local (YYYY-MM-DD HH:MM), home, away, winner, then 1 column per user email with 'home'/'away' values.</div>
          <div><a href="/week-template.csv" download>Download template</a></div>
          <div class="sp"></div>
          <div><button id="impPreviewBtn">Preview</button> <button id="impRunBtn" class="primary">Import</button></div>
        </div>
      </div>
      <div id="previewCard" class="card" style="display:none">
        <strong>Preview</strong>
        <div class="status" id="previewInfo"></div>
        <div style="max-height:360px; overflow:auto; margin-top:8px">
          <table id="previewTable"></table>
        </div>
      </div>
      <div class="card">
        <div class="status" id="impStatus">Idle.</div>
        <progress id="impProg" max="100" value="0" style="display:none"></progress>
        <details>
          <summary>Details / Logs</summary>
          <div id="log"></div>
        </details>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { 
      initializeFirestore, getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, limit, serverTimestamp, writeBatch 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const cfg = {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.appspot.com",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754",
      measurementId: "G-MSJHYZ4VG2"
    };
    const app = initializeApp(cfg);
    initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
    const auth = getAuth(app);
    const db = getFirestore(app);

    setPersistence(auth, browserLocalPersistence).catch((e)=>console.warn('persistence set failed', e));

    const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"];
    const fmt2 = n => String(n).padStart(2,'0');
    const weekId = (season, w) => `${season}-Week-${fmt2(w)}`;
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);
    const escapeHtml = s => (s??"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&gt;','"':'&quot;'}[c]));
    const uidFromEmail = email => (email||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").slice(0,64);

    const state = { 
      season: 2025, weekNum: 1, weekId: weekId(2025,1), games: [],
      currentUser: "", currentUid: "", picksByUser: new Map(),
      parsed: null
    };

    byId('weekSelect').value="1";
    for(let i=1;i<=22;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=i; byId('impWeek').appendChild(o); }
    byId('impWeek').value="8";

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.replace('./index.html'); return; }
      if(!ADMIN_UIDS.includes(user.uid)){ alert("Admins only."); await signOut(auth); location.replace('./index.html'); return; }
      byId('userTag').textContent = user.email || "";
      await loadWeek();
    });

    byId('seasonInput').addEventListener('change', ()=>{ state.season=Number(byId('seasonInput').value||2025); state.weekId=weekId(state.season,state.weekNum); loadWeek(); });
    byId('weekSelect').addEventListener('change', ()=>{ state.weekNum=Number(byId('weekSelect').value||1); state.weekId=weekId(state.season,state.weekNum); loadWeek(); });
    byId('refreshBtn').addEventListener('click', loadWeek);
    byId('addGameBtn').addEventListener('click', addGame);
    byId('saveChangesBtn').addEventListener('click', saveChanges);

    byId('loadUserBtn').addEventListener('click', onLoadUser);
    byId('saveUserBtn').addEventListener('click', saveSelectedUser);
    byId('fillBlanksHomeBtn').addEventListener('click', ()=> fillUserPicks("home", true));
    byId('fillBlanksAwayBtn').addEventListener('click', ()=> fillUserPicks("away", true));
    byId('allHomeBtn').addEventListener('click', ()=> fillUserPicks("home", false));
    byId('allAwayBtn').addEventListener('click', ()=> fillUserPicks("away", false));
    byId('clearUserBtn').addEventListener('click', clearUserPicks);

    byId('openImportBtn').addEventListener('click', ()=> { $("#importModal").classList.add("open"); });
    byId('closeImportBtn').addEventListener('click', ()=> { $("#importModal").classList.remove("open"); });
    byId('impPreviewBtn').addEventListener('click', async ()=>{ state.parsed = await parseCsvFile(byId('impFile').files[0]); if(state.parsed){ renderPreview(state.parsed); } });
    byId('impRunBtn').addEventListener('click', runImport);

    async function onLoadUser(){
      const email = (byId('userEmail').value||"").trim().toLowerCase();
      if (!email) { alert("Enter a user email first."); return; }
      byId('pickHeader').textContent = `Pick (${email}) ‚Äî resolving‚Ä¶`;
      const uid = await resolveUidForEmail(email);
      state.currentUser = email;
      state.currentUid = uid || "";
      byId('pickHeader').textContent = uid ? `Pick (${email})` : `Pick (${email}) ‚Äî UID not found`;
      await loadWeek();
      setStatus(`Loaded user: ${email}${uid ? ` (uid:${uid})` : ""}`);
    }

    async function resolveUidForEmail(email){
      const q1 = query(collection(db, "publicUsers"), where("emailLower", "==", email), limit(1));
      const s1 = await getDocs(q1);
      if (s1.size > 0) return s1.docs[0].id;
      const q2 = query(collection(db, "publicUsers"), where("email", "==", email), limit(1));
      const s2 = await getDocs(q2);
      if (s2.size > 0) return s2.docs[0].id;
      return null;
    }

    async function loadWeek(){
      setStatus("Loading‚Ä¶");
      byId('wid').textContent = state.weekId;
      const q = query(collection(db, "games"), where("weekId", "==", state.weekId));
      const snap = await getDocs(q);
      state.games = [];
      snap.forEach(d=>{
        const g = d.data();
        state.games.push({ id: d.id, day: g.day||"", kickoff: g.kickoff||"", home: g.home||"", away: g.away||"", winner: g.winner||"" });
      });
      state.games.sort((a,b)=> new Date(a.kickoff) - new Date(b.kickoff));

      state.picksByUser.clear();
      if(state.currentUser){
        let picks = {};
        if(state.currentUid){
          const pRef = doc(db, "picks", state.currentUid, "weeks", state.weekId);
          const psnap = await getDoc(pRef);
          if(psnap.exists()) picks = psnap.data().picks || {};
        } else {
          const legacyId = uidFromEmail(state.currentUser);
          const pRefLegacy = doc(db, "picks", legacyId, "weeks", state.weekId);
          const psnapLegacy = await getDoc(pRefLegacy);
          if(psnapLegacy.exists()) picks = psnapLegacy.data().picks || {};
        }
        state.picksByUser.set(state.currentUser, picks);
      }

      renderGrid();
      byId('docCount').textContent = String(state.games.length);
      const list = state.games.slice(0,10).map(x=>`‚Ä¢ ${x.home} vs ${x.away} (${x.day})`).join('<br>');
      byId('debugList').innerHTML = list || '<em>No games</em>';
      setStatus(`Adds to ${state.weekId} ‚Ä¢ ${state.games.length} game(s)`);
    }

    function renderGrid(){
      const rows = byId('rows'); rows.innerHTML = "";
      for(const g of state.games){
        rows.appendChild(row(g));
      }
    }

    function row(game){
      const picks = state.currentUser ? (state.picksByUser.get(state.currentUser) || {}) : {};
      const userPick = picks[game.id] || "";
      const pickDisabled = state.currentUser ? "" : "disabled";
      const node = document.createElement('div');
      node.className = 'trow';
      node.setAttribute('data-id', game.id);
      node.innerHTML = `
        <input data-field="day" value="${escapeHtml(game.day)}" placeholder="Thursday">
        <input data-field="kickoff" type="datetime-local" value="${toLocal(game.kickoff)}">
        <input data-field="home" value="${escapeHtml(game.home)}" placeholder="Home team">
        <input data-field="away" value="${escapeHtml(game.away)}" placeholder="Away team">
        <select data-field="winner">
          <option value=""></option>
          <option value="home" ${game.winner==="home"?"selected":""}>home</option>
          <option value="away" ${game.winner==="away"?"selected":""}>away</option>
        </select>
        <select data-field="pick" ${pickDisabled}>
          <option value=""></option>
          <option value="home" ${userPick==="home"?"selected":""}>home</option>
          <option value="away" ${userPick==="away"?"selected":""}>away</option>
        </select>
        <div class="right">
          <button class="btn-danger" data-action="delete">Delete</button>
        </div>`;
      node.querySelector('[data-action="delete"]').addEventListener('click', async ()=>{
        if(!confirm("Delete this game?")) return;
        await deleteDoc(doc(db, "games", game.id));
        await loadWeek();
      });
      const pickSel = node.querySelector('select[data-field="pick"]');
      if(pickSel){
        pickSel.addEventListener('change', ()=>{
          ensurePickMap();
          const pm = state.picksByUser.get(state.currentUser);
          pm[game.id] = pickSel.value || "";
        });
      }
      return node;
    }

    function ensurePickMap(){
      if(!state.currentUser) return;
      if(!state.picksByUser.has(state.currentUser)){
        state.picksByUser.set(state.currentUser, {});
      }
    }

    async function saveChanges(){
      const rows = [...document.querySelectorAll('.trow')];
      let count = 0;
      for(const r of rows){
        const id = r.getAttribute('data-id');
        const payload = {
          day: r.querySelector('[data-field="day"]').value.trim(),
          kickoff: r.querySelector('[data-field="kickoff"]').value ? new Date(r.querySelector('[data-field="kickoff"]').value).toISOString() : "",
          home: r.querySelector('[data-field="home"]').value.trim(),
          away: r.querySelector('[data-field="away"]').value.trim(),
          winner: r.querySelector('[data-field="winner"]').value || ""
        };
        await updateDoc(doc(db,"games", id), payload);
        count++;
      }
      setStatus(`Saved ${count} game(s).`);
    }

    async function addGame(){
      const day = byId('dayInput').value;
      const home = byId('homeInput').value.trim();
      const away = byId('awayInput').value.trim();
      const kick = byId('kickoffInput').value;
      if(!home || !away || !kick){ alert("Fill Home, Away, Kickoff."); return; }
      const payload = { weekId: state.weekId, day, home, away, kickoff: new Date(kick).toISOString(), winner: "" };
      await addDoc(collection(db,"games"), payload);
      byId('homeInput').value=""; byId('awayInput').value=""; byId('kickoffInput').value="";
      await loadWeek();
    }

    function getSelectedUserEmail(){
      if(!state.currentUser){
        alert("Load a user first.");
        return "";
      }
      return state.currentUser;
    }

    function fillUserPicks(val, blanksOnly){
      const email = getSelectedUserEmail(); if(!email) return;
      ensurePickMap();
      const pm = state.picksByUser.get(email);
      for(const g of state.games){
        if(blanksOnly && pm[g.id]) continue;
        pm[g.id] = val;
      }
      renderGrid();
    }

    function clearUserPicks(){
      const email = getSelectedUserEmail(); if(!email) return;
      ensurePickMap();
      const pm = state.picksByUser.get(email);
      for(const g of state.games){ pm[g.id] = ""; }
      renderGrid();
    }

    async function saveSelectedUser(){
      const email = getSelectedUserEmail(); if(!email) return;
      ensurePickMap();
      const picks = state.picksByUser.get(email) || {};

      if (!state.currentUid){
        if (!confirm("No UID found for this email.
Save to legacy email-slug path (main app may not see it)?")) return;
        const legacyId = uidFromEmail(email);
        const pRefLegacy = doc(db, "picks", legacyId, "weeks", state.weekId);
        await setDoc(pRefLegacy, { picks, savedAt: serverTimestamp() }, { merge: true });
        setStatus(`Saved (legacy) picks for ${email}.`);
        return;
      }

      const pRef = doc(db, "picks", state.currentUid, "weeks", state.weekId);
      await setDoc(pRef, { picks, savedAt: serverTimestamp() }, { merge: true });
      setStatus(`Saved picks for ${email}.`);
    }

    function toLocal(iso){
      if(!iso) return "";
      const d = new Date(iso);
      const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0');
      const h=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${da}T${h}:${mi}`;
    }

    function setStatus(m){ byId('status').textContent = m || ""; }

    /* ===== Importer logic ===== */
    function impSetStatus(m){ byId('impStatus').textContent = m||""; }
    function impLog(m){ const L=byId('log'); L.textContent += (m + "\n"); L.scrollTop=L.scrollHeight; }
    function impProg(p){ const el=byId('impProg'); el.style.display='block'; el.value=p; }

    function renderPreview(p){
      byId('previewInfo').textContent = `Games: ${p.games.length} ‚Ä¢ Users: ${p.users.length}`;
      const tbl = byId('previewTable');
      tbl.innerHTML = "";
      const trh = document.createElement("tr");
      ["day","kickoff_local","home","away","winner", ...p.users].forEach(h=>{
        const th=document.createElement("th"); th.textContent=h; trh.appendChild(th);
      });
      tbl.appendChild(trh);
      for(const r of p.rows){
        const tr=document.createElement("tr");
        [...r.std, ...r.userVals].forEach(v=>{ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); });
        tbl.appendChild(tr);
      }
      byId('previewCard').style.display = "block";
    }

    async function runImport(){
      if(!state.parsed){ alert("Preview the CSV first."); return; }
      const season = Number(byId('impSeason').value||2025);
      const wn = Number(byId('impWeek').value||1);
      const wid = weekId(season, wn);
      const replace = byId('impReplace').checked;
      const dry = byId('impDry').checked;

      impSetStatus("Importing‚Ä¶"); impLog(`Import start for ${wid}`); impProg(1);

      try{
        const uidMap = {};
        for(const email of state.parsed.users){
          const uid = await resolveUidForEmail(email);
          uidMap[email] = uid || "";
        }
        impLog(`Resolved ${Object.values(uidMap).filter(Boolean).length}/${state.parsed.users.length} user UIDs`);

        if(replace){
          impSetStatus("Deleting existing games‚Ä¶"); impLog("Delete pass starting");
          const qs = query(collection(db,"games"), where("weekId","==", wid));
          const snap = await getDocs(qs);
          if(!dry){
            const bDel = writeBatch(db);
            snap.forEach(d=> bDel.delete(doc(db,"games", d.id)));
            await bDel.commit();
          }
          impLog(`Deleted ${snap.size} game(s)`);
        }
        impProg(10);

        const gameIds = [];
        if(!dry){
          const bGames = writeBatch(db);
          for(const g of state.parsed.games){
            const ref = doc(collection(db,"games"));
            gameIds.push(ref.id);
            bGames.set(ref, { weekId: wid, day: g.day, home: g.home, away: g.away, winner: g.winner||"", kickoff: g.kickoffIso });
          }
          await bGames.commit();
        } else {
          for(let i=0;i<state.parsed.games.length;i++) gameIds.push(`SIM_${i}`);
        }
        impLog(`Wrote ${state.parsed.games.length} game(s)`);
        impProg(60);

        let ucount = 0;
        for(const email of state.parsed.users){
          const picksArr = state.parsed.picksByUser[email] || [];
          const pm = {};
          for(let i=0;i<gameIds.length;i++){
            const choice = (picksArr[i]||"").toLowerCase();
            if(choice==="home" || choice==="away"){ pm[gameIds[i]] = choice; }
          }
          const uid = uidMap[email];
          if(!dry){
            if(uid){
              const pRef = doc(db, "picks", uid, "weeks", wid);
              await setDoc(pRef, { picks: pm, savedAt: serverTimestamp() }, { merge: true });
            } else {
              const legacyId = uidFromEmail(email);
              const pRefLegacy = doc(db, "picks", legacyId, "weeks", wid);
              await setDoc(pRefLegacy, { picks: pm, savedAt: serverTimestamp() }, { merge: true });
            }
          }
          ucount++;
          if(ucount % 5 === 0) impProg(60 + Math.min(35, Math.floor(35*(ucount/state.parsed.users.length))));
        }
        impLog(`Updated ${state.parsed.users.length} user(s)`);
        impProg(100);
        impSetStatus("‚úÖ Import complete.");
        alert(`Import complete!\n\nGames added: ${state.parsed.games.length}\nUsers updated: ${state.parsed.users.length}${dry?'\n\n(DRY-RUN: no writes performed)':''}`);

        if(wid === state.weekId) await loadWeek();
      }catch(err){
        console.error(err);
        impSetStatus("‚ùå Import failed. See details below.");
        impLog(err?.message || String(err));
        alert("Import failed: " + (err?.message || String(err)));
      }
    }

    async function parseCsvFile(file){
      if(!file){ alert("Pick a CSV file first."); return null; }
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
      if(lines.length<2){ alert("CSV has no data rows."); return null; }
      const headers = splitCsvLine(lines[0]).map(s=>s.trim());
      const std = ["day","kickoff_local","home","away","winner"];
      for(let i=0;i<std.length;i++){
        if((headers[i]||"").toLowerCase()!==std[i]){
          alert("Expected first columns: day,kickoff_local,home,away,winner");
          return null;
        }
      }
      const users = headers.slice(std.length).map(h=>h.trim().toLowerCase()).filter(Boolean);
      if(users.length===0){ alert("No user columns found after 'winner'."); return null; }

      const games = [];
      const rows = [];
      const picksByUser = Object.fromEntries(users.map(u=>[u,[]]));

      for(let li=1; li<lines.length; li++){
        const cols = splitCsvLine(lines[li]);
        if(cols.length===0) continue;
        const [day, kickoffLocal, home, away, winner, ...userVals] = cols;
        if(!day && !home && !away) continue;
        const iso = toIso(kickoffLocal);
        games.push({ day, home, away, winner: (winner||"").toLowerCase(), kickoffIso: iso });
        rows.push({ std:[day,kickoffLocal,home,away,winner], userVals });
        users.forEach((u, idx)=>{
          const v = (userVals[idx]||"").toLowerCase();
          picksByUser[u].push(v);
        });
      }

      return { headers, users, games, picksByUser, rows };
    }

    function toIso(localStr){
      if(!localStr) return "";
      const s = localStr.trim().replace(" ","T");
      const d = new Date(s);
      if(isNaN(d.getTime())){ throw new Error("Invalid kickoff_local datetime: " + localStr); }
      return d.toISOString();
    }

    function splitCsvLine(line){
      const out=[]; let cur=""; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch=='"'){ 
          if(inQ && line[i+1]=='"'){ cur+='"'; i++; }
          else inQ=!inQ;
        } else if(ch=="," && !inQ){ out.push(cur); cur=""; }
        else cur+=ch;
      }
      out.push(cur);
      return out.map(s=>s.trim());
    }
  </script>
</body>
</html>
