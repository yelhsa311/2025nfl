<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Importer ‚Äî Games Only (v21.2)</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#141922; --panel-2:#1b2230;
      --text:#ebf0f7; --muted:#96a0b5; --accent:#5aa6ff;
      --danger:#ef4444; --ok:#22c55e; --chip:#0f1729;
      --input:#0f1420; --border:#232b3a; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    a{color:var(--accent); text-decoration:none}
    header{display:flex; gap:12px; align-items:center; padding:16px 20px; background:var(--panel);
      position:sticky; top:0; z-index:20; border-bottom:1px solid var(--border)}
    header .sp{flex:1} .role{border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--muted); font-size:12px}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:var(--panel); padding:12px; border:1px solid var(--border); border-radius:12px}
    .toolbar .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{display:flex; align-items:center; gap:6px; font-size:14px; color:var(--muted)}
    input, select{background:var(--input); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px}
    button{background:#1a2434; color:#e8f0ff; border:1px solid var(--border); padding:8px 12px; border-radius:10px; cursor:pointer}
    button.primary{background:var(--accent); color:#08101e; border-color:#3b82f6}
    button.btn-danger{background:var(--danger); color:white; border-color:#ef4444}
    .divider{width:2px; height:26px; background:var(--border); margin:0 6px; border-radius:2px}
    .table{margin-top:14px; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel)}
    .thead, .trow{display:grid; grid-template-columns: 110px 220px 1fr 1fr 140px 90px; align-items:center; gap:8px; border-bottom:1px solid var(--border); padding:10px}
    .thead{background:var(--panel-2); color:var(--muted); font-weight:600}
    .trow:nth-child(2n){background:rgba(255,255,255,0.02)}
    .trow input, .trow select{width:100%}
    .right{display:flex; gap:8px; justify-content:flex-end}
    .status{color:var(--muted); margin-top:8px; font-size:13px}
    .card{margin-top:14px; border:1px solid var(--border); border-radius:12px; background:var(--panel); padding:12px}
    code{background:#0c111b; border:1px solid var(--border); padding:2px 6px; border-radius:8px}
    #debugList{font-size:13px; color:var(--muted); max-height:180px; overflow:auto}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.open{display:flex}
    .modal .sheet{width:min(960px, 96vw); max-height:92vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; position:relative}
    .modal h3{margin:0 0 8px 0}
    progress{width:100%; height:14px}
    #log{white-space:pre-wrap; background:#0c111b; border:1px solid var(--border);
      border-radius:10px; padding:10px; max-height:220px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border:1px solid var(--border); padding:6px 8px}
    th{background:var(--panel-2); color:var(--muted)}
    .drop{border:1px dashed var(--border); border-radius:12px; padding:12px; text-align:center; background:#0c111b55}
    #openImportBtn{position:relative; z-index:3}
  </style>
</head>
<body>
  <header>
    <a href="./picks.html" id="backLink">‚Üê Back to App</a>
    <strong>Admin Importer ‚Äî Games Only <span class="role" style="margin-left:8px">v21.2</span></strong>
    <div class="sp"></div>
    <div id="userTag" class="role">‚Ä¶</div>
    <div id="roleTag" class="role">ADMIN</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="group">
        <label>Season <input id="seasonInput" type="number" min="2000" max="2100" value="2025" style="width:96px"></label>
        <label>Week 
          <select id="weekSelect">
            <option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option><option value="4">Week 4</option>
            <option value="5">Week 5</option><option value="6">Week 6</option><option value="7">Week 7</option><option value="8">Week 8</option>
            <option value="9">Week 9</option><option value="10">Week 10</option><option value="11">Week 11</option><option value="12">Week 12</option>
            <option value="13">Week 13</option><option value="14">Week 14</option><option value="15">Week 15</option><option value="16">Week 16</option>
            <option value="17">Week 17</option><option value="18">Week 18</option><option value="19">Week 19</option><option value="20">Week 20</option>
            <option value="21">Week 21</option><option value="22">Week 22</option>
          </select>
        </label>
        <button id="refreshBtn" type="button">Refresh</button>
      </div>
      <span class="divider"></span>
      <div class="group">
        <label>Day
          <select id="dayInput">
            <option>Thursday</option><option>Friday</option><option selected>Sunday</option><option>Monday</option><option>Saturday</option>
          </select>
        </label>
        <label>Home <input id="homeInput" placeholder="Home team" style="min-width:180px"></label>
        <label>Away <input id="awayInput" placeholder="Away team" style="min-width:180px"></label>
        <label>Kickoff <input id="kickoffInput" type="datetime-local"></label>
        <button id="addGameBtn" type="button">+ Add game</button>
        <button id="saveChangesBtn" type="button" class="primary">Save Game Changes</button>
        <button id="openImportBtn" type="button">üì• Import Week (CSV)</button>
      </div>
    </div>

    <div class="table">
      <div class="thead">
        <div>Day</div><div>Kickoff</div><div>Home</div><div>Away</div><div>Winner</div><div class="right">Actions</div>
      </div>
      <div id="rows"></div>
    </div>

    <div id="status" class="status"></div>
    <div class="role" id="bootBadge" style="margin-top:6px; display:inline-block;">JS Loaded</div>

    <div class="card">
      <strong>Debug</strong>
      <div class="status">weekId: <code id="wid">‚Äî</code> ‚Ä¢ docs found: <code id="docCount">0</code></div>
      <div id="debugList"></div>
    </div>
  </div>

  <!-- Importer Modal -->
  <div id="importModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex; align-items:center; gap:10px">
        <h3>Import Week ‚Äî Games Only</h3>
        <div class="sp"></div>
        <button id="closeImportBtn" type="button">Close</button>
      </div>
      <div class="card" style="margin-top:8px">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center">
          <label>Season <input id="impSeason" type="number" min="2000" max="2100" value="2025" style="width:120px"></label>
          <label>Week # <select id="impWeek"></select></label>
          <label>CSV File <input id="impFile" type="file" accept=".csv"></label>
          <div class="role">Step 1: choose a CSV. Step 2: Preview or Import. Import will delete any existing games for the selected week before writing the new ones.</div>
          <div class="role">CSV columns: day,kickoff_date,kickoff_time,home,away,winner (kickoff_local also accepted)</div>
          <div><button id="genTplBtn" type="button">Generate template</button></div>
          <div class="sp"></div>
          <div><button id="impPreviewBtn" type="button">Preview</button> <button id="impRunBtn" type="button" class="primary">Import</button></div>
        </div>
        <div id="drop" class="drop" style="margin-top:10px">Drag & drop your CSV here (or use the file picker above)</div>
      </div>
      <div id="previewCard" class="card" style="display:none">
        <strong>Preview</strong>
        <div class="status" id="previewInfo"></div>
        <div style="max-height:360px; overflow:auto; margin-top:8px">
          <table id="previewTable"></table>
        </div>
      </div>
      <div class="card">
        <div class="status" id="impStatus">Idle.</div>
        <progress id="impProg" max="100" value="0" style="display:none"></progress>
        <details>
          <summary>Details / Logs</summary>
          <div id="log"></div>
        </details>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs (no modules) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    // ===== Utilities =====
    function $(sel){ return document.querySelector(sel); }
    function byId(id){ return document.getElementById(id); }
    const fmt2 = n => String(n).padStart(2,'0');
    const weekId = (season, w) => season + "-Week-" + fmt2(w);
    const slug = s => (s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    const uidFromEmail = email => slug(email).slice(0,64);
    function withTimeout(promise, label, timeoutMs){
      const ms = Math.max(1000, timeoutMs||120000);
      const tag = label || 'Operation';
      let timer;
      return Promise.race([
        promise.finally(function(){ clearTimeout(timer); }),
        new Promise(function(_resolve, reject){
          timer = setTimeout(function(){ reject(new Error(tag + ' timed out after ' + Math.round(ms/1000) + 's')); }, ms);
        })
      ]);
    }
    function toLocal(iso){ if(!iso) return ""; const d=new Date(iso);
      const y=d.getFullYear(), m=fmt2(d.getMonth()+1), da=fmt2(d.getDate()), h=fmt2(d.getHours()), mi=fmt2(d.getMinutes());
      return y+"-"+m+"-"+da+"T"+h+":"+mi;
    }
    function partsFromIso(iso){
      if(!iso) return { date:"", time:"" };
      const d = new Date(iso);
      if(isNaN(d.getTime())) return { date:"", time:"" };
      const date = [fmt2(d.getMonth()+1), fmt2(d.getDate()), d.getFullYear()].join('/');
      const time = fmt2(d.getHours()) + ':' + fmt2(d.getMinutes());
      return { date, time };
    }
    function setStatus(m){ byId('status').textContent = m||""; }
    function impSetStatus(m){ byId('impStatus').textContent = m||""; }
    function impLog(m){ var L=byId('log'); L.textContent += (m+"\\n"); L.scrollTop=L.scrollHeight; }
    function impProg(v){ var el=byId('impProg'); el.style.display='block'; el.value=v; }
    function impProgDone(){ var el=byId('impProg'); el.style.display='none'; el.value=0; }
    function impClearLog(){ var L=byId('log'); L.textContent=''; }
    function setImportBusy(isBusy){
      ['impRunBtn','impPreviewBtn','impFile','genTplBtn','openImportBtn'].forEach(function(id){
        const el = byId(id);
        if (el){ el.disabled = !!isBusy; }
      });
      state.importing = !!isBusy;
    }
    function hidePreview(){
      byId('previewCard').style.display = 'none';
      byId('previewTable').innerHTML = '';
      byId('previewInfo').textContent = '';
    }
    function resetImportUi(message){
      state.parsed = null;
      hidePreview();
      impClearLog();
      impProgDone();
      impSetStatus(message || '');
    }

    // ===== State =====
    const state = { season:2025, weekNum:1, weekId:weekId(2025,1), games:[], parsed:null, importing:false, importFile:null };
    const newId = ()=> crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2,10);

    function normalizeGames(arr){
      return (arr || []).map(g => {
        const kickoffTs = g.kickoffTs ?? (g.kickoff ? new Date(g.kickoff).getTime() : null);
        return {
          id: g.id || newId(),
          day: g.day || "",
          home: g.home || "",
          away: g.away || "",
          winner: g.winner || "",
          kickoff: g.kickoff || null,
          kickoffTs: Number.isFinite(kickoffTs) ? kickoffTs : null,
          createdAt: g.createdAt || null
        };
      }).sort(function(a,b){
        const ka = a.kickoffTs ?? Number.MAX_SAFE_INTEGER;
        const kb = b.kickoffTs ?? Number.MAX_SAFE_INTEGER;
        return ka - kb;
      });
    }

    function toFirestoreValue(v){
      if(v === undefined || v === null) return { nullValue: null };
      const t = typeof v;
      if(t === 'string') return { stringValue: v };
      if(t === 'boolean') return { booleanValue: v };
      if(t === 'number') return Number.isInteger(v) ? { integerValue: String(v) } : { doubleValue: v };
      return { stringValue: String(v) };
    }

    function serializeGameForRest(g){
      return {
        mapValue: {
          fields: {
            id: toFirestoreValue(g.id || newId()),
            day: toFirestoreValue(g.day || ""),
            home: toFirestoreValue(g.home || ""),
            away: toFirestoreValue(g.away || ""),
            winner: toFirestoreValue(g.winner || ""),
            kickoff: toFirestoreValue(g.kickoff || null),
            kickoffTs: toFirestoreValue(g.kickoffTs ?? null),
            createdAt: toFirestoreValue(g.createdAt ?? null)
          }
        }
      };
    }

    async function persistWeekGamesRest(wid, games){
      if(!auth.currentUser){ throw new Error('Not signed in; cannot run REST fallback'); }
      const token = await auth.currentUser.getIdToken();
      const url = `https://firestore.googleapis.com/v1/projects/${cfg.projectId}/databases/(default)/documents/weeks/${wid}?updateMask.fieldPaths=games&updateMask.fieldPaths=updatedAt&mask.fieldPaths=games&mask.fieldPaths=updatedAt`;
      const body = {
        fields: {
          games: { arrayValue: { values: (games||[]).map(serializeGameForRest) } },
          updatedAt: { integerValue: String(Date.now()) }
        }
      };
      const res = await fetch(url, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const text = await res.text();
        throw new Error('REST fallback failed: ' + res.status + ' ' + text);
      }
      return res.json();
    }

    async function persistWeekGames(wid, games){
      const payload = (games||[]).map(function(g){ return {
        id: g.id || newId(),
        day: g.day || "",
        home: g.home || "",
        away: g.away || "",
        winner: g.winner || "",
        kickoff: g.kickoff || null,
        kickoffTs: g.kickoffTs ?? null,
        createdAt: g.createdAt || null
      };});
      try {
        await db.collection('weeks').doc(wid).set({ games: payload, updatedAt: Date.now() }, { merge:true });
      } catch(err){
        console.warn('Primary Firestore write failed, trying REST fallback', err);
        impLog('Primary Firestore write failed; attempting REST fallback‚Ä¶');
        await persistWeekGamesRest(wid, payload);
        impLog('REST fallback succeeded.');
      }
    }
    const deleteChunkSize = 100;
    const writeChunkSize = 1;
    const commitTimeoutMs = 120000;
    // Legacy guard: older pick-import code referenced pickUid/hasPick/hasPickUser; keep defined to prevent ReferenceErrors in caches
    var pickUid = null;
    var pickUser = null;
    const hasPick = false;
    const hasPickUser = false;
    for(let i=1;i<=22;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=i; byId('impWeek').appendChild(o); }
    byId('impWeek').value="1"; byId('weekSelect').value="1";

    // ===== Firebase init (compat) =====
    const cfg = {
      apiKey: "AIzaSyDC2DnD4I4nekKWnCkDD9dTwQZN4tj3g0w",
      authDomain: "nflpicks2025-51202.firebaseapp.com",
      projectId: "nflpicks2025-51202",
      storageBucket: "nflpicks2025-51202.appspot.com",
      messagingSenderId: "125791202188",
      appId: "1:125791202188:web:903f4c74dc84a5b69604a9",
      measurementId: "G-289KXJQZGG"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"];
    const ADMIN_EMAILS = ["yelhsa311@gmail.com"]; // allow by email fallback
    let allowlist = { uids:[...ADMIN_UIDS], emails:[...ADMIN_EMAILS] };

    async function refreshAllowlist(){
      try{
        const doc = await db.collection('meta').doc('adminAllowlist').get();
        if(doc.exists){
          const data = doc.data() || {};
          const uids = Array.isArray(data.uids) ? data.uids : [];
          const emails = Array.isArray(data.emails) ? data.emails.map(e => (e||"").toLowerCase()) : [];
          allowlist = {
            uids: Array.from(new Set([...ADMIN_UIDS, ...uids])),
            emails: Array.from(new Set([...ADMIN_EMAILS, ...emails]))
          };
        }else{
          allowlist = { uids:[...ADMIN_UIDS], emails:[...ADMIN_EMAILS] };
        }
      }catch(err){
        console.warn('Failed to load admin allowlist; using fallback.', err);
        allowlist = { uids:[...ADMIN_UIDS], emails:[...ADMIN_EMAILS] };
      }
    }

    // ===== Auth gate =====
    auth.onAuthStateChanged(async function(user){
      if(!user){ location.replace('./picks.html'); return; }
      await refreshAllowlist();
      const isAdmin = allowlist.uids.indexOf(user.uid) !== -1 || allowlist.emails.includes((user.email||"").toLowerCase());
      if(!isAdmin){
        const msg = "Admins only. Add this UID to ADMIN_UIDS or email to ADMIN_EMAILS.";
        alert(msg + "\n\nUID: " + user.uid + "\nEmail: " + (user.email||"(no email)"));
        await auth.signOut();
        location.replace('./picks.html');
        return;
      }
      byId('userTag').textContent = user.email || "";
      loadWeek();
    });

    // ===== UI wiring =====
    byId('seasonInput').addEventListener('change', function(){ state.season=Number(byId('seasonInput').value||2025); state.weekId=weekId(state.season,state.weekNum); loadWeek(); });
    byId('weekSelect').addEventListener('change', function(){ state.weekNum=Number(byId('weekSelect').value||1); state.weekId=weekId(state.season,state.weekNum); byId('impWeek').value=String(state.weekNum); loadWeek(); });
    byId('refreshBtn').addEventListener('click', loadWeek);
    byId('addGameBtn').addEventListener('click', addGame);
    byId('saveChangesBtn').addEventListener('click', saveChanges);
    byId('openImportBtn').addEventListener('click', function(){ byId('importModal').classList.add('open'); setTimeout(function(){ byId('impFile').focus(); }, 0); });
    byId('closeImportBtn').addEventListener('click', function(){ byId('importModal').classList.remove('open'); });
    byId('impFile').addEventListener('change', function(){ state.importFile = byId('impFile').files[0] || null; resetImportUi('File selected ‚Äî choose Preview or Import.'); });
    byId('genTplBtn').addEventListener('click', generateTemplate);
    byId('impPreviewBtn').addEventListener('click', previewCsv);
    byId('impRunBtn').addEventListener('click', runImport);

    // Drag & drop
    (function(){
      var drop = byId('drop');
      ['dragenter','dragover'].forEach(function(evt){ drop.addEventListener(evt, function(e){ e.preventDefault(); drop.classList.add('drag'); }); });
      ['dragleave','drop'].forEach(function(evt){ drop.addEventListener(evt, function(e){ e.preventDefault(); drop.classList.remove('drag'); }); });
      drop.addEventListener('drop', function(e){
        if(state.importing){
          impSetStatus('Import already in progress. Please wait for it to finish.');
          return;
        }
        var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        resetImportUi('File dropped ‚Äî parsing‚Ä¶');
        state.importFile = f;
        parseCsvFile(f).then(function(p){
          state.parsed = p; if(p) renderPreview(p);
        }).catch(function(err){
          console.error(err); impSetStatus('Preview failed: ' + (err.message||err));
          alert('Preview failed: ' + (err && err.message ? err.message : String(err)));
        });
      });
    })();

    // ===== Data =====
    async function loadWeek(){
      try{
        setStatus("Loading‚Ä¶"); byId('wid').textContent = state.weekId;
        state.games = [];

        const wkRef = db.collection('weeks').doc(state.weekId);
        try{
          const wkSnap = await wkRef.get();
          if (wkSnap.exists){
            const data = wkSnap.data() || {};
            if (Array.isArray(data.games)){
              state.games = normalizeGames(data.games);
            }
          }
        }catch(err){ console.warn('Week doc load failed; falling back to legacy collection', err); }

        if (!state.games.length){
          try{
            const snap = await wkRef.collection('games').orderBy('kickoffTs').get();
            const legacy = [];
            snap.forEach(function(d){
              var g = d.data();
              legacy.push({ id:d.id, day:g.day||"", kickoff:g.kickoff||"", home:g.home||"", away:g.away||"", winner:g.winner||"", kickoffTs: g.kickoffTs || null, createdAt: g.createdAt || null });
            });
            state.games = normalizeGames(legacy);
            if (state.games.length){
              await persistWeekGames(state.weekId, state.games);
              impLog('Migrated legacy game documents into week doc.');
            }
          }catch(err){ console.error(err); }
        }

        renderGrid();
        byId('docCount').textContent = String(state.games.length);
        const list = state.games.slice(0,10).map(function(x){ return "‚Ä¢ " + x.home + " vs " + x.away + " (" + x.day + ")"; }).join('<br>');
        byId('debugList').innerHTML = list || '<em>No games</em>';
        setStatus("Week " + state.weekNum + " ‚Ä¢ " + state.games.length + " game(s)");
      }catch(err){ console.error(err); setStatus("Load error: " + (err.message||err)); }
    }

    function renderGrid(){
      var rows = byId('rows'); rows.innerHTML = "";
      state.games.forEach(function(g){ rows.appendChild(row(g)); });
    }
    function row(game){
      var node = document.createElement('div');
      node.className = 'trow';
      node.setAttribute('data-id', game.id);
      node.innerHTML = ''
        + '<input data-field="day" value="'+(game.day)+'" placeholder="Thursday">'
        + '<input data-field="kickoff" type="datetime-local" value="'+toLocal(game.kickoff)+'">'
        + '<input data-field="home" value="'+(game.home)+'" placeholder="Home team">'
        + '<input data-field="away" value="'+(game.away)+'" placeholder="Away team">'
        + '<select data-field="winner">'
        +   '<option value=""></option>'
        +   '<option value="home" '+(game.winner==="home"?"selected":"")+'>home</option>'
        +   '<option value="away" '+(game.winner==="away"?"selected":"")+'>away</option>'
        + '</select>'
        + '<div class="right"><button class="btn-danger" type="button" data-action="delete">Delete</button></div>';
      node.querySelector('[data-action="delete"]').addEventListener('click', async function(){
        if(!confirm("Delete this game?")) return;
        state.games = state.games.filter(function(g){ return g.id !== game.id; });
        await persistWeekGames(state.weekId, state.games);
        await loadWeek();
      });
      return node;
    }

    async function saveChanges(){
      var rows = Array.prototype.slice.call(document.querySelectorAll('.trow'));
      const map = new Map(state.games.map(function(g){ return [g.id, g]; }));
      rows.forEach(function(r){
        const id = r.getAttribute('data-id');
        const kickoffVal = r.querySelector('[data-field="kickoff"]').value;
        const kickoffIso = kickoffVal ? new Date(kickoffVal).toISOString() : "";
        const payload = {
          id: id || newId(),
          day: r.querySelector('[data-field="day"]').value.trim(),
          kickoff: kickoffIso,
          kickoffTs: kickoffIso ? new Date(kickoffIso).getTime() : null,
          home: r.querySelector('[data-field="home"]').value.trim(),
          away: r.querySelector('[data-field="away"]').value.trim(),
          winner: r.querySelector('[data-field="winner"]').value || ""
        };
        map.set(payload.id, { ...map.get(payload.id), ...payload });
      });
      state.games = normalizeGames(Array.from(map.values()));
      await persistWeekGames(state.weekId, state.games);
      setStatus("Saved " + state.games.length + " game(s).");
    }

    async function addGame(){
      const day = byId('dayInput').value;
      const home = byId('homeInput').value.trim();
      const away = byId('awayInput').value.trim();
      const kick = byId('kickoffInput').value;
      if(!home || !away || !kick){ alert("Fill Home, Away, Kickoff."); return; }
      const kickoffIso = new Date(kick).toISOString();
      const payload = { id:newId(), weekId: state.weekId, day, home, away, kickoff: kickoffIso, kickoffTs: new Date(kickoffIso).getTime(), winner: "", createdAt: Date.now() };
      state.games.push(payload);
      state.games = normalizeGames(state.games);
      await persistWeekGames(state.weekId, state.games);
      byId('homeInput').value=""; byId('awayInput').value=""; byId('kickoffInput').value="";
      await loadWeek();
    }

    // ===== CSV/Import =====
    function parseAmPm(s){
      if(!s) return null;
      const t = String(s).trim();
      const parts = t.split(' ');
      if(parts.length < 2) return null;
      const datePart = parts[0].replace('-', '/');
      const timePart = parts[1];
      const ampm = (parts[2]||'').toLowerCase();
      const dBits = datePart.split('/');
      if(dBits.length !== 3) return null;
      let M = parseInt(dBits[0],10), D = parseInt(dBits[1],10), Y = parseInt(dBits[2],10);
      const tm = timePart.split(':');
      if(tm.length < 2) return null;
      let h = parseInt(tm[0],10), min = parseInt(tm[1],10);
      if(!isFinite(M)||!isFinite(D)||!isFinite(Y)||!isFinite(h)||!isFinite(min)) return null;
      if(Y<100) Y += 2000;
      const ap = ampm;
      const isPM = ap.indexOf('pm')>=0;
      const isAM = ap.indexOf('am')>=0;
      if(isPM && h<12) h+=12;
      if(isAM && h===12) h=0;
      const mm = String(M).padStart(2,'0'), dd = String(D).padStart(2,'0');
      const hh = String(h).padStart(2,'0'), mmin = String(min).padStart(2,'0');
      return Y+"-"+mm+"-"+dd+"T"+hh+":"+mmin+":00";
    }
    function combineDateTime(dateStr, timeStr){
      const date = (dateStr||"").trim();
      const time = (timeStr||"").trim();
      if(!date && !time) return "";
      if(date && time) return (date + " " + time).trim();
      return (date || time).trim();
    }
    function toIso(localStr){
      if(!localStr) return "";
      const s = String(localStr).trim();
      const d1 = new Date(s.indexOf(' ')>=0 ? s.replace(' ','T') : s);
      if(!isNaN(d1.getTime())) return d1.toISOString();
      const alt = parseAmPm(s);
      if(alt){
        const d2 = new Date(alt);
        if(!isNaN(d2.getTime())) return d2.toISOString();
      }
      throw new Error("Invalid kickoff_local datetime: " + localStr);
    }
    function splitCsvLine(line, delim){
      var out=[], cur="", inQ=false, d=delim||',';
      for(var i=0;i<line.length;i++){
        var ch=line[i];
        if(ch === '"'){
          if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else { inQ = !inQ; }
        } else if(ch === d && !inQ){
          out.push(cur); cur="";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(function(s){ return (s||'').trim(); });
    }
    function normalizeSide(val, home, away){
      const v = (val||"").toLowerCase().trim();
      if(!v) return "";
      if(v==="home" || v==="h") return "home";
      if(v==="away" || v==="a") return "away";
      if(home && v===home.toLowerCase()) return "home";
      if(away && v===away.toLowerCase()) return "away";
      return v;
    }
    async function parseCsvFile(file){
      if(!file){ alert("Pick a CSV file first or drop it into the box."); return null; }
      const raw = await file.text();
      impLog('Read CSV: ' + (file.name||'unnamed') + ' (' + raw.length + ' bytes)');
      let text = raw.split('\r\n').join('\n'); text = text.split('\r').join('\n');
      const linesAll = text.split('\n');
      const lines = linesAll.filter(function(l){ return (l||'').trim().length>0; });
      impLog('CSV diagnostics: bytes=' + raw.length + ', lines(raw)=' + linesAll.length + ', lines(trimmed)=' + lines.length);
      if(lines.length < 2){ alert("CSV has no data rows. Ensure header + at least one row."); return null; }
      const delim = (lines[0].indexOf(';')>=0 && lines[0].indexOf(',')<0) ? ';' : ',';
      const headers = splitCsvLine(lines[0], delim).map(function(s){ return s.toLowerCase(); });
      const idx = {
        day: headers.indexOf("day"),
        kickoff: headers.indexOf("kickoff_local"),
        kickoffDate: headers.indexOf("kickoff_date"),
        kickoffTime: headers.indexOf("kickoff_time"),
        home: headers.indexOf("home"),
        away: headers.indexOf("away"),
        winner: headers.indexOf("winner")
      };
      if(idx.day === -1){ alert("Missing day column"); return null; }
      const hasDateParts = idx.kickoffDate >=0 && idx.kickoffTime >=0;
      if(idx.kickoff === -1 && !hasDateParts){ alert("Need kickoff_local or both kickoff_date and kickoff_time columns"); return null; }
      if(idx.winner === -1){ alert("Missing winner column"); return null; }
      const hasTeams = idx.home >=0 && idx.away >=0;
      if(!hasTeams){ alert("Missing home/away columns"); return null; }

      const games=[], rows=[];
      for(var li=1; li<lines.length; li++){
        const cols = splitCsvLine(lines[li], delim);
        if(cols.length===0) continue;
        const day = cols[idx.day];
        const kickoffLocal = idx.kickoff >=0 ? cols[idx.kickoff] : combineDateTime(cols[idx.kickoffDate], cols[idx.kickoffTime]);
        let kickoffDate = idx.kickoffDate >=0 ? cols[idx.kickoffDate] : "";
        let kickoffTime = idx.kickoffTime >=0 ? cols[idx.kickoffTime] : "";
        let home = hasTeams ? (cols[idx.home]||"") : "";
        let away = hasTeams ? (cols[idx.away]||"") : "";
        const winner = cols[idx.winner]||"";
        if(!day && !home && !away) continue;
        if(!home || !away){ alert("Missing home/away team on row " + (li+1)); return null; }
        const iso = toIso(kickoffLocal);
        if(iso && (!kickoffDate || !kickoffTime)){
          const parts = partsFromIso(iso);
          if(!kickoffDate) kickoffDate = parts.date;
          if(!kickoffTime) kickoffTime = parts.time;
        }
        const winnerNorm = normalizeSide(winner, home, away);
        games.push({ day:day, home:home, away:away, winner:winnerNorm, kickoffIso: iso });
        rows.push({ std:[day,kickoffDate,kickoffTime,kickoffLocal,home,away,winnerNorm] });
      }
      return { headers:headers, games:games, rows:rows, hasPick: hasPick };
    }
    async function commitChunks(actions, chunkSize, label, timeoutMs){
      const total = actions.length;
      let done = 0;
      const commitLabel = label ? (label + ' commit') : 'Batch commit';
      const singleLabel = label ? (label + ' single write') : 'Single write';
      const singleTimeout = Math.max(1000, Math.round((timeoutMs||120000)/3));
      for(let i=0;i<actions.length;i+=chunkSize){
        const slice = actions.slice(i, i+chunkSize);
        const b = db.batch();
        slice.forEach(function(fn){ fn(b); });
        try{
          await withTimeout(b.commit(), commitLabel, timeoutMs);
          done += Math.min(chunkSize, total - i);
          if(label) impLog(label + ' chunk committed (' + done + '/' + total + ')');
          impProg(Math.min(90, Math.round((done/Math.max(total,1))*70)+20));
        }catch(err){
          const msg = err && err.message ? err.message : '';
          if(msg.indexOf('timed out') === -1){ throw err; }
          impLog(commitLabel + ' timed out; retrying as individual writes‚Ä¶');
          for(let j=0;j<slice.length;j++){
            const singleBatch = db.batch();
            slice[j](singleBatch);
            await withTimeout(singleBatch.commit(), singleLabel, singleTimeout);
            done += 1;
            if(label && (j%5===0 || j===slice.length-1)){
              impLog(singleLabel + ' retry progress (' + done + '/' + total + ')');
            }
            impProg(Math.min(90, Math.round((done/Math.max(total,1))*70)+20));
          }
        }
      }
    }
    async function deleteExistingGames(wid){
      // Legacy helper retained for compatibility; now replaced by a single doc write.
      await persistWeekGames(wid, []);
      impLog('Cleared games in week doc for ' + wid);
      return 0;
    }
    function renderPreview(p){
      byId('previewInfo').textContent = "Games: " + p.games.length + (p.hasPick ? " ‚Ä¢ picks included" : "");
      const tbl = byId('previewTable'); tbl.innerHTML="";
      const trh = document.createElement("tr");
      ["day","kickoff_date","kickoff_time","kickoff_local","home","away","winner"].forEach(function(h){ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
      tbl.appendChild(trh);
      p.rows.forEach(function(r){ const tr=document.createElement("tr"); r.std.forEach(function(v){ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); }); tbl.appendChild(tr); });
      byId('previewCard').style.display="block";
    }
    async function previewCsv(){
      try{
        if(state.importing){ impSetStatus('Import already running. Please wait.'); return; }
        const f = state.importFile || byId('impFile').files[0];
        state.parsed = await parseCsvFile(f);
        if(state.parsed){
          renderPreview(state.parsed);
          impSetStatus('Preview ready.');
        }
      }catch(err){
        console.error(err);
        impSetStatus('Preview failed. See details below.');
        impLog(err && err.message ? err.message : String(err));
        alert('Preview failed: ' + (err && err.message ? err.message : String(err)));
      }
    }
    async function runImport(){
      if(state.importing){
        impSetStatus('Import already running. Please wait for it to finish.');
        return;
      }
      setImportBusy(true);
      impClearLog();
      try{
        const f = state.importFile || byId('impFile').files[0];
        if(!f){ alert('Pick a CSV file first.'); return; }
        if(!state.parsed){
          state.parsed = await parseCsvFile(f);
          if(!state.parsed) return;
        }
        const season = Number(byId('impSeason').value||2025);
        const wn = Number(byId('impWeek').value||1);
        const wid = weekId(season, wn);
        const games = Array.isArray(state.parsed.games) ? state.parsed.games : [];
        if(!games.length){
          impSetStatus('‚ùå No games found in CSV; import cancelled.');
          alert('Import cancelled: no games were parsed from the CSV.');
          return;
        }
        impSetStatus("Importing‚Ä¶"); impLog("Import start for " + wid); impProg(1);

        await deleteExistingGames(wid);
        impProg(35);

        const withIds = games.map(function(g){
          const kickoffTsRaw = g.kickoffIso ? new Date(g.kickoffIso).getTime() : null;
          const kickoffTs = Number.isFinite(kickoffTsRaw) ? kickoffTsRaw : null;
          return {
            id: g.id || newId(),
            day: g.day,
            home: g.home,
            away: g.away,
            winner: g.winner||"",
            kickoff: g.kickoffIso || null,
            kickoffTs,
            createdAt: Date.now(),
            weekId: wid
          };
        });

        await persistWeekGames(wid, withIds);
        impLog("Wrote " + withIds.length + " game(s) to week doc");
        impProg(100);
        impSetStatus("‚úÖ Import complete.");
        impLog('Import complete.');
        alert("Import complete!\n\nGames added: " + withIds.length + "\n\nExisting games for this week were cleared before import.");
        if(wid === state.weekId) await loadWeek();
      }catch(err){
        console.error(err); impSetStatus("‚ùå Import failed. See details below."); impLog(err && err.message ? err.message : String(err)); alert("Import failed: " + (err && err.message ? err.message : String(err)));
      } finally {
        impProgDone();
        setImportBusy(false);
      }
    }
    function generateTemplate(){
      const csv = "day,kickoff_date,kickoff_time,home,away,winner\n";
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download="week-template.csv"; document.body.appendChild(a); a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

  })();
  </script>
</body>
</html>
