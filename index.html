<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Family NFL Picks — User</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 720px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; }
    .row > input { flex: 1; padding: 8px; }
    .btn { padding: 8px 12px; border: 1px solid #333; border-radius: 8px; background:#fff; cursor: pointer; }
    .btn:hover { background:#f5f5f5; }
    #error { color: #b00020; margin-top: 8px; }
    #loading { display:none; }
    #authed { display:none; }
    ul { padding-left: 18px; }
    .muted { color: #666; font-size: 0.95rem; }
  </style>
</head>
<body>
  <h1>Family NFL Picks</h1>
  <div id="login" class="card">
    <h2>Sign in</h2>
    <div class="row">
      <input id="email" type="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    </div>
    <div class="row">
      <button id="email-login" class="btn">Sign in</button>
      <button id="google-login" class="btn">Sign in with Google</button>
    </div>
    <div id="error" hidden></div>
    <div id="loading" class="muted">Working…</div>
    <p class="muted">Tip: if the Google popup is blocked, we’ll fall back to redirect.</p>
  </div>

  <div id="authed" class="card">
    <div class="row" style="justify-content: space-between; align-items:center">
      <div>
        <strong id="whoami"></strong><br />
        <span class="muted">Signed in</span>
      </div>
      <button id="logout" class="btn">Sign out</button>
    </div>

    <h3>This Week</h3>
    <div id="this-week">Loading…</div>

    <h3>All Weeks</h3>
    <div id="weeks-root">Loading…</div>
  </div>

  <!-- Firebase CDN (v10+ works; v9 also OK). Using v10 here. -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      GoogleAuthProvider, signInWithEmailAndPassword, signInWithPopup, signInWithRedirect,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // =====  firebase.js  (inline)  =====
    const firebaseConfig = {
      apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
      authDomain: "nfl-picks-b83c2.firebaseapp.com",
      projectId: "nfl-picks-b83c2",
      storageBucket: "nfl-picks-b83c2.appspot.com",
      messagingSenderId: "802058909501",
      appId: "1:802058909501:web:bb935c188891934de07754",
      measurementId: "G-MSJHYZ4VG2"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);
    const googleProvider = new GoogleAuthProvider();

    // =====  tiny helpers  =====
    const $ = (id) => document.getElementById(id);
    const show = (el) => { el.style.display = ""; };
    const hide = (el) => { el.style.display = "none"; };
    const setBusy = (flag) => { $("loading").style.display = flag ? "" : "none"; };
    const setError = (code) => {
      const box = $("error");
      if (!code) { box.textContent=""; box.hidden = true; return; }
      box.textContent = friendlyAuthError(code);
      box.hidden = false;
    };
    function friendlyAuthError(code) {
      switch (code) {
        case "auth/invalid-email": return "That email doesn’t look right.";
        case "auth/user-not-found":
        case "auth/wrong-password": return "Email or password is incorrect.";
        case "auth/popup-closed-by-user": return "Google sign-in was closed.";
        case "auth/popup-blocked": return "Your browser blocked the Google popup.";
        case "auth/unauthorized-domain": return "This site isn’t authorized in Firebase (Authorized domains).";
        case "auth/network-request-failed": return "Network issue — check your connection and try again.";
        default: return `Login error: ${code}`;
      }
    }

    // =====  auth wiring  =====
    $("email-login").addEventListener("click", async () => {
      setError(); setBusy(true);
      try {
        const email = $("email").value.trim();
        const pass  = $("password").value;
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        setError(e?.code || "auth/unknown");
      } finally {
        setBusy(false);
      }
    });

    $("google-login").addEventListener("click", async () => {
      setError(); setBusy(true);
      try {
        // Try popup first; if blocked, fall back to redirect.
        await signInWithPopup(auth, googleProvider);
      } catch (e) {
        if (e?.code === "auth/popup-blocked") {
          try { await signInWithRedirect(auth, googleProvider); return; }
          catch (e2) { setError(e2?.code || "auth/unknown"); }
        } else {
          setError(e?.code || "auth/unknown");
        }
      } finally {
        setBusy(false);
      }
    });

    $("logout").addEventListener("click", () => signOut(auth));

    // =====  UI reactions to auth state  =====
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        hide($("login"));
        show($("authed"));
        $("whoami").textContent = user.displayName
          ? `${user.displayName} (${user.email})`
          : (user.email ?? user.uid);

        // After sign-in, prove Firestore reads work:
        await renderWeeks();
        await renderThisWeek();
      } else {
        show($("login"));
        hide($("authed"));
      }
    });

    // =====  firestore reads (simple, robust)  =====
    async function renderWeeks() {
      try {
        const qy = query(collection(db, "weeks"), orderBy("weekNumber", "asc"));
        const snap = await getDocs(qy);
        const list = document.createElement("ul");
        snap.forEach(doc => {
          const w = doc.data();
          const li = document.createElement("li");
          li.textContent = `Week ${w.weekNumber} — ${w.start ?? "?"} → ${w.end ?? "?"}${w.locked ? " (locked)" : ""}`;
          list.appendChild(li);
        });
        $("weeks-root").replaceChildren(list);
      } catch (e) {
        $("weeks-root").textContent = `Failed to load weeks: ${e?.message ?? e}`;
      }
    }

    async function renderThisWeek() {
      try {
        // “Current week” heuristic: the first unlocked week (or the highest week if all locked).
        const unlocked = query(collection(db, "weeks"), where("locked", "==", false), orderBy("weekNumber", "asc"));
        const unlockedSnap = await getDocs(unlocked);

        let targetWeekNumber = null;
        if (!unlockedSnap.empty) {
          targetWeekNumber = unlockedSnap.docs[0].data().weekNumber;
        } else {
          // Fallback: highest weekNumber
          const all = query(collection(db, "weeks"), orderBy("weekNumber", "desc"));
          const allSnap = await getDocs(all);
          if (!allSnap.empty) targetWeekNumber = allSnap.docs[0].data().weekNumber;
        }

        if (targetWeekNumber == null) {
          $("this-week").textContent = "No weeks available yet.";
          return;
        }

        // Load games for that week from flat /games collection
        const gamesQ = query(collection(db, "games"),
          where("weekId", "==", String(targetWeekNumber)), orderBy("kickoff", "asc"));
        const gamesSnap = await getDocs(gamesQ);

        if (gamesSnap.empty) {
          $("this-week").textContent = `No games found for Week ${targetWeekNumber}.`;
          return;
        }

        const ul = document.createElement("ul");
        gamesSnap.forEach(doc => {
          const g = doc.data();
          const li = document.createElement("li");
          const ko = g.kickoff ? new Date(g.kickoff).toLocaleString() : "TBD";
          li.textContent = `${ko}: ${g.away} @ ${g.home}${g.winner ? " — Winner: " + g.winner : ""}`;
          ul.appendChild(li);
        });
        $("this-week").replaceChildren(ul);
      } catch (e) {
        $("this-week").textContent = `Failed to load current week: ${e?.message ?? e}`;
      }
    }
  </script>
</body>
</html>
