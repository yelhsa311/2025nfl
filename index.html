<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family NFL Picks</title>
<style>
  :root{--bg:#0f1115;--fg:#e7e7e7;--muted:#9aa0a6;--card:#171a21;--accent:#6ea8ff;--bad:#ff6b6b;--border:#252a33}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  .wrap{max-width:960px;margin:0 auto;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
  button,input,select{border:1px solid var(--border);background:var(--card);color:var(--fg);padding:10px;border-radius:10px}
  button.primary{outline:2px solid var(--accent)}
  .grid{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
  .match{padding:10px;border:1px dashed var(--border);border-radius:10px}
  .team{padding:8px;border:1px solid var(--border);border-radius:8px;cursor:pointer;text-align:center}
  .team.winner{outline:2px solid var(--accent)}
  .team.result{outline:2px solid #22c55e}
  .bar{display:flex;justify-content:space-between;align-items:center}
  .muted{color:var(--muted)}
  .danger{color:var(--bad)}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px}
  .lock{padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
  .disabled{opacity:.6;pointer-events:none}
  h2.day{margin:16px 0 8px}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#000a;color:#fff;padding:10px 14px;border-radius:999px;opacity:0;transition:opacity .2s;z-index:1000}
  .toast.show{opacity:1}
  .badge{font-size:12px;border:1px solid var(--border);border-radius:6px;padding:2px 6px;background:var(--card);color:var(--fg);cursor:pointer}
  .admin-chip{font-size:11px;opacity:.85}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--border);padding:8px;text-align:left}
  th{background:#12151c}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h1 style="margin:0">Family NFL Picks</h1>
    <div id="userBox" class="row"></div>
  </div>

  <!-- Auth -->
  <div id="auth" class="card">
    <div class="row">
      <input id="email" type="email" placeholder="Email" />
      <input id="pass" type="password" placeholder="Password" />
      <button id="signInBtn" class="primary">Sign in</button>
      <button id="registerBtn">Register</button>
    </div>
    <div class="muted" style="margin-top:6px">Only invited family should register.</div>
  </div>

  <!-- App -->
  <div id="app" class="card" style="display:none">
    <div class="row">
      <label>Week:</label>
      <select id="weekSelect"></select>
      <span id="lockBadge" class="lock muted">…</span>
      <span class="pill" id="adminBadge" style="display:none">ADMIN</span>
      <span class="pill" id="finalizeWrap" style="display:none">
        <input id="adminWeekLock" type="checkbox" /> Finalize
      </span>
    </div>

    <div id="games" class="card" style="margin-top:8px">
      <div class="bar"><strong>Games</strong><span class="muted">Pick winners before kickoff</span></div>
      <div class="muted" id="noGames" style="display:none">No games yet for this week.</div>
      <div id="gameList"></div>
    </div>

    <div id="standings" class="card" style="margin-top:8px">
      <div class="bar">
        <strong>Standings — Week <span id="wkNum">1</span></strong>
        <div id="publishWrap" style="display:none" class="row">
          <button id="recalcBtn" class="badge">Recalculate</button>
          <button id="publishBtn" class="badge">Publish</button>
        </div>
      </div>
      <div id="standingsBody">
        <div class="muted">Standings will appear once there are winners and picks.</div>
      </div>
    </div>

    <div class="card">
      <div class="bar">
        <div class="muted">Your picks autosave</div>
        <div id="adminToolbar" style="display:none">
          <button id="addGameBtn">+ Add game</button>
          <button id="clearGamesBtn" title="Delete all games in this week">Clear games</button>
        </div>
      </div>

      <!-- Admin add panel -->
      <div id="adminAddPanel" style="display:none;margin-top:8px">
        <div class="row">
          <select id="gameDay" title="Day">
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday" selected>Sunday</option>
            <option value="Monday">Monday</option>
          </select>
          <input id="homeTeam" placeholder="Home team (e.g., Cowboys)" />
          <input id="awayTeam" placeholder="Away team (e.g., Eagles)" />
          <input id="kickoff" type="datetime-local" title="Kickoff local time" />
          <button id="saveGameBtn" class="primary">Save game</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Saved!</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword,
    createUserWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    initializeFirestore, getFirestore, doc, setDoc, onSnapshot,
    collection, addDoc, query, orderBy, getDocs, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { collectionGroup } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // --- Firebase config (yours) ---
  const firebaseConfig = {
    apiKey: "AIzaSyCBgBR2n4e5ObgQOpRNRQQtZ7AhKLBr080",
    authDomain: "nfl-picks-b83c2.firebaseapp.com",
    projectId: "nfl-picks-b83c2",
    storageBucket: "nfl-picks-b83c2.appspot.com",
    messagingSenderId: "802058909501",
    appId: "1:802058909501:web:bb935c188891934de07754",
    measurementId: "G-MSJHYZ4VG2"
  };

  // --- Init ---
  const app = initializeApp(firebaseConfig);
  initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Admin UID(s) ---
  window.ADMIN_UIDS = ["j8D0AzlAgmTHSaDcBHwQbpMT9Is1"]; // <— your admin account

  // --- Helpers ---
  const el = s => document.querySelector(s);
  const toast = (msg="Saved!") => { const t=el("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),900); };

  const state = { user:null, isAdmin:false, weekId:"2025-Week-01", lock:false, picks:{}, games:[] };

  // --- Auth UI ---
  el("#signInBtn").onclick = async () => {
    const email = el("#email").value.trim();
    const pass  = el("#pass").value;
    try { await signInWithEmailAndPassword(auth, email, pass); } catch(e){ alert(e.message); }
  };
  el("#registerBtn").onclick = async () => {
    const email = el("#email").value.trim();
    const pass  = el("#pass").value;
    try { await createUserWithEmailAndPassword(auth, email, pass); } catch(e){ alert(e.message); }
  };

  onAuthStateChanged(auth, async (user) => {
    state.user = user || null;

    if (!user){
      el("#auth").style.display="block";
      el("#app").style.display ="none";
      el("#userBox").innerHTML = "";
      return;
    }

    el("#userBox").innerHTML = `<span class="pill">${user.email}</span> <button id="signOutBtn">Sign out</button>`;
    el("#signOutBtn").onclick = async () => { try { await signOut(auth); } finally { location.reload(); } };

    state.isAdmin = (window.ADMIN_UIDS||[]).includes(user.uid);
    el("#adminBadge").style.display    = state.isAdmin ? "" : "none";
    el("#finalizeWrap").style.display  = state.isAdmin ? "" : "none";
    el("#adminToolbar").style.display  = state.isAdmin ? "" : "none";

    el("#auth").style.display="none";
    el("#app").style.display ="block";

    await setupWeeks();
    await subscribeWeek();
    wireStandingsButtons();
  });

  async function setupWeeks(){
    const sel = el("#weekSelect"); sel.innerHTML="";
    for (let i=1;i<=18;i++){
      const id = `2025-Week-${String(i).padStart(2,"0")}`;
      const o = document.createElement("option");
      o.value=id; o.textContent=`Week ${i}`;
      sel.appendChild(o);
    }
    sel.value = state.weekId;
    sel.onchange = () => { state.weekId = sel.value; subscribeWeek(); };
  }

  let unsubGames=null, unsubLock=null, unsubMyPicks=null;

  async function subscribeWeek(){
    unsubGames?.(); unsubLock?.(); unsubMyPicks?.();

    // Lock meta
    const lockRef = doc(db, "weeks", state.weekId, "meta", "lock");
    unsubLock = onSnapshot(lockRef, s => {
      state.lock = s.exists() ? !!s.data().locked : false;
      el("#lockBadge").textContent = state.lock ? "Finalized" : "Open";
      el("#lockBadge").className   = "lock " + (state.lock ? "danger" : "muted");
      el("#adminWeekLock").checked = state.lock;
      renderGames();
    }, e => console.error("lock listener", e));
    el("#adminWeekLock").onchange = async (e) => {
      if (!state.isAdmin) return;
      await setDoc(lockRef, { locked: e.target.checked }, { merge:true });
    };

    // Games (ordered by createdAt; UI sorts by kickoffTs)
    const gamesCol = collection(db, "weeks", state.weekId, "games");
    unsubGames = onSnapshot(query(gamesCol, orderBy("createdAt","asc")), snap => {
      state.games = []; snap.forEach(d => state.games.push({ id:d.id, ...d.data() }));
      el("#noGames").style.display = state.games.length ? "none" : "";
      renderGames();
    }, e => console.error("games listener", e));

    // My picks
    const picksRef = doc(db, "picks", state.user.uid, "weeks", state.weekId);
    unsubMyPicks = onSnapshot(picksRef, snap => {
      state.picks = snap.exists() ? (snap.data().picks||{}) : {};
      renderGames();
    }, e => console.error("picks listener", e));

    // Admin controls
    el("#addGameBtn").onclick = () => {
      const p = el("#adminAddPanel");
      p.style.display = (p.style.display==="none" || !p.style.display) ? "" : "none";
    };
    el("#saveGameBtn").onclick = saveGame;
    el("#clearGamesBtn").onclick = clearGames;
  }

  // --- Rendering (group by day, sort by kickoffTs; tolerant to variations) ---
  function renderGames(){
    const list = el("#gameList"); list.innerHTML="";

    const orderDays = ["Thursday","Friday","Saturday","Sunday","Monday"];
    const mapDay = d => {
      const x = String(d||"").trim().toLowerCase();
      const m = { thursday:"Thursday", friday:"Friday", saturday:"Saturday", sunday:"Sunday", monday:"Monday" };
      return m[x] || "Other";
    };

    const groups = Object.fromEntries([...orderDays, "Other"].map(d => [d, []]));
    (state.games||[]).forEach(g => { (groups[mapDay(g.day)]||groups.Other).push(g); });

    const readKick = g => {
      if (typeof g.kickoffTs === "number") return g.kickoffTs;
      if (g.kickoff){ const t = Date.parse(g.kickoff); return Number.isFinite(t) ? t : null; }
      return null;
    };
    const sortByKick = (a,b) => {
      const at=readKick(a), bt=readKick(b);
      if (at!=null && bt!=null && at!==bt) return at-bt;
      if (at!=null && bt==null) return -1; if (at==null && bt!=null) return 1;
      const ac=a.createdAt||0, bc=b.createdAt||0; return ac-bc;
    };
    const fmt = ms => new Date(ms).toLocaleTimeString([], { hour:"numeric", minute:"2-digit" });

    const rowFor = g => {
      const row  = document.createElement("div"); row.className="match grid";
      const home = document.createElement("button"); home.className="team"; home.textContent=g.home;
      const vs   = document.createElement("div");   vs.style.textAlign="center";
      const away = document.createElement("button"); away.className="team"; away.textContent=g.away;

      const t = readKick(g);
      vs.innerHTML = t ? `<span class="muted">vs<br><small>${fmt(t)}</small></span>` : `<span class="muted">vs</span>`;

      // user's pick highlight
      if ((state.picks||{})[g.id]==="home") home.classList.add("winner");
      if ((state.picks||{})[g.id]==="away") away.classList.add("winner");

      // game result highlight (admin-set)
      if (g.winner === "home") home.classList.add("result");
      if (g.winner === "away") away.classList.add("result");

      // lock picks for non-admin when finalized
      if (state.lock && !state.isAdmin){ home.classList.add("disabled"); away.classList.add("disabled"); }

      home.onclick = () => choose(g.id, "home");
      away.onclick = () => choose(g.id, "away");

      // Admin winner controls
      if (state.isAdmin){
        const adminRow = document.createElement("div");
        adminRow.className = "muted admin-chip";
        adminRow.style.marginTop = "6px";
        adminRow.innerHTML = `
          <button class="badge" data-act="win-home">Set Home as Winner</button>
          <button class="badge" data-act="win-away">Set Away as Winner</button>
          <button class="badge" data-act="clear">Clear</button>
        `;
        vs.appendChild(adminRow);
        adminRow.addEventListener("click", (e) => {
          const btn = e.target.closest("button"); if (!btn) return;
          const act = btn.getAttribute("data-act");
          if (act === "win-home")  setWinner(g.id, "home");
          if (act === "win-away")  setWinner(g.id, "away");
          if (act === "clear")     setWinner(g.id, null);
        });
      }

      row.appendChild(home); row.appendChild(vs); row.appendChild(away);
      return row;
    };

    let any=false;
    for (const d of orderDays){
      const arr = groups[d];
      if (!arr.length) continue;
      arr.sort(sortByKick);
      const h = document.createElement("h2"); h.className="day"; h.textContent = d;
      list.appendChild(h);
      arr.forEach(g => list.appendChild(rowFor(g)));
      any = true;
    }
    if (groups.Other.length){
      groups.Other.sort(sortByKick);
      const h = document.createElement("h2"); h.className="day"; h.textContent = "Other";
      list.appendChild(h);
      groups.Other.forEach(g => list.appendChild(rowFor(g)));
      any = true;
    }

    el("#noGames").style.display = any ? "none" : "";

    // Update week label on standings card
    const wk = Number(state.weekId.split("-").pop());
    el("#wkNum").textContent = String(wk);

    // Recompute standings whenever games render
    computeWeekStandings();
  }

  // --- Actions ---
  async function choose(gameId, side){
    if (state.lock && !state.isAdmin) return;
    state.picks[gameId] = side;
    const ref = doc(db, "picks", state.user.uid, "weeks", state.weekId);
    await setDoc(ref, { weekId: state.weekId, picks: state.picks, updatedAt: Date.now(), email: state.user.email }, { merge:true });
    toast();
    renderGames();
  }

  async function setWinner(gameId, side /* "home" | "away" | null */){
    if (!state.isAdmin) return;
    const ref = doc(db, "weeks", state.weekId, "games", gameId);
    await setDoc(ref, { winner: side ?? null }, { merge:true });
    toast(side ? `Winner set: ${side}` : "Winner cleared");
    computeWeekStandings();
  }

  async function saveGame(){
    if (!state.isAdmin) return;
    const day  = (el("#gameDay")?.value || "Sunday").trim();
    const home = el("#homeTeam").value.trim();
    const away = el("#awayTeam").value.trim();
    const raw  = el("#kickoff")?.value || ""; // yyyy-mm-ddThh:mm
    const kickoffTs = raw ? Date.parse(raw) : null;
    if (!home || !away) return alert("Enter both team names.");
    await addDoc(collection(db, "weeks", state.weekId, "games"), {
      day, home, away, createdAt: Date.now(), ...(kickoffTs ? { kickoffTs } : {})
    });
    el("#homeTeam").value=""; el("#awayTeam").value=""; if (el("#kickoff")) el("#kickoff").value="";
    toast("Game added");
  }

  async function clearGames(){
    if (!state.isAdmin){ console.warn("Admin only"); return; }
    const colRef = collection(db, "weeks", state.weekId, "games");
    const snap = await getDocs(colRef);
    let n=0; for (const d of snap.docs){ await deleteDoc(d.ref); n++; }
    console.log("Cleared", n, "games for", state.weekId);
    toast("Cleared " + n + " games");
    computeWeekStandings();
  }

  // --- Seeder: accepts {day, home, away, kickoff:"ISO"} or {kickoffTs:number} ---
  async function seedWeek1(items){
    if (!state.isAdmin){ console.warn("Admin only"); return; }
    const col = collection(db, "weeks", state.weekId, "games");
    let n=0;
    for (const item of items){
      const day = item.day || "Sunday";
      const home = item.home?.trim(); const away = item.away?.trim();
      const kickoffTs = item.kickoff ? Date.parse(item.kickoff) : (typeof item.kickoffTs==="number" ? item.kickoffTs : null);
      if (!home || !away) continue;
      await addDoc(col, { day, home, away, createdAt: Date.now(), ...(kickoffTs ? { kickoffTs } : {}) });
      n++;
    }
    console.log("Seeded", n, "games into", state.weekId);
    computeWeekStandings();
  }

  // --- Standings (Week + Publish + Overall helper) ---
  function wireStandingsButtons(){
    el("#publishWrap").style.display = state.isAdmin ? "" : "none";
    el("#recalcBtn")?.addEventListener("click", computeWeekStandings);
    el("#publishBtn")?.addEventListener("click", publishWeekStandings);
  }

  async function computeWeekStandings(){
    try{
      // Build winners map for current week
      const gamesSnap = await getDocs(collection(db, "weeks", state.weekId, "games"));
      const winners = {}; let totalGames=0;
      gamesSnap.forEach(d => { const g=d.data(); if (g.winner==="home"||g.winner==="away"){ winners[d.id]=g.winner; totalGames++; } });

      // Pull all users' picks for this week via collectionGroup
      const cg = await getDocs(query(collectionGroup(db, "weeks"),));
      const rows = [];
      cg.forEach(docSnap => {
        const data = docSnap.data();
        if (data.weekId !== state.weekId) return; // only this week
        const picks = data.picks || {}; const email = data.email || docSnap.ref.path.split("/")[1];
        let wins=0, played=0;
        for (const [gameId, side] of Object.entries(picks)){
          const w = winners[gameId]; if (!w) continue; played++;
          if (w === side) wins++;
        }
        rows.push({ email, wins, played });
      });

      rows.sort((a,b)=> b.wins - a.wins || a.email.localeCompare(b.email));
      renderStandingsTable(rows, totalGames);
    }catch(e){
      console.error("standings error", e);
      el("#standingsBody").innerHTML = `<div class=muted>Unable to compute standings (${e.message}).</div>`;
    }
  }

  function renderStandingsTable(rows, totalGames){
    if (!rows.length){ el("#standingsBody").innerHTML = `<div class=muted>No data yet.</div>`; return; }
    const pct = (w, t) => t? (w/t*100).toFixed(1)+"%" : "—";
    const html = [
      `<table><thead><tr><th>Rank</th><th>User</th><th>Wins</th><th>Played</th><th>Win %</th></tr></thead><tbody>`,
      ...rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.email}</td><td>${r.wins}</td><td>${r.played}/${totalGames}</td><td>${pct(r.wins, r.played)}</td></tr>`),
      `</tbody></table>`
    ].join("");
    el("#standingsBody").innerHTML = html;
  }

  async function publishWeekStandings(){
    if (!state.isAdmin) return;
    // Save a compact leaderboard doc per user so we can sum for overall later
    const gamesSnap = await getDocs(collection(db, "weeks", state.weekId, "games"));
    const winners = {}; gamesSnap.forEach(d => { const g=d.data(); if (g.winner) winners[d.id]=g.winner; });

    const cg = await getDocs(collectionGroup(db, "weeks"));
    const batch = [];
    for (const docSnap of cg.docs){
      const data = docSnap.data(); if (data.weekId !== state.weekId) continue;
      const picks = data.picks || {}; const email = data.email || docSnap.ref.path.split("/")[1];
      let wins=0; for (const [gid,side] of Object.entries(picks)){ if (winners[gid] && winners[gid]===side) wins++; }
      const uid = docSnap.ref.path.split("/")[1];
      const ref = doc(db, "leaderboards", "weeks", state.weekId, "scores", uid);
      batch.push(setDoc(ref, { email, wins, weekId: state.weekId, updatedAt: Date.now() }, { merge:true }));
    }
    await Promise.all(batch);
    toast("Week standings published");
  }

  // --- Expose helpers for console ---
  window.appState = state;
  window.fx = { seedWeek1, clearGames, addDoc, collection, setWinner, computeWeekStandings, publishWeekStandings };
  window.showUID = () => console.log("Your UID:", auth.currentUser?.uid);

</script>
</body>
</html>
